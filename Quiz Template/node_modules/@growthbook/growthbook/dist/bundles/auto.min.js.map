{"version":3,"file":"auto.min.js","sources":["../../../../node_modules/js-cookie/dist/js.cookie.mjs","../../../../node_modules/dom-mutator/dist/dom-mutator.esm.js","../../src/util.ts","../../src/feature-repository.ts","../../src/mongrule.ts","../../src/core.ts","../../src/GrowthBook.ts","../../src/sticky-bucket-service.ts","../../src/plugins/auto-attributes.ts","../../src/plugins/growthbook-tracking.ts","../../src/auto-wrapper.ts","../../src/plugins/third-party-tracking.ts"],"sourcesContent":["/*! js-cookie v3.0.5 | MIT */\n/* eslint-disable no-var */\nfunction assign (target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i];\n    for (var key in source) {\n      target[key] = source[key];\n    }\n  }\n  return target\n}\n/* eslint-enable no-var */\n\n/* eslint-disable no-var */\nvar defaultConverter = {\n  read: function (value) {\n    if (value[0] === '\"') {\n      value = value.slice(1, -1);\n    }\n    return value.replace(/(%[\\dA-F]{2})+/gi, decodeURIComponent)\n  },\n  write: function (value) {\n    return encodeURIComponent(value).replace(\n      /%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,\n      decodeURIComponent\n    )\n  }\n};\n/* eslint-enable no-var */\n\n/* eslint-disable no-var */\n\nfunction init (converter, defaultAttributes) {\n  function set (name, value, attributes) {\n    if (typeof document === 'undefined') {\n      return\n    }\n\n    attributes = assign({}, defaultAttributes, attributes);\n\n    if (typeof attributes.expires === 'number') {\n      attributes.expires = new Date(Date.now() + attributes.expires * 864e5);\n    }\n    if (attributes.expires) {\n      attributes.expires = attributes.expires.toUTCString();\n    }\n\n    name = encodeURIComponent(name)\n      .replace(/%(2[346B]|5E|60|7C)/g, decodeURIComponent)\n      .replace(/[()]/g, escape);\n\n    var stringifiedAttributes = '';\n    for (var attributeName in attributes) {\n      if (!attributes[attributeName]) {\n        continue\n      }\n\n      stringifiedAttributes += '; ' + attributeName;\n\n      if (attributes[attributeName] === true) {\n        continue\n      }\n\n      // Considers RFC 6265 section 5.2:\n      // ...\n      // 3.  If the remaining unparsed-attributes contains a %x3B (\";\")\n      //     character:\n      // Consume the characters of the unparsed-attributes up to,\n      // not including, the first %x3B (\";\") character.\n      // ...\n      stringifiedAttributes += '=' + attributes[attributeName].split(';')[0];\n    }\n\n    return (document.cookie =\n      name + '=' + converter.write(value, name) + stringifiedAttributes)\n  }\n\n  function get (name) {\n    if (typeof document === 'undefined' || (arguments.length && !name)) {\n      return\n    }\n\n    // To prevent the for loop in the first place assign an empty array\n    // in case there are no cookies at all.\n    var cookies = document.cookie ? document.cookie.split('; ') : [];\n    var jar = {};\n    for (var i = 0; i < cookies.length; i++) {\n      var parts = cookies[i].split('=');\n      var value = parts.slice(1).join('=');\n\n      try {\n        var found = decodeURIComponent(parts[0]);\n        jar[found] = converter.read(value, found);\n\n        if (name === found) {\n          break\n        }\n      } catch (e) {}\n    }\n\n    return name ? jar[name] : jar\n  }\n\n  return Object.create(\n    {\n      set,\n      get,\n      remove: function (name, attributes) {\n        set(\n          name,\n          '',\n          assign({}, attributes, {\n            expires: -1\n          })\n        );\n      },\n      withAttributes: function (attributes) {\n        return init(this.converter, assign({}, this.attributes, attributes))\n      },\n      withConverter: function (converter) {\n        return init(assign({}, this.converter, converter), this.attributes)\n      }\n    },\n    {\n      attributes: { value: Object.freeze(defaultAttributes) },\n      converter: { value: Object.freeze(converter) }\n    }\n  )\n}\n\nvar api = init(defaultConverter, { path: '/' });\n/* eslint-enable no-var */\n\nexport { api as default };\n","var validAttributeName = /^[a-zA-Z:_][a-zA-Z0-9:_.-]*$/;\nvar nullController = {\n  revert: function revert() {}\n};\nvar elements = /*#__PURE__*/new Map();\nvar mutations = /*#__PURE__*/new Set();\n\nfunction getObserverInit(attr) {\n  return attr === 'html' ? {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    characterData: true\n  } : {\n    childList: false,\n    subtree: false,\n    attributes: true,\n    attributeFilter: [attr]\n  };\n}\n\nfunction getElementRecord(element) {\n  var record = elements.get(element);\n\n  if (!record) {\n    record = {\n      element: element,\n      attributes: {}\n    };\n    elements.set(element, record);\n  }\n\n  return record;\n}\n\nfunction createElementPropertyRecord(el, attr, getCurrentValue, setValue, mutationRunner) {\n  var currentValue = getCurrentValue(el);\n  var record = {\n    isDirty: false,\n    originalValue: currentValue,\n    virtualValue: currentValue,\n    mutations: [],\n    el: el,\n    _positionTimeout: null,\n    observer: new MutationObserver(function () {\n      // enact a 1 second timeout that blocks subsequent firing of the\n      // observer until the timeout is complete. This will prevent multiple\n      // mutations from firing in quick succession, which can cause the\n      // mutation to be reverted before the DOM has a chance to update.\n      if (attr === 'position' && record._positionTimeout) return;else if (attr === 'position') record._positionTimeout = setTimeout(function () {\n        record._positionTimeout = null;\n      }, 1000);\n      var currentValue = getCurrentValue(el);\n      if (attr === 'position' && currentValue.parentNode === record.virtualValue.parentNode && currentValue.insertBeforeNode === record.virtualValue.insertBeforeNode) return;\n      if (currentValue === record.virtualValue) return;\n      record.originalValue = currentValue;\n      mutationRunner(record);\n    }),\n    mutationRunner: mutationRunner,\n    setValue: setValue,\n    getCurrentValue: getCurrentValue\n  };\n\n  if (attr === 'position' && el.parentNode) {\n    record.observer.observe(el.parentNode, {\n      childList: true,\n      subtree: true,\n      attributes: false,\n      characterData: false\n    });\n  } else {\n    record.observer.observe(el, getObserverInit(attr));\n  }\n\n  return record;\n}\n\nfunction queueIfNeeded(val, record) {\n  var currentVal = record.getCurrentValue(record.el);\n  record.virtualValue = val;\n\n  if (val && typeof val !== 'string') {\n    if (!currentVal || val.parentNode !== currentVal.parentNode || val.insertBeforeNode !== currentVal.insertBeforeNode) {\n      record.isDirty = true;\n      runDOMUpdates();\n    }\n  } else if (val !== currentVal) {\n    record.isDirty = true;\n    runDOMUpdates();\n  }\n}\n\nfunction htmlMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    return val = m.mutate(val);\n  });\n  queueIfNeeded(getTransformedHTML(val), record);\n}\n\nfunction classMutationRunner(record) {\n  var val = new Set(record.originalValue.split(/\\s+/).filter(Boolean));\n  record.mutations.forEach(function (m) {\n    return m.mutate(val);\n  });\n  queueIfNeeded(Array.from(val).filter(Boolean).join(' '), record);\n}\n\nfunction attrMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    return val = m.mutate(val);\n  });\n  queueIfNeeded(val, record);\n}\n\nfunction _loadDOMNodes(_ref) {\n  var parentSelector = _ref.parentSelector,\n      insertBeforeSelector = _ref.insertBeforeSelector;\n  var parentNode = document.querySelector(parentSelector);\n  if (!parentNode) return null;\n  var insertBeforeNode = insertBeforeSelector ? document.querySelector(insertBeforeSelector) : null;\n  if (insertBeforeSelector && !insertBeforeNode) return null;\n  return {\n    parentNode: parentNode,\n    insertBeforeNode: insertBeforeNode\n  };\n}\n\nfunction positionMutationRunner(record) {\n  var val = record.originalValue;\n  record.mutations.forEach(function (m) {\n    var selectors = m.mutate();\n\n    var newNodes = _loadDOMNodes(selectors);\n\n    val = newNodes || val;\n  });\n  queueIfNeeded(val, record);\n}\n\nvar getHTMLValue = function getHTMLValue(el) {\n  return el.innerHTML;\n};\n\nvar setHTMLValue = function setHTMLValue(el, value) {\n  return el.innerHTML = value;\n};\n\nfunction getElementHTMLRecord(element) {\n  var elementRecord = getElementRecord(element);\n\n  if (!elementRecord.html) {\n    elementRecord.html = createElementPropertyRecord(element, 'html', getHTMLValue, setHTMLValue, htmlMutationRunner);\n  }\n\n  return elementRecord.html;\n}\n\nvar getElementPosition = function getElementPosition(el) {\n  return {\n    parentNode: el.parentElement,\n    insertBeforeNode: el.nextElementSibling\n  };\n};\n\nvar setElementPosition = function setElementPosition(el, value) {\n  if (value.insertBeforeNode && !value.parentNode.contains(value.insertBeforeNode)) {\n    // skip position mutation - insertBeforeNode not a child of parent. happens\n    // when mutation observer for indvidual element fires out of order\n    return;\n  }\n\n  value.parentNode.insertBefore(el, value.insertBeforeNode);\n};\n\nfunction getElementPositionRecord(element) {\n  var elementRecord = getElementRecord(element);\n\n  if (!elementRecord.position) {\n    elementRecord.position = createElementPropertyRecord(element, 'position', getElementPosition, setElementPosition, positionMutationRunner);\n  }\n\n  return elementRecord.position;\n}\n\nvar setClassValue = function setClassValue(el, val) {\n  return val ? el.className = val : el.removeAttribute('class');\n};\n\nvar getClassValue = function getClassValue(el) {\n  return el.className;\n};\n\nfunction getElementClassRecord(el) {\n  var elementRecord = getElementRecord(el);\n\n  if (!elementRecord.classes) {\n    elementRecord.classes = createElementPropertyRecord(el, 'class', getClassValue, setClassValue, classMutationRunner);\n  }\n\n  return elementRecord.classes;\n}\n\nvar getAttrValue = function getAttrValue(attrName) {\n  return function (el) {\n    var _el$getAttribute;\n\n    return (_el$getAttribute = el.getAttribute(attrName)) != null ? _el$getAttribute : null;\n  };\n};\n\nvar setAttrValue = function setAttrValue(attrName) {\n  return function (el, val) {\n    return val !== null ? el.setAttribute(attrName, val) : el.removeAttribute(attrName);\n  };\n};\n\nfunction getElementAttributeRecord(el, attr) {\n  var elementRecord = getElementRecord(el);\n\n  if (!elementRecord.attributes[attr]) {\n    elementRecord.attributes[attr] = createElementPropertyRecord(el, attr, getAttrValue(attr), setAttrValue(attr), attrMutationRunner);\n  }\n\n  return elementRecord.attributes[attr];\n}\n\nfunction deleteElementPropertyRecord(el, attr) {\n  var element = elements.get(el);\n  if (!element) return;\n\n  if (attr === 'html') {\n    var _element$html, _element$html$observe;\n\n    (_element$html = element.html) == null ? void 0 : (_element$html$observe = _element$html.observer) == null ? void 0 : _element$html$observe.disconnect();\n    delete element.html;\n  } else if (attr === 'class') {\n    var _element$classes, _element$classes$obse;\n\n    (_element$classes = element.classes) == null ? void 0 : (_element$classes$obse = _element$classes.observer) == null ? void 0 : _element$classes$obse.disconnect();\n    delete element.classes;\n  } else if (attr === 'position') {\n    var _element$position, _element$position$obs;\n\n    (_element$position = element.position) == null ? void 0 : (_element$position$obs = _element$position.observer) == null ? void 0 : _element$position$obs.disconnect();\n    delete element.position;\n  } else {\n    var _element$attributes, _element$attributes$a, _element$attributes$a2;\n\n    (_element$attributes = element.attributes) == null ? void 0 : (_element$attributes$a = _element$attributes[attr]) == null ? void 0 : (_element$attributes$a2 = _element$attributes$a.observer) == null ? void 0 : _element$attributes$a2.disconnect();\n    delete element.attributes[attr];\n  }\n}\n\nvar transformContainer;\n\nfunction getTransformedHTML(html) {\n  if (!transformContainer) {\n    transformContainer = document.createElement('div');\n  }\n\n  transformContainer.innerHTML = html;\n  return transformContainer.innerHTML;\n}\n\nfunction setPropertyValue(el, attr, m) {\n  if (!m.isDirty) return;\n  m.isDirty = false;\n  var val = m.virtualValue;\n\n  if (!m.mutations.length) {\n    deleteElementPropertyRecord(el, attr);\n  }\n\n  m.setValue(el, val);\n}\n\nfunction setValue(m, el) {\n  m.html && setPropertyValue(el, 'html', m.html);\n  m.classes && setPropertyValue(el, 'class', m.classes);\n  m.position && setPropertyValue(el, 'position', m.position);\n  Object.keys(m.attributes).forEach(function (attr) {\n    setPropertyValue(el, attr, m.attributes[attr]);\n  });\n}\n\nfunction runDOMUpdates() {\n  elements.forEach(setValue);\n} // find or create ElementPropertyRecord, add mutation to it, then run\n\n\nfunction startMutating(mutation, element) {\n  var record = null;\n\n  if (mutation.kind === 'html') {\n    record = getElementHTMLRecord(element);\n  } else if (mutation.kind === 'class') {\n    record = getElementClassRecord(element);\n  } else if (mutation.kind === 'attribute') {\n    record = getElementAttributeRecord(element, mutation.attribute);\n  } else if (mutation.kind === 'position') {\n    record = getElementPositionRecord(element);\n  }\n\n  if (!record) return;\n  record.mutations.push(mutation);\n  record.mutationRunner(record);\n} // get (existing) ElementPropertyRecord, remove mutation from it, then run\n\n\nfunction stopMutating(mutation, el) {\n  var record = null;\n\n  if (mutation.kind === 'html') {\n    record = getElementHTMLRecord(el);\n  } else if (mutation.kind === 'class') {\n    record = getElementClassRecord(el);\n  } else if (mutation.kind === 'attribute') {\n    record = getElementAttributeRecord(el, mutation.attribute);\n  } else if (mutation.kind === 'position') {\n    record = getElementPositionRecord(el);\n  }\n\n  if (!record) return;\n  var index = record.mutations.indexOf(mutation);\n  if (index !== -1) record.mutations.splice(index, 1);\n  record.mutationRunner(record);\n} // maintain list of elements associated with mutation\n\n\nfunction refreshElementsSet(mutation) {\n  // if a position mutation has already found an element to move, don't move\n  // any more elements\n  if (mutation.kind === 'position' && mutation.elements.size === 1) return;\n  var existingElements = new Set(mutation.elements);\n  var matchingElements = document.querySelectorAll(mutation.selector);\n  matchingElements.forEach(function (el) {\n    if (!existingElements.has(el)) {\n      mutation.elements.add(el);\n      startMutating(mutation, el);\n    }\n  });\n}\n\nfunction revertMutation(mutation) {\n  mutation.elements.forEach(function (el) {\n    return stopMutating(mutation, el);\n  });\n  mutation.elements.clear();\n  mutations[\"delete\"](mutation);\n}\n\nfunction refreshAllElementSets() {\n  mutations.forEach(refreshElementsSet);\n} // Observer for elements that don't exist in the DOM yet\n\n\nvar observer;\nfunction disconnectGlobalObserver() {\n  observer && observer.disconnect();\n}\nfunction connectGlobalObserver() {\n  if (typeof document === 'undefined') return;\n\n  if (!observer) {\n    observer = new MutationObserver(function () {\n      refreshAllElementSets();\n    });\n  }\n\n  refreshAllElementSets();\n  observer.observe(document.documentElement, {\n    childList: true,\n    subtree: true,\n    attributes: false,\n    characterData: false\n  });\n} // run on init\n\nconnectGlobalObserver();\n\nfunction newMutation(m) {\n  // Not in a browser\n  if (typeof document === 'undefined') return nullController; // add to global index of mutations\n\n  mutations.add(m); // run refresh on init to establish list of elements associated w/ mutation\n\n  refreshElementsSet(m);\n  return {\n    revert: function revert() {\n      revertMutation(m);\n    }\n  };\n}\n\nfunction html(selector, mutate) {\n  return newMutation({\n    kind: 'html',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction position(selector, mutate) {\n  return newMutation({\n    kind: 'position',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction classes(selector, mutate) {\n  return newMutation({\n    kind: 'class',\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction attribute(selector, attribute, mutate) {\n  if (!validAttributeName.test(attribute)) return nullController;\n\n  if (attribute === 'class' || attribute === 'className') {\n    return classes(selector, function (classnames) {\n      var mutatedClassnames = mutate(Array.from(classnames).join(' '));\n      classnames.clear();\n      if (!mutatedClassnames) return;\n      mutatedClassnames.split(/\\s+/g).filter(Boolean).forEach(function (c) {\n        return classnames.add(c);\n      });\n    });\n  }\n\n  return newMutation({\n    kind: 'attribute',\n    attribute: attribute,\n    elements: new Set(),\n    mutate: mutate,\n    selector: selector\n  });\n}\n\nfunction declarative(_ref2) {\n  var selector = _ref2.selector,\n      action = _ref2.action,\n      value = _ref2.value,\n      attr = _ref2.attribute,\n      parentSelector = _ref2.parentSelector,\n      insertBeforeSelector = _ref2.insertBeforeSelector;\n\n  if (attr === 'html') {\n    if (action === 'append') {\n      return html(selector, function (val) {\n        return val + (value != null ? value : '');\n      });\n    } else if (action === 'set') {\n      return html(selector, function () {\n        return value != null ? value : '';\n      });\n    }\n  } else if (attr === 'class') {\n    if (action === 'append') {\n      return classes(selector, function (val) {\n        if (value) val.add(value);\n      });\n    } else if (action === 'remove') {\n      return classes(selector, function (val) {\n        if (value) val[\"delete\"](value);\n      });\n    } else if (action === 'set') {\n      return classes(selector, function (val) {\n        val.clear();\n        if (value) val.add(value);\n      });\n    }\n  } else if (attr === 'position') {\n    if (action === 'set' && parentSelector) {\n      return position(selector, function () {\n        return {\n          insertBeforeSelector: insertBeforeSelector,\n          parentSelector: parentSelector\n        };\n      });\n    }\n  } else {\n    if (action === 'append') {\n      return attribute(selector, attr, function (val) {\n        return val !== null ? val + (value != null ? value : '') : value != null ? value : '';\n      });\n    } else if (action === 'set') {\n      return attribute(selector, attr, function () {\n        return value != null ? value : '';\n      });\n    } else if (action === 'remove') {\n      return attribute(selector, attr, function () {\n        return null;\n      });\n    }\n  }\n\n  return nullController;\n}\n\nvar index = {\n  html: html,\n  classes: classes,\n  attribute: attribute,\n  position: position,\n  declarative: declarative\n};\n\nexport default index;\nexport { connectGlobalObserver, disconnectGlobalObserver, validAttributeName };\n//# sourceMappingURL=dom-mutator.esm.js.map\n","import {\n  AutoExperiment,\n  AutoExperimentChangeType,\n  Polyfills,\n  UrlTarget,\n  UrlTargetType,\n  VariationRange,\n} from \"./types/growthbook\";\n\nconst polyfills: Polyfills = {\n  fetch: globalThis.fetch ? globalThis.fetch.bind(globalThis) : undefined,\n  SubtleCrypto: globalThis.crypto ? globalThis.crypto.subtle : undefined,\n  EventSource: globalThis.EventSource,\n};\nexport function getPolyfills(): Polyfills {\n  return polyfills;\n}\n\nfunction hashFnv32a(str: string): number {\n  let hval = 0x811c9dc5;\n  const l = str.length;\n\n  for (let i = 0; i < l; i++) {\n    hval ^= str.charCodeAt(i);\n    hval +=\n      (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);\n  }\n  return hval >>> 0;\n}\n\nexport function hash(\n  seed: string,\n  value: string,\n  version: number\n): number | null {\n  // New unbiased hashing algorithm\n  if (version === 2) {\n    return (hashFnv32a(hashFnv32a(seed + value) + \"\") % 10000) / 10000;\n  }\n  // Original biased hashing algorithm (keep for backwards compatibility)\n  if (version === 1) {\n    return (hashFnv32a(value + seed) % 1000) / 1000;\n  }\n\n  // Unknown hash version\n  return null;\n}\n\nexport function getEqualWeights(n: number): number[] {\n  if (n <= 0) return [];\n  return new Array(n).fill(1 / n);\n}\n\nexport function inRange(n: number, range: VariationRange): boolean {\n  return n >= range[0] && n < range[1];\n}\n\nexport function inNamespace(\n  hashValue: string,\n  namespace: [string, number, number]\n): boolean {\n  const n = hash(\"__\" + namespace[0], hashValue, 1);\n  if (n === null) return false;\n  return n >= namespace[1] && n < namespace[2];\n}\n\nexport function chooseVariation(n: number, ranges: VariationRange[]): number {\n  for (let i = 0; i < ranges.length; i++) {\n    if (inRange(n, ranges[i])) {\n      return i;\n    }\n  }\n  return -1;\n}\n\nexport function getUrlRegExp(regexString: string): RegExp | undefined {\n  try {\n    const escaped = regexString.replace(/([^\\\\])\\//g, \"$1\\\\/\");\n    return new RegExp(escaped);\n  } catch (e) {\n    console.error(e);\n    return undefined;\n  }\n}\n\nexport function isURLTargeted(url: string, targets: UrlTarget[]) {\n  if (!targets.length) return false;\n  let hasIncludeRules = false;\n  let isIncluded = false;\n\n  for (let i = 0; i < targets.length; i++) {\n    const match = _evalURLTarget(url, targets[i].type, targets[i].pattern);\n    if (targets[i].include === false) {\n      if (match) return false;\n    } else {\n      hasIncludeRules = true;\n      if (match) isIncluded = true;\n    }\n  }\n\n  return isIncluded || !hasIncludeRules;\n}\n\nfunction _evalSimpleUrlPart(\n  actual: string,\n  pattern: string,\n  isPath: boolean\n): boolean {\n  try {\n    // Escape special regex characters and change wildcard `_____` to `.*`\n    let escaped = pattern\n      .replace(/[*.+?^${}()|[\\]\\\\]/g, \"\\\\$&\")\n      .replace(/_____/g, \".*\");\n\n    if (isPath) {\n      // When matching pathname, make leading/trailing slashes optional\n      escaped = \"\\\\/?\" + escaped.replace(/(^\\/|\\/$)/g, \"\") + \"\\\\/?\";\n    }\n\n    const regex = new RegExp(\"^\" + escaped + \"$\", \"i\");\n    return regex.test(actual);\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _evalSimpleUrlTarget(actual: URL, pattern: string) {\n  try {\n    // If a protocol is missing, but a host is specified, add `https://` to the front\n    // Use \"_____\" as the wildcard since `*` is not a valid hostname in some browsers\n    const expected = new URL(\n      pattern.replace(/^([^:/?]*)\\./i, \"https://$1.\").replace(/\\*/g, \"_____\"),\n      \"https://_____\"\n    );\n\n    // Compare each part of the URL separately\n    const comps: Array<[string, string, boolean]> = [\n      [actual.host, expected.host, false],\n      [actual.pathname, expected.pathname, true],\n    ];\n    // We only want to compare hashes if it's explicitly being targeted\n    if (expected.hash) {\n      comps.push([actual.hash, expected.hash, false]);\n    }\n\n    expected.searchParams.forEach((v, k) => {\n      comps.push([actual.searchParams.get(k) || \"\", v, false]);\n    });\n\n    // If any comparisons fail, the whole thing fails\n    return !comps.some(\n      (data) => !_evalSimpleUrlPart(data[0], data[1], data[2])\n    );\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _evalURLTarget(\n  url: string,\n  type: UrlTargetType,\n  pattern: string\n): boolean {\n  try {\n    const parsed = new URL(url, \"https://_\");\n\n    if (type === \"regex\") {\n      const regex = getUrlRegExp(pattern);\n      if (!regex) return false;\n      return (\n        regex.test(parsed.href) ||\n        regex.test(parsed.href.substring(parsed.origin.length))\n      );\n    } else if (type === \"simple\") {\n      return _evalSimpleUrlTarget(parsed, pattern);\n    }\n\n    return false;\n  } catch (e) {\n    return false;\n  }\n}\n\nexport function getBucketRanges(\n  numVariations: number,\n  coverage: number | undefined,\n  weights?: number[]\n): VariationRange[] {\n  coverage = coverage === undefined ? 1 : coverage;\n\n  // Make sure coverage is within bounds\n  if (coverage < 0) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be greater than or equal to 0\");\n    }\n    coverage = 0;\n  } else if (coverage > 1) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.coverage must be less than or equal to 1\");\n    }\n    coverage = 1;\n  }\n\n  // Default to equal weights if missing or invalid\n  const equal = getEqualWeights(numVariations);\n  weights = weights || equal;\n  if (weights.length !== numVariations) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\n        \"Experiment.weights array must be the same length as Experiment.variations\"\n      );\n    }\n    weights = equal;\n  }\n\n  // If weights don't add up to 1 (or close to it), default to equal weights\n  const totalWeight = weights.reduce((w, sum) => sum + w, 0);\n  if (totalWeight < 0.99 || totalWeight > 1.01) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.error(\"Experiment.weights must add up to 1\");\n    }\n    weights = equal;\n  }\n\n  // Covert weights to ranges\n  let cumulative = 0;\n  return weights.map((w) => {\n    const start = cumulative;\n    cumulative += w;\n    return [start, start + (coverage as number) * w];\n  }) as VariationRange[];\n}\n\nexport function getQueryStringOverride(\n  id: string,\n  url: string,\n  numVariations: number\n) {\n  if (!url) {\n    return null;\n  }\n\n  const search = url.split(\"?\")[1];\n  if (!search) {\n    return null;\n  }\n\n  const match = search\n    .replace(/#.*/, \"\") // Get rid of anchor\n    .split(\"&\") // Split into key/value pairs\n    .map((kv) => kv.split(\"=\", 2))\n    .filter(([k]) => k === id) // Look for key that matches the experiment id\n    .map(([, v]) => parseInt(v)); // Parse the value into an integer\n\n  if (match.length > 0 && match[0] >= 0 && match[0] < numVariations)\n    return match[0];\n\n  return null;\n}\n\nexport function isIncluded(include: () => boolean) {\n  try {\n    return include();\n  } catch (e) {\n    console.error(e);\n    return false;\n  }\n}\n\nconst base64ToBuf = (b: string) =>\n  Uint8Array.from(atob(b), (c) => c.charCodeAt(0));\n\nexport async function decrypt(\n  encryptedString: string,\n  decryptionKey?: string,\n  subtle?: SubtleCrypto\n): Promise<string> {\n  decryptionKey = decryptionKey || \"\";\n  subtle =\n    subtle ||\n    (globalThis.crypto && globalThis.crypto.subtle) ||\n    polyfills.SubtleCrypto;\n  if (!subtle) {\n    throw new Error(\"No SubtleCrypto implementation found\");\n  }\n  try {\n    const key = await subtle.importKey(\n      \"raw\",\n      base64ToBuf(decryptionKey),\n      { name: \"AES-CBC\", length: 128 },\n      true,\n      [\"encrypt\", \"decrypt\"]\n    );\n    const [iv, cipherText] = encryptedString.split(\".\");\n    const plainTextBuffer = await subtle.decrypt(\n      { name: \"AES-CBC\", iv: base64ToBuf(iv) },\n      key,\n      base64ToBuf(cipherText)\n    );\n\n    return new TextDecoder().decode(plainTextBuffer);\n  } catch (e) {\n    throw new Error(\"Failed to decrypt\");\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function toString(input: any): string {\n  if (typeof input === \"string\") return input;\n  return JSON.stringify(input);\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function paddedVersionString(input: any): string {\n  if (typeof input === \"number\") {\n    input = input + \"\";\n  }\n  if (!input || typeof input !== \"string\") {\n    input = \"0\";\n  }\n  // Remove build info and leading `v` if any\n  // Split version into parts (both core version numbers and pre-release tags)\n  // \"v1.2.3-rc.1+build123\" -> [\"1\",\"2\",\"3\",\"rc\",\"1\"]\n  const parts = (input as string).replace(/(^v|\\+.*$)/g, \"\").split(/[-.]/);\n\n  // If it's SemVer without a pre-release, add `~` to the end\n  // [\"1\",\"0\",\"0\"] -> [\"1\",\"0\",\"0\",\"~\"]\n  // \"~\" is the largest ASCII character, so this will make \"1.0.0\" greater than \"1.0.0-beta\" for example\n  if (parts.length === 3) {\n    parts.push(\"~\");\n  }\n\n  // Left pad each numeric part with spaces so string comparisons will work (\"9\">\"10\", but \" 9\"<\"10\")\n  // Then, join back together into a single string\n  return parts\n    .map((v) => (v.match(/^[0-9]+$/) ? v.padStart(5, \" \") : v))\n    .join(\"-\");\n}\n\nexport function loadSDKVersion(): string {\n  let version: string;\n  try {\n    // @ts-expect-error right-hand value to be replaced by build with string literal\n    version = __SDK_VERSION__;\n  } catch (e) {\n    version = \"\";\n  }\n  return version;\n}\n\nexport function mergeQueryStrings(oldUrl: string, newUrl: string): string {\n  let currUrl: URL;\n  let redirectUrl: URL;\n  try {\n    currUrl = new URL(oldUrl);\n    redirectUrl = new URL(newUrl);\n  } catch (e) {\n    console.error(`Unable to merge query strings: ${e}`);\n    return newUrl;\n  }\n\n  currUrl.searchParams.forEach((value, key) => {\n    // skip  if search param already exists in redirectUrl\n    if (redirectUrl.searchParams.has(key)) {\n      return;\n    }\n    redirectUrl.searchParams.set(key, value);\n  });\n\n  return redirectUrl.toString();\n}\n\nfunction isObj(x: unknown): x is Record<string, unknown> {\n  return typeof x === \"object\" && x !== null;\n}\n\nexport function getAutoExperimentChangeType(\n  exp: AutoExperiment\n): AutoExperimentChangeType {\n  if (\n    exp.urlPatterns &&\n    exp.variations.some(\n      (variation) => isObj(variation) && \"urlRedirect\" in variation\n    )\n  ) {\n    return \"redirect\";\n  } else if (\n    exp.variations.some(\n      (variation) =>\n        isObj(variation) &&\n        (variation.domMutations || \"js\" in variation || \"css\" in variation)\n    )\n  ) {\n    return \"visual\";\n  }\n\n  return \"unknown\";\n}\n\n// Guarantee the promise always resolves within {timeout} ms\n// Resolved value will be `null` when there's an error or it takes too long\n// Note: The promise will continue running in the background, even if the timeout is hit\nexport async function promiseTimeout<T>(\n  promise: Promise<T>,\n  timeout?: number\n): Promise<T | null> {\n  return new Promise((resolve) => {\n    let resolved = false;\n    let timer: NodeJS.Timeout | undefined;\n    const finish = (data?: T) => {\n      if (resolved) return;\n      resolved = true;\n      timer && clearTimeout(timer);\n      resolve(data || null);\n    };\n\n    if (timeout) {\n      timer = setTimeout(() => finish(), timeout);\n    }\n\n    promise.then((data) => finish(data)).catch(() => finish());\n  });\n}\n","import {\n  Attributes,\n  CacheSettings,\n  FeatureApiResponse,\n  FetchResponse,\n  Helpers,\n  Polyfills,\n} from \"./types/growthbook\";\nimport { getPolyfills, promiseTimeout } from \"./util\";\nimport type {\n  GrowthBook,\n  InitOptions,\n  InitSyncOptions,\n  GrowthBookClient,\n} from \".\";\n\ntype CacheEntry = {\n  data: FeatureApiResponse;\n  sse?: boolean;\n  version: string;\n  staleAt: Date;\n};\ntype ScopedChannel = {\n  src: EventSource | null;\n  cb: (event: MessageEvent<string>) => void;\n  host: string;\n  clientKey: string;\n  headers?: Record<string, string>;\n  errors: number;\n  state: \"active\" | \"idle\" | \"disabled\";\n};\n\n// Config settings\nconst cacheSettings: CacheSettings = {\n  // Consider a fetch stale after 1 minute\n  staleTTL: 1000 * 60,\n  // Max time to keep a fetch in cache (4 hours default)\n  maxAge: 1000 * 60 * 60 * 4,\n  cacheKey: \"gbFeaturesCache\",\n  backgroundSync: true,\n  maxEntries: 10,\n  disableIdleStreams: false,\n  idleStreamInterval: 20000,\n  disableCache: false,\n};\n\nconst polyfills = getPolyfills();\n\nexport const helpers: Helpers = {\n  fetchFeaturesCall: ({ host, clientKey, headers }) => {\n    return (polyfills.fetch as typeof globalThis.fetch)(\n      `${host}/api/features/${clientKey}`,\n      { headers }\n    );\n  },\n  fetchRemoteEvalCall: ({ host, clientKey, payload, headers }) => {\n    const options = {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\", ...headers },\n      body: JSON.stringify(payload),\n    };\n    return (polyfills.fetch as typeof globalThis.fetch)(\n      `${host}/api/eval/${clientKey}`,\n      options\n    );\n  },\n  eventSourceCall: ({ host, clientKey, headers }) => {\n    if (headers) {\n      return new polyfills.EventSource(`${host}/sub/${clientKey}`, {\n        headers,\n      });\n    }\n    return new polyfills.EventSource(`${host}/sub/${clientKey}`);\n  },\n  startIdleListener: () => {\n    let idleTimeout: number | undefined;\n    const isBrowser =\n      typeof window !== \"undefined\" && typeof document !== \"undefined\";\n    if (!isBrowser) return;\n    const onVisibilityChange = () => {\n      if (document.visibilityState === \"visible\") {\n        window.clearTimeout(idleTimeout);\n        onVisible();\n      } else if (document.visibilityState === \"hidden\") {\n        idleTimeout = window.setTimeout(\n          onHidden,\n          cacheSettings.idleStreamInterval\n        );\n      }\n    };\n    document.addEventListener(\"visibilitychange\", onVisibilityChange);\n    return () =>\n      document.removeEventListener(\"visibilitychange\", onVisibilityChange);\n  },\n  stopIdleListener: () => {\n    // No-op, replaced by startIdleListener\n  },\n};\n\ntry {\n  if (globalThis.localStorage) {\n    polyfills.localStorage = globalThis.localStorage;\n  }\n} catch (e) {\n  // Ignore localStorage errors\n}\n\n// Global state\nconst subscribedInstances: Map<\n  string,\n  Set<GrowthBook | GrowthBookClient>\n> = new Map();\nlet cacheInitialized = false;\nconst cache: Map<string, CacheEntry> = new Map();\nconst activeFetches: Map<string, Promise<FetchResponse>> = new Map();\nconst streams: Map<string, ScopedChannel> = new Map();\nconst supportsSSE: Set<string> = new Set();\n\n// Public functions\nexport function setPolyfills(overrides: Partial<Polyfills>): void {\n  Object.assign(polyfills, overrides);\n}\nexport function configureCache(overrides: Partial<CacheSettings>): void {\n  Object.assign(cacheSettings, overrides);\n  if (!cacheSettings.backgroundSync) {\n    clearAutoRefresh();\n  }\n}\n\nexport async function clearCache(): Promise<void> {\n  cache.clear();\n  activeFetches.clear();\n  clearAutoRefresh();\n  cacheInitialized = false;\n  await updatePersistentCache();\n}\n\n// Get or fetch features and refresh the SDK instance\nexport async function refreshFeatures({\n  instance,\n  timeout,\n  skipCache,\n  allowStale,\n  backgroundSync,\n}: {\n  instance: GrowthBook | GrowthBookClient;\n  timeout?: number;\n  skipCache?: boolean;\n  allowStale?: boolean;\n  backgroundSync?: boolean;\n}): Promise<FetchResponse> {\n  if (!backgroundSync) {\n    cacheSettings.backgroundSync = false;\n  }\n\n  return fetchFeaturesWithCache({\n    instance,\n    allowStale,\n    timeout,\n    skipCache,\n  });\n}\n\n// Subscribe a GrowthBook instance to feature changes\nfunction subscribe(instance: GrowthBook | GrowthBookClient): void {\n  const key = getKey(instance);\n  const subs = subscribedInstances.get(key) || new Set();\n  subs.add(instance);\n  subscribedInstances.set(key, subs);\n}\nexport function unsubscribe(instance: GrowthBook | GrowthBookClient): void {\n  subscribedInstances.forEach((s) => s.delete(instance));\n}\n\nexport function onHidden() {\n  streams.forEach((channel) => {\n    if (!channel) return;\n    channel.state = \"idle\";\n    disableChannel(channel);\n  });\n}\n\nexport function onVisible() {\n  streams.forEach((channel) => {\n    if (!channel) return;\n    if (channel.state !== \"idle\") return;\n    enableChannel(channel);\n  });\n}\n\n// Private functions\n\nasync function updatePersistentCache() {\n  try {\n    if (!polyfills.localStorage) return;\n    await polyfills.localStorage.setItem(\n      cacheSettings.cacheKey,\n      JSON.stringify(Array.from(cache.entries()))\n    );\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n}\n\n// SWR wrapper for fetching features. May indirectly or directly start SSE streaming.\nasync function fetchFeaturesWithCache({\n  instance,\n  allowStale,\n  timeout,\n  skipCache,\n}: {\n  instance: GrowthBook | GrowthBookClient;\n  allowStale?: boolean;\n  timeout?: number;\n  skipCache?: boolean;\n}): Promise<FetchResponse> {\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n  const now = new Date();\n\n  const minStaleAt = new Date(\n    now.getTime() - cacheSettings.maxAge + cacheSettings.staleTTL\n  );\n\n  await initializeCache();\n  const existing =\n    !cacheSettings.disableCache && !skipCache ? cache.get(cacheKey) : undefined;\n  if (\n    existing &&\n    (allowStale || existing.staleAt > now) &&\n    existing.staleAt > minStaleAt\n  ) {\n    // Restore from cache whether SSE is supported\n    if (existing.sse) supportsSSE.add(key);\n\n    // Reload features in the background if stale\n    if (existing.staleAt < now) {\n      fetchFeatures(instance);\n    }\n    // Otherwise, if we don't need to refresh now, start a background sync\n    else {\n      startAutoRefresh(instance);\n    }\n    return { data: existing.data, success: true, source: \"cache\" };\n  } else {\n    const res = await promiseTimeout(fetchFeatures(instance), timeout);\n    return (\n      res || {\n        data: null,\n        success: false,\n        source: \"timeout\",\n        error: new Error(\"Timeout\"),\n      }\n    );\n  }\n}\n\nfunction getKey(instance: GrowthBook | GrowthBookClient): string {\n  const [apiHost, clientKey] = instance.getApiInfo();\n  return `${apiHost}||${clientKey}`;\n}\n\nfunction getCacheKey(instance: GrowthBook | GrowthBookClient): string {\n  const baseKey = getKey(instance);\n  if (!(\"isRemoteEval\" in instance) || !instance.isRemoteEval()) return baseKey;\n\n  const attributes = instance.getAttributes();\n  const cacheKeyAttributes =\n    instance.getCacheKeyAttributes() || Object.keys(instance.getAttributes());\n  const ca: Attributes = {};\n  cacheKeyAttributes.forEach((key) => {\n    ca[key] = attributes[key];\n  });\n\n  const fv = instance.getForcedVariations();\n  const url = instance.getUrl();\n\n  return `${baseKey}||${JSON.stringify({\n    ca,\n    fv,\n    url,\n  })}`;\n}\n\n// Populate cache from localStorage (if available)\nasync function initializeCache(): Promise<void> {\n  if (cacheInitialized) return;\n  cacheInitialized = true;\n  try {\n    if (polyfills.localStorage) {\n      const value = await polyfills.localStorage.getItem(\n        cacheSettings.cacheKey\n      );\n      if (!cacheSettings.disableCache && value) {\n        const parsed: [string, CacheEntry][] = JSON.parse(value);\n        if (parsed && Array.isArray(parsed)) {\n          parsed.forEach(([key, data]) => {\n            cache.set(key, {\n              ...data,\n              staleAt: new Date(data.staleAt),\n            });\n          });\n        }\n        cleanupCache();\n      }\n    }\n  } catch (e) {\n    // Ignore localStorage errors\n  }\n  if (!cacheSettings.disableIdleStreams) {\n    const cleanupFn = helpers.startIdleListener();\n    if (cleanupFn) {\n      helpers.stopIdleListener = cleanupFn;\n    }\n  }\n}\n\n// Enforce the maxEntries limit\nfunction cleanupCache() {\n  const entriesWithTimestamps = Array.from(cache.entries())\n    .map(([key, value]) => ({\n      key,\n      staleAt: value.staleAt.getTime(),\n    }))\n    .sort((a, b) => a.staleAt - b.staleAt);\n\n  const entriesToRemoveCount = Math.min(\n    Math.max(0, cache.size - cacheSettings.maxEntries),\n    cache.size\n  );\n\n  for (let i = 0; i < entriesToRemoveCount; i++) {\n    cache.delete(entriesWithTimestamps[i].key);\n  }\n}\n\n// Called whenever new features are fetched from the API\nfunction onNewFeatureData(\n  key: string,\n  cacheKey: string,\n  data: FeatureApiResponse\n): void {\n  // If contents haven't changed, ignore the update, extend the stale TTL\n  const version = data.dateUpdated || \"\";\n  const staleAt = new Date(Date.now() + cacheSettings.staleTTL);\n  const existing = !cacheSettings.disableCache\n    ? cache.get(cacheKey)\n    : undefined;\n  if (existing && version && existing.version === version) {\n    existing.staleAt = staleAt;\n    updatePersistentCache();\n    return;\n  }\n\n  if (!cacheSettings.disableCache) {\n    // Update in-memory cache\n    cache.set(cacheKey, {\n      data,\n      version,\n      staleAt,\n      sse: supportsSSE.has(key),\n    });\n    cleanupCache();\n  }\n  // Update local storage (don't await this, just update asynchronously)\n  updatePersistentCache();\n\n  // Update features for all subscribed GrowthBook instances\n  const instances = subscribedInstances.get(key);\n  instances && instances.forEach((instance) => refreshInstance(instance, data));\n}\n\nasync function refreshInstance(\n  instance: GrowthBook | GrowthBookClient,\n  data: FeatureApiResponse | null\n): Promise<void> {\n  await instance.setPayload(data || instance.getPayload());\n}\n\n// Fetch the features payload from helper function or from in-mem injected payload\nasync function fetchFeatures(\n  instance: GrowthBook | GrowthBookClient\n): Promise<FetchResponse> {\n  const { apiHost, apiRequestHeaders } = instance.getApiHosts();\n  const clientKey = instance.getClientKey();\n  const remoteEval = \"isRemoteEval\" in instance && instance.isRemoteEval();\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n\n  let promise = activeFetches.get(cacheKey);\n  if (!promise) {\n    const fetcher: Promise<Response> = remoteEval\n      ? helpers.fetchRemoteEvalCall({\n          host: apiHost,\n          clientKey,\n          payload: {\n            attributes: instance.getAttributes(),\n            forcedVariations: instance.getForcedVariations(),\n            forcedFeatures: Array.from(instance.getForcedFeatures().entries()),\n            url: instance.getUrl(),\n          },\n          headers: apiRequestHeaders,\n        })\n      : helpers.fetchFeaturesCall({\n          host: apiHost,\n          clientKey,\n          headers: apiRequestHeaders,\n        });\n\n    // TODO: auto-retry if status code indicates a temporary error\n    promise = fetcher\n      .then((res) => {\n        if (!res.ok) {\n          throw new Error(`HTTP error: ${res.status}`);\n        }\n        if (res.headers.get(\"x-sse-support\") === \"enabled\") {\n          supportsSSE.add(key);\n        }\n        return res.json();\n      })\n      .then((data: FeatureApiResponse) => {\n        onNewFeatureData(key, cacheKey, data);\n        startAutoRefresh(instance);\n        activeFetches.delete(cacheKey);\n        return { data, success: true, source: \"network\" as const };\n      })\n      .catch((e) => {\n        process.env.NODE_ENV !== \"production\" &&\n          instance.log(\"Error fetching features\", {\n            apiHost,\n            clientKey,\n            error: e ? e.message : null,\n          });\n        activeFetches.delete(cacheKey);\n\n        return {\n          data: null,\n          source: \"error\" as const,\n          success: false,\n          error: e,\n        };\n      });\n    activeFetches.set(cacheKey, promise);\n  }\n  return promise;\n}\n\n// Start SSE streaming, listens to feature payload changes and triggers a refresh or re-fetch\nfunction startAutoRefresh(\n  instance: GrowthBook | GrowthBookClient,\n  forceSSE: boolean = false\n): void {\n  const key = getKey(instance);\n  const cacheKey = getCacheKey(instance);\n  const { streamingHost, streamingHostRequestHeaders } = instance.getApiHosts();\n  const clientKey = instance.getClientKey();\n\n  if (forceSSE) {\n    supportsSSE.add(key);\n  }\n\n  if (\n    cacheSettings.backgroundSync &&\n    supportsSSE.has(key) &&\n    polyfills.EventSource\n  ) {\n    if (streams.has(key)) return;\n    const channel: ScopedChannel = {\n      src: null,\n      host: streamingHost,\n      clientKey,\n      headers: streamingHostRequestHeaders,\n      cb: (event: MessageEvent<string>) => {\n        try {\n          if (event.type === \"features-updated\") {\n            const instances = subscribedInstances.get(key);\n            instances &&\n              instances.forEach((instance) => {\n                fetchFeatures(instance);\n              });\n          } else if (event.type === \"features\") {\n            const json: FeatureApiResponse = JSON.parse(event.data);\n            onNewFeatureData(key, cacheKey, json);\n          }\n          // Reset error count on success\n          channel.errors = 0;\n        } catch (e) {\n          process.env.NODE_ENV !== \"production\" &&\n            instance.log(\"SSE Error\", {\n              streamingHost,\n              clientKey,\n              error: e ? (e as Error).message : null,\n            });\n          onSSEError(channel);\n        }\n      },\n      errors: 0,\n      state: \"active\",\n    };\n    streams.set(key, channel);\n    enableChannel(channel);\n  }\n}\n\nfunction onSSEError(channel: ScopedChannel) {\n  if (channel.state === \"idle\") return;\n  channel.errors++;\n  if (channel.errors > 3 || (channel.src && channel.src.readyState === 2)) {\n    // exponential backoff after 4 errors, with jitter\n    const delay =\n      Math.pow(3, channel.errors - 3) * (1000 + Math.random() * 1000);\n    disableChannel(channel);\n    setTimeout(() => {\n      if ([\"idle\", \"active\"].includes(channel.state)) return;\n      enableChannel(channel);\n    }, Math.min(delay, 300000)); // 5 minutes max\n  }\n}\n\nfunction disableChannel(channel: ScopedChannel) {\n  if (!channel.src) return;\n  channel.src.onopen = null;\n  channel.src.onerror = null;\n  channel.src.close();\n  channel.src = null;\n  if (channel.state === \"active\") {\n    channel.state = \"disabled\";\n  }\n}\n\nfunction enableChannel(channel: ScopedChannel) {\n  channel.src = helpers.eventSourceCall({\n    host: channel.host,\n    clientKey: channel.clientKey,\n    headers: channel.headers,\n  }) as EventSource;\n  channel.state = \"active\";\n  channel.src.addEventListener(\"features\", channel.cb);\n  channel.src.addEventListener(\"features-updated\", channel.cb);\n  channel.src.onerror = () => onSSEError(channel);\n  channel.src.onopen = () => {\n    channel.errors = 0;\n  };\n}\n\nfunction destroyChannel(channel: ScopedChannel, key: string) {\n  disableChannel(channel);\n  streams.delete(key);\n}\n\nfunction clearAutoRefresh() {\n  // Clear list of which keys are auto-updated\n  supportsSSE.clear();\n\n  // Stop listening for any SSE events\n  streams.forEach(destroyChannel);\n\n  // Remove all references to GrowthBook instances\n  subscribedInstances.clear();\n\n  // Run the idle stream cleanup function\n  helpers.stopIdleListener();\n}\n\nexport function startStreaming(\n  instance: GrowthBook | GrowthBookClient,\n  options: InitOptions | InitSyncOptions\n) {\n  if (options.streaming) {\n    if (!instance.getClientKey()) {\n      throw new Error(\"Must specify clientKey to enable streaming\");\n    }\n    if (options.payload) {\n      startAutoRefresh(instance, true);\n    }\n    subscribe(instance);\n  }\n}\n","/* eslint-disable @typescript-eslint/no-explicit-any */\n\nimport { SavedGroupsValues } from \"./types/growthbook\";\nimport {\n  ConditionInterface,\n  TestedObj,\n  ConditionValue,\n  Operator,\n  OperatorConditionValue,\n  VarType,\n} from \"./types/mongrule\";\nimport { paddedVersionString } from \"./util\";\n\nconst _regexCache: { [key: string]: RegExp } = {};\n\n// The top-level condition evaluation function\nexport function evalCondition(\n  obj: TestedObj,\n  condition: ConditionInterface,\n  // Must be included for `condition` to correctly evaluate group Operators\n  savedGroups?: SavedGroupsValues\n): boolean {\n  savedGroups = savedGroups || {};\n  // Condition is an object, keys are either specific operators or object paths\n  // values are either arguments for operators or conditions for paths\n  for (const [k, v] of Object.entries(condition)) {\n    switch (k) {\n      case \"$or\":\n        if (!evalOr(obj, v as ConditionInterface[], savedGroups)) return false;\n        break;\n      case \"$nor\":\n        if (evalOr(obj, v as ConditionInterface[], savedGroups)) return false;\n        break;\n      case \"$and\":\n        if (!evalAnd(obj, v as ConditionInterface[], savedGroups)) return false;\n        break;\n      case \"$not\":\n        if (evalCondition(obj, v as ConditionInterface, savedGroups))\n          return false;\n        break;\n      default:\n        if (!evalConditionValue(v, getPath(obj, k), savedGroups)) return false;\n    }\n  }\n  return true;\n}\n\n// Return value at dot-separated path of an object\nfunction getPath(obj: TestedObj, path: string) {\n  const parts = path.split(\".\");\n  let current: any = obj;\n  for (let i = 0; i < parts.length; i++) {\n    if (current && typeof current === \"object\" && parts[i] in current) {\n      current = current[parts[i]];\n    } else {\n      return null;\n    }\n  }\n  return current;\n}\n\n// Transform a regex string into a real RegExp object\nfunction getRegex(regex: string): RegExp {\n  if (!_regexCache[regex]) {\n    _regexCache[regex] = new RegExp(regex.replace(/([^\\\\])\\//g, \"$1\\\\/\"));\n  }\n  return _regexCache[regex];\n}\n\n// Evaluate a single value against a condition\nfunction evalConditionValue(\n  condition: ConditionValue,\n  value: any,\n  savedGroups: SavedGroupsValues\n) {\n  // Simple equality comparisons\n  if (typeof condition === \"string\") {\n    return value + \"\" === condition;\n  }\n  if (typeof condition === \"number\") {\n    return value * 1 === condition;\n  }\n  if (typeof condition === \"boolean\") {\n    return value !== null && !!value === condition;\n  }\n\n  if (condition === null) {\n    return value === null;\n  }\n\n  if (Array.isArray(condition) || !isOperatorObject(condition)) {\n    return JSON.stringify(value) === JSON.stringify(condition);\n  }\n\n  // This is a special operator condition and we should evaluate each one separately\n  for (const op in condition) {\n    if (\n      !evalOperatorCondition(\n        op as Operator,\n        value,\n        condition[op as keyof OperatorConditionValue],\n        savedGroups\n      )\n    ) {\n      return false;\n    }\n  }\n  return true;\n}\n\n// If the object has only keys that start with '$'\nfunction isOperatorObject(obj: any): boolean {\n  const keys = Object.keys(obj);\n  return (\n    keys.length > 0 && keys.filter((k) => k[0] === \"$\").length === keys.length\n  );\n}\n\n// Return the data type of a value\nfunction getType(v: any): VarType | \"unknown\" {\n  if (v === null) return \"null\";\n  if (Array.isArray(v)) return \"array\";\n  const t = typeof v;\n  if ([\"string\", \"number\", \"boolean\", \"object\", \"undefined\"].includes(t)) {\n    return t as VarType;\n  }\n  return \"unknown\";\n}\n\n// At least one element of actual must match the expected condition/value\nfunction elemMatch(actual: any, expected: any, savedGroups: SavedGroupsValues) {\n  if (!Array.isArray(actual)) return false;\n  const check = isOperatorObject(expected)\n    ? (v: any) => evalConditionValue(expected, v, savedGroups)\n    : (v: any) => evalCondition(v, expected, savedGroups);\n  for (let i = 0; i < actual.length; i++) {\n    if (actual[i] && check(actual[i])) {\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction isIn(actual: any, expected: Array<any>): boolean {\n  // Do an intersection if attribute is an array\n  if (Array.isArray(actual)) {\n    return actual.some((el) => expected.includes(el));\n  }\n  return expected.includes(actual);\n}\n\n// Evaluate a single operator condition\nfunction evalOperatorCondition(\n  operator: Operator,\n  actual: any,\n  expected: any,\n  savedGroups: SavedGroupsValues\n): boolean {\n  switch (operator) {\n    case \"$veq\":\n      return paddedVersionString(actual) === paddedVersionString(expected);\n    case \"$vne\":\n      return paddedVersionString(actual) !== paddedVersionString(expected);\n    case \"$vgt\":\n      return paddedVersionString(actual) > paddedVersionString(expected);\n    case \"$vgte\":\n      return paddedVersionString(actual) >= paddedVersionString(expected);\n    case \"$vlt\":\n      return paddedVersionString(actual) < paddedVersionString(expected);\n    case \"$vlte\":\n      return paddedVersionString(actual) <= paddedVersionString(expected);\n    case \"$eq\":\n      return actual === expected;\n    case \"$ne\":\n      return actual !== expected;\n    case \"$lt\":\n      return actual < expected;\n    case \"$lte\":\n      return actual <= expected;\n    case \"$gt\":\n      return actual > expected;\n    case \"$gte\":\n      return actual >= expected;\n    case \"$exists\":\n      // Using `!=` and `==` instead of strict checks so it also matches for undefined\n      return expected ? actual != null : actual == null;\n    case \"$in\":\n      if (!Array.isArray(expected)) return false;\n      return isIn(actual, expected);\n    case \"$inGroup\":\n      return isIn(actual, savedGroups[expected] || []);\n    case \"$notInGroup\":\n      return !isIn(actual, savedGroups[expected] || []);\n    case \"$nin\":\n      if (!Array.isArray(expected)) return false;\n      return !isIn(actual, expected);\n    case \"$not\":\n      return !evalConditionValue(expected, actual, savedGroups);\n    case \"$size\":\n      if (!Array.isArray(actual)) return false;\n      return evalConditionValue(expected, actual.length, savedGroups);\n    case \"$elemMatch\":\n      return elemMatch(actual, expected, savedGroups);\n    case \"$all\":\n      if (!Array.isArray(actual)) return false;\n      for (let i = 0; i < expected.length; i++) {\n        let passed = false;\n        for (let j = 0; j < actual.length; j++) {\n          if (evalConditionValue(expected[i], actual[j], savedGroups)) {\n            passed = true;\n            break;\n          }\n        }\n        if (!passed) return false;\n      }\n      return true;\n    case \"$regex\":\n      try {\n        return getRegex(expected).test(actual);\n      } catch (e) {\n        return false;\n      }\n    case \"$type\":\n      return getType(actual) === expected;\n    default:\n      console.error(\"Unknown operator: \" + operator);\n      return false;\n  }\n}\n\n// Recursive $or rule\nfunction evalOr(\n  obj: TestedObj,\n  conditions: ConditionInterface[],\n  savedGroups: SavedGroupsValues\n): boolean {\n  if (!conditions.length) return true;\n  for (let i = 0; i < conditions.length; i++) {\n    if (evalCondition(obj, conditions[i], savedGroups)) {\n      return true;\n    }\n  }\n  return false;\n}\n\n// Recursive $and rule\nfunction evalAnd(\n  obj: TestedObj,\n  conditions: ConditionInterface[],\n  savedGroups: SavedGroupsValues\n): boolean {\n  for (let i = 0; i < conditions.length; i++) {\n    if (!evalCondition(obj, conditions[i], savedGroups)) {\n      return false;\n    }\n  }\n  return true;\n}\n","import {\n  EvalContext,\n  FeatureDefinition,\n  FeatureResult,\n  Experiment,\n  FeatureResultSource,\n  Result,\n  Filter,\n  VariationRange,\n  VariationMeta,\n  StickyExperimentKey,\n  StickyAssignments,\n  StickyAttributeKey,\n  StickyAssignmentsDocument,\n  FeatureApiResponse,\n  Options,\n  ClientOptions,\n} from \"./types/growthbook\";\nimport { evalCondition } from \"./mongrule\";\nimport { ConditionInterface } from \"./types/mongrule\";\nimport {\n  chooseVariation,\n  decrypt,\n  getBucketRanges,\n  getQueryStringOverride,\n  getUrlRegExp,\n  hash,\n  inNamespace,\n  inRange,\n  isIncluded,\n  isURLTargeted,\n  toString,\n} from \"./util\";\nimport { StickyBucketService } from \"./sticky-bucket-service\";\n\nexport const EVENT_FEATURE_EVALUATED = \"Feature Evaluated\";\nexport const EVENT_EXPERIMENT_VIEWED = \"Experiment Viewed\";\n\nfunction getForcedFeatureValues(ctx: EvalContext) {\n  // Merge user and global values\n  const ret: typeof ctx.global.forcedFeatureValues = new Map();\n  if (ctx.global.forcedFeatureValues) {\n    ctx.global.forcedFeatureValues.forEach((v, k) => ret.set(k, v));\n  }\n  if (ctx.user.forcedFeatureValues) {\n    ctx.user.forcedFeatureValues.forEach((v, k) => ret.set(k, v));\n  }\n  return ret;\n}\n\nfunction getForcedVariations(ctx: EvalContext) {\n  // Merge user and global values\n  if (ctx.global.forcedVariations && ctx.user.forcedVariations) {\n    return { ...ctx.global.forcedVariations, ...ctx.user.forcedVariations };\n  } else if (ctx.global.forcedVariations) {\n    return ctx.global.forcedVariations;\n  } else if (ctx.user.forcedVariations) {\n    return ctx.user.forcedVariations;\n  } else {\n    return {};\n  }\n}\n\nasync function safeCall(fn: () => void | Promise<void>) {\n  try {\n    await fn();\n  } catch (e) {\n    // Do nothing\n  }\n}\n\nfunction onExperimentViewed(\n  ctx: EvalContext,\n  experiment: Experiment<unknown>,\n  result: Result<unknown>\n): Promise<void>[] {\n  // Make sure a tracking callback is only fired once per unique experiment\n  if (ctx.user.trackedExperiments) {\n    const k = getExperimentDedupeKey(experiment, result);\n    if (ctx.user.trackedExperiments.has(k)) {\n      return [];\n    }\n    ctx.user.trackedExperiments.add(k);\n  }\n\n  if (ctx.user.enableDevMode && ctx.user.devLogs) {\n    ctx.user.devLogs.push({\n      experiment,\n      result,\n      timestamp: Date.now().toString(),\n      logType: \"experiment\",\n    });\n  }\n\n  const calls: Promise<void>[] = [];\n\n  if (ctx.global.trackingCallback) {\n    const cb = ctx.global.trackingCallback;\n    calls.push(safeCall(() => cb(experiment, result, ctx.user)));\n  }\n  if (ctx.user.trackingCallback) {\n    const cb = ctx.user.trackingCallback;\n    calls.push(safeCall(() => cb(experiment, result)));\n  }\n  if (ctx.global.eventLogger) {\n    const cb = ctx.global.eventLogger;\n    calls.push(\n      safeCall(() =>\n        cb(\n          EVENT_EXPERIMENT_VIEWED,\n          {\n            experimentId: experiment.key,\n            variationId: result.key,\n            hashAttribute: result.hashAttribute,\n            hashValue: result.hashValue,\n          },\n          ctx.user\n        )\n      )\n    );\n  }\n  return calls;\n}\n\nfunction onFeatureUsage(\n  ctx: EvalContext,\n  key: string,\n  ret: FeatureResult<unknown>\n): void {\n  // Only track a feature once, unless the assigned value changed\n  if (ctx.user.trackedFeatureUsage) {\n    const stringifiedValue = JSON.stringify(ret.value);\n    if (ctx.user.trackedFeatureUsage[key] === stringifiedValue) return;\n    ctx.user.trackedFeatureUsage[key] = stringifiedValue;\n\n    if (ctx.user.enableDevMode && ctx.user.devLogs) {\n      ctx.user.devLogs.push({\n        featureKey: key,\n        result: ret,\n        timestamp: Date.now().toString(),\n        logType: \"feature\",\n      });\n    }\n  }\n\n  if (ctx.global.onFeatureUsage) {\n    const cb = ctx.global.onFeatureUsage;\n    safeCall(() => cb(key, ret, ctx.user));\n  }\n  if (ctx.user.onFeatureUsage) {\n    const cb = ctx.user.onFeatureUsage;\n    safeCall(() => cb(key, ret));\n  }\n  if (ctx.global.eventLogger) {\n    const cb = ctx.global.eventLogger;\n    safeCall(() =>\n      cb(\n        EVENT_FEATURE_EVALUATED,\n        {\n          feature: key,\n          source: ret.source,\n          value: ret.value,\n          ruleId: ret.source === \"defaultValue\" ? \"$default\" : ret.ruleId || \"\",\n          variationId: ret.experimentResult ? ret.experimentResult.key : \"\",\n        },\n        ctx.user\n      )\n    );\n  }\n}\n\nexport function evalFeature<V = unknown>(\n  id: string,\n  ctx: EvalContext\n): FeatureResult<V | null> {\n  if (ctx.stack.evaluatedFeatures.has(id)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\n        `evalFeature: circular dependency detected: ${ctx.stack.id} -> ${id}`,\n        {\n          from: ctx.stack.id,\n          to: id,\n        }\n      );\n    return getFeatureResult(ctx, id, null, \"cyclicPrerequisite\");\n  }\n  ctx.stack.evaluatedFeatures.add(id);\n  ctx.stack.id = id;\n\n  // Global override\n  const forcedValues = getForcedFeatureValues(ctx);\n  if (forcedValues.has(id)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Global override\", {\n        id,\n        value: forcedValues.get(id),\n      });\n    return getFeatureResult(ctx, id, forcedValues.get(id), \"override\");\n  }\n\n  // Unknown feature id\n  if (!ctx.global.features || !ctx.global.features[id]) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Unknown feature\", { id });\n    return getFeatureResult(ctx, id, null, \"unknownFeature\");\n  }\n\n  // Get the feature\n  const feature: FeatureDefinition<V> = ctx.global.features[id];\n\n  // Loop through the rules\n  if (feature.rules) {\n    const evaluatedFeatures = new Set(ctx.stack.evaluatedFeatures);\n    rules: for (const rule of feature.rules) {\n      // If there are prerequisite flag(s), evaluate them\n      if (rule.parentConditions) {\n        for (const parentCondition of rule.parentConditions) {\n          ctx.stack.evaluatedFeatures = new Set(evaluatedFeatures);\n          const parentResult = evalFeature(parentCondition.id, ctx);\n          // break out for cyclic prerequisites\n          if (parentResult.source === \"cyclicPrerequisite\") {\n            return getFeatureResult(ctx, id, null, \"cyclicPrerequisite\");\n          }\n\n          const evalObj = { value: parentResult.value };\n          const evaled = evalCondition(\n            evalObj,\n            parentCondition.condition || {}\n          );\n          if (!evaled) {\n            // blocking prerequisite eval failed: feature evaluation fails\n            if (parentCondition.gate) {\n              process.env.NODE_ENV !== \"production\" &&\n                ctx.global.log(\"Feature blocked by prerequisite\", { id, rule });\n              return getFeatureResult(ctx, id, null, \"prerequisite\");\n            }\n            // non-blocking prerequisite eval failed: break out of parentConditions loop, jump to the next rule\n            process.env.NODE_ENV !== \"production\" &&\n              ctx.global.log(\n                \"Skip rule because prerequisite evaluation fails\",\n                {\n                  id,\n                  rule,\n                }\n              );\n            continue rules;\n          }\n        }\n      }\n\n      // If there are filters for who is included (e.g. namespaces)\n      if (rule.filters && isFilteredOut(rule.filters, ctx)) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip rule because of filters\", {\n            id,\n            rule,\n          });\n        continue;\n      }\n\n      // Feature value is being forced\n      if (\"force\" in rule) {\n        // If it's a conditional rule, skip if the condition doesn't pass\n        if (rule.condition && !conditionPasses(rule.condition, ctx)) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip rule because of condition ff\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        // If this is a percentage rollout, skip if not included\n        if (\n          !isIncludedInRollout(\n            ctx,\n            rule.seed || id,\n            rule.hashAttribute,\n            ctx.user.saveStickyBucketAssignmentDoc &&\n              !rule.disableStickyBucketing\n              ? rule.fallbackAttribute\n              : undefined,\n            rule.range,\n            rule.coverage,\n            rule.hashVersion\n          )\n        ) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip rule because user not included in rollout\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Force value from rule\", {\n            id,\n            rule,\n          });\n\n        // If this was a remotely evaluated experiment, fire the tracking callbacks\n        if (rule.tracks) {\n          rule.tracks.forEach((t) => {\n            const calls = onExperimentViewed(ctx, t.experiment, t.result);\n            if (!calls.length && ctx.global.saveDeferredTrack) {\n              ctx.global.saveDeferredTrack({\n                experiment: t.experiment,\n                result: t.result,\n              });\n            }\n          });\n        }\n\n        return getFeatureResult(ctx, id, rule.force as V, \"force\", rule.id);\n      }\n      if (!rule.variations) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip invalid rule\", {\n            id,\n            rule,\n          });\n\n        continue;\n      }\n\n      // For experiment rules, run an experiment\n      const exp: Experiment<V> = {\n        variations: rule.variations as [V, V, ...V[]],\n        key: rule.key || id,\n      };\n      if (\"coverage\" in rule) exp.coverage = rule.coverage;\n      if (rule.weights) exp.weights = rule.weights;\n      if (rule.hashAttribute) exp.hashAttribute = rule.hashAttribute;\n      if (rule.fallbackAttribute)\n        exp.fallbackAttribute = rule.fallbackAttribute;\n      if (rule.disableStickyBucketing)\n        exp.disableStickyBucketing = rule.disableStickyBucketing;\n      if (rule.bucketVersion !== undefined)\n        exp.bucketVersion = rule.bucketVersion;\n      if (rule.minBucketVersion !== undefined)\n        exp.minBucketVersion = rule.minBucketVersion;\n      if (rule.namespace) exp.namespace = rule.namespace;\n      if (rule.meta) exp.meta = rule.meta;\n      if (rule.ranges) exp.ranges = rule.ranges;\n      if (rule.name) exp.name = rule.name;\n      if (rule.phase) exp.phase = rule.phase;\n      if (rule.seed) exp.seed = rule.seed;\n      if (rule.hashVersion) exp.hashVersion = rule.hashVersion;\n      if (rule.filters) exp.filters = rule.filters;\n      if (rule.condition) exp.condition = rule.condition;\n\n      // Only return a value if the user is part of the experiment\n      const { result } = runExperiment(exp, id, ctx);\n      ctx.global.onExperimentEval && ctx.global.onExperimentEval(exp, result);\n      if (result.inExperiment && !result.passthrough) {\n        return getFeatureResult(\n          ctx,\n          id,\n          result.value,\n          \"experiment\",\n          rule.id,\n          exp,\n          result\n        );\n      }\n    }\n  }\n\n  process.env.NODE_ENV !== \"production\" &&\n    ctx.global.log(\"Use default value\", {\n      id,\n      value: feature.defaultValue,\n    });\n\n  // Fall back to using the default value\n  return getFeatureResult(\n    ctx,\n    id,\n    feature.defaultValue === undefined ? null : feature.defaultValue,\n    \"defaultValue\"\n  );\n}\n\nexport function runExperiment<T>(\n  experiment: Experiment<T>,\n  featureId: string | null,\n  ctx: EvalContext\n): {\n  result: Result<T>;\n  trackingCall?: Promise<void>;\n} {\n  const key = experiment.key;\n  const numVariations = experiment.variations.length;\n\n  // 1. If experiment has less than 2 variations, return immediately\n  if (numVariations < 2) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Invalid experiment\", { id: key });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 2. If the context is disabled, return immediately\n  if (ctx.global.enabled === false || ctx.user.enabled === false) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Context disabled\", { id: key });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 2.5. Merge in experiment overrides from the context\n  experiment = mergeOverrides(experiment, ctx);\n\n  // 2.6 New, more powerful URL targeting\n  if (\n    experiment.urlPatterns &&\n    !isURLTargeted(ctx.user.url || \"\", experiment.urlPatterns)\n  ) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of url targeting\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 3. If a variation is forced from a querystring, return the forced variation\n  const qsOverride = getQueryStringOverride(\n    key,\n    ctx.user.url || \"\",\n    numVariations\n  );\n  if (qsOverride !== null) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force via querystring\", {\n        id: key,\n        variation: qsOverride,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        qsOverride,\n        false,\n        featureId\n      ),\n    };\n  }\n\n  // 4. If a variation is forced in the context, return the forced variation\n  const forcedVariations = getForcedVariations(ctx);\n  if (key in forcedVariations) {\n    const variation = forcedVariations[key];\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force via dev tools\", {\n        id: key,\n        variation,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, variation, false, featureId),\n    };\n  }\n\n  // 5. Exclude if a draft experiment or not active\n  if (experiment.status === \"draft\" || experiment.active === false) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because inactive\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 6. Get the hash attribute and return if empty\n  const { hashAttribute, hashValue } = getHashAttribute(\n    ctx,\n    experiment.hashAttribute,\n    ctx.user.saveStickyBucketAssignmentDoc && !experiment.disableStickyBucketing\n      ? experiment.fallbackAttribute\n      : undefined\n  );\n  if (!hashValue) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because missing hashAttribute\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  let assigned = -1;\n\n  let foundStickyBucket = false;\n  let stickyBucketVersionIsBlocked = false;\n  if (\n    ctx.user.saveStickyBucketAssignmentDoc &&\n    !experiment.disableStickyBucketing\n  ) {\n    const { variation, versionIsBlocked } = getStickyBucketVariation({\n      ctx,\n      expKey: experiment.key,\n      expBucketVersion: experiment.bucketVersion,\n      expHashAttribute: experiment.hashAttribute,\n      expFallbackAttribute: experiment.fallbackAttribute,\n      expMinBucketVersion: experiment.minBucketVersion,\n      expMeta: experiment.meta,\n    });\n    foundStickyBucket = variation >= 0;\n    assigned = variation;\n    stickyBucketVersionIsBlocked = !!versionIsBlocked;\n  }\n\n  // Some checks are not needed if we already have a sticky bucket\n  if (!foundStickyBucket) {\n    // 7. Exclude if user is filtered out (used to be called \"namespace\")\n    if (experiment.filters) {\n      if (isFilteredOut(experiment.filters, ctx)) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip because of filters\", {\n            id: key,\n          });\n        return {\n          result: getExperimentResult(ctx, experiment, -1, false, featureId),\n        };\n      }\n    } else if (\n      experiment.namespace &&\n      !inNamespace(hashValue, experiment.namespace)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of namespace\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 7.5. Exclude if experiment.include returns false or throws\n    if (experiment.include && !isIncluded(experiment.include)) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of include function\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 8. Exclude if condition is false\n    if (experiment.condition && !conditionPasses(experiment.condition, ctx)) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of condition exp\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 8.05. Exclude if prerequisites are not met\n    if (experiment.parentConditions) {\n      const evaluatedFeatures = new Set(ctx.stack.evaluatedFeatures);\n      for (const parentCondition of experiment.parentConditions) {\n        ctx.stack.evaluatedFeatures = new Set(evaluatedFeatures);\n        const parentResult = evalFeature(parentCondition.id, ctx);\n        // break out for cyclic prerequisites\n        if (parentResult.source === \"cyclicPrerequisite\") {\n          return {\n            result: getExperimentResult(ctx, experiment, -1, false, featureId),\n          };\n        }\n\n        const evalObj = { value: parentResult.value };\n        if (!evalCondition(evalObj, parentCondition.condition || {})) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip because prerequisite evaluation fails\", {\n              id: key,\n            });\n          return {\n            result: getExperimentResult(ctx, experiment, -1, false, featureId),\n          };\n        }\n      }\n    }\n\n    // 8.1. Exclude if user is not in a required group\n    if (\n      experiment.groups &&\n      !hasGroupOverlap(experiment.groups as string[], ctx)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of groups\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n  }\n\n  // 8.2. Old style URL targeting\n  if (experiment.url && !urlIsValid(experiment.url as RegExp, ctx)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of url\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 9. Get the variation from the sticky bucket or get bucket ranges and choose variation\n  const n = hash(\n    experiment.seed || key,\n    hashValue,\n    experiment.hashVersion || 1\n  );\n  if (n === null) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of invalid hash version\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  if (!foundStickyBucket) {\n    const ranges =\n      experiment.ranges ||\n      getBucketRanges(\n        numVariations,\n        experiment.coverage === undefined ? 1 : experiment.coverage,\n        experiment.weights\n      );\n    assigned = chooseVariation(n, ranges);\n  }\n\n  // 9.5 Unenroll if any prior sticky buckets are blocked by version\n  if (stickyBucketVersionIsBlocked) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because sticky bucket version is blocked\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        -1,\n        false,\n        featureId,\n        undefined,\n        true\n      ),\n    };\n  }\n\n  // 10. Return if not in experiment\n  if (assigned < 0) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of coverage\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 11. Experiment has a forced variation\n  if (\"force\" in experiment) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force variation\", {\n        id: key,\n        variation: experiment.force,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        experiment.force === undefined ? -1 : experiment.force,\n        false,\n        featureId\n      ),\n    };\n  }\n\n  // 12. Exclude if in QA mode\n  if (ctx.global.qaMode || ctx.user.qaMode) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because QA mode\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 12.5. Exclude if experiment is stopped\n  if (experiment.status === \"stopped\") {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because stopped\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 13. Build the result object\n  const result = getExperimentResult(\n    ctx,\n    experiment,\n    assigned,\n    true,\n    featureId,\n    n,\n    foundStickyBucket\n  );\n\n  // 13.5. Persist sticky bucket\n  if (\n    ctx.user.saveStickyBucketAssignmentDoc &&\n    !experiment.disableStickyBucketing\n  ) {\n    const { changed, key: attrKey, doc } = generateStickyBucketAssignmentDoc(\n      ctx,\n      hashAttribute,\n      toString(hashValue),\n      {\n        [getStickyBucketExperimentKey(\n          experiment.key,\n          experiment.bucketVersion\n        )]: result.key,\n      }\n    );\n    if (changed) {\n      // update local docs\n      ctx.user.stickyBucketAssignmentDocs =\n        ctx.user.stickyBucketAssignmentDocs || {};\n      ctx.user.stickyBucketAssignmentDocs[attrKey] = doc;\n      // save doc\n      ctx.user.saveStickyBucketAssignmentDoc(doc);\n    }\n  }\n\n  // 14. Fire the tracking callback(s)\n  // Store the promise in case we're awaiting it (ex: browser url redirects)\n  const trackingCalls = onExperimentViewed(ctx, experiment, result);\n  if (trackingCalls.length === 0 && ctx.global.saveDeferredTrack) {\n    ctx.global.saveDeferredTrack({\n      experiment,\n      result,\n    });\n  }\n  const trackingCall = !trackingCalls.length\n    ? undefined\n    : trackingCalls.length === 1\n    ? trackingCalls[0]\n    : Promise.all(trackingCalls).then(() => {});\n\n  // 14.1 Keep track of completed changeIds\n  \"changeId\" in experiment &&\n    experiment.changeId &&\n    ctx.global.recordChangeId &&\n    ctx.global.recordChangeId(experiment.changeId as string);\n\n  // 15. Return the result\n  process.env.NODE_ENV !== \"production\" &&\n    ctx.global.log(\"In experiment\", {\n      id: key,\n      variation: result.variationId,\n    });\n  return { result, trackingCall };\n}\n\nfunction getFeatureResult<T>(\n  ctx: EvalContext,\n  key: string,\n  value: T,\n  source: FeatureResultSource,\n  ruleId?: string,\n  experiment?: Experiment<T>,\n  result?: Result<T>\n): FeatureResult<T> {\n  const ret: FeatureResult = {\n    value,\n    on: !!value,\n    off: !value,\n    source,\n    ruleId: ruleId || \"\",\n  };\n  if (experiment) ret.experiment = experiment;\n  if (result) ret.experimentResult = result;\n\n  // Track the usage of this feature in real-time\n  if (source !== \"override\") {\n    onFeatureUsage(ctx, key, ret);\n  }\n\n  return ret;\n}\n\nfunction getAttributes(ctx: EvalContext) {\n  return {\n    ...ctx.user.attributes,\n    ...ctx.user.attributeOverrides,\n  };\n}\n\nfunction conditionPasses(\n  condition: ConditionInterface,\n  ctx: EvalContext\n): boolean {\n  return evalCondition(\n    getAttributes(ctx),\n    condition,\n    ctx.global.savedGroups || {}\n  );\n}\n\nfunction isFilteredOut(filters: Filter[], ctx: EvalContext): boolean {\n  return filters.some((filter) => {\n    const { hashValue } = getHashAttribute(ctx, filter.attribute);\n    if (!hashValue) return true;\n    const n = hash(filter.seed, hashValue, filter.hashVersion || 2);\n    if (n === null) return true;\n    return !filter.ranges.some((r) => inRange(n, r));\n  });\n}\n\nfunction isIncludedInRollout(\n  ctx: EvalContext,\n  seed: string,\n  hashAttribute: string | undefined,\n  fallbackAttribute: string | undefined,\n  range: VariationRange | undefined,\n  coverage: number | undefined,\n  hashVersion: number | undefined\n): boolean {\n  if (!range && coverage === undefined) return true;\n\n  if (!range && coverage === 0) return false;\n\n  const { hashValue } = getHashAttribute(ctx, hashAttribute, fallbackAttribute);\n  if (!hashValue) {\n    return false;\n  }\n\n  const n = hash(seed, hashValue, hashVersion || 1);\n  if (n === null) return false;\n\n  return range\n    ? inRange(n, range)\n    : coverage !== undefined\n    ? n <= coverage\n    : true;\n}\n\nexport function getExperimentResult<T>(\n  ctx: EvalContext,\n  experiment: Experiment<T>,\n  variationIndex: number,\n  hashUsed: boolean,\n  featureId: string | null,\n  bucket?: number,\n  stickyBucketUsed?: boolean\n): Result<T> {\n  let inExperiment = true;\n  // If assigned variation is not valid, use the baseline and mark the user as not in the experiment\n  if (variationIndex < 0 || variationIndex >= experiment.variations.length) {\n    variationIndex = 0;\n    inExperiment = false;\n  }\n\n  const { hashAttribute, hashValue } = getHashAttribute(\n    ctx,\n    experiment.hashAttribute,\n    ctx.user.saveStickyBucketAssignmentDoc && !experiment.disableStickyBucketing\n      ? experiment.fallbackAttribute\n      : undefined\n  );\n\n  const meta: Partial<VariationMeta> = experiment.meta\n    ? experiment.meta[variationIndex]\n    : {};\n\n  const res: Result<T> = {\n    key: meta.key || \"\" + variationIndex,\n    featureId,\n    inExperiment,\n    hashUsed,\n    variationId: variationIndex,\n    value: experiment.variations[variationIndex],\n    hashAttribute,\n    hashValue,\n    stickyBucketUsed: !!stickyBucketUsed,\n  };\n\n  if (meta.name) res.name = meta.name;\n  if (bucket !== undefined) res.bucket = bucket;\n  if (meta.passthrough) res.passthrough = meta.passthrough;\n\n  return res;\n}\n\nfunction mergeOverrides<T>(\n  experiment: Experiment<T>,\n  ctx: EvalContext\n): Experiment<T> {\n  const key = experiment.key;\n  const o = ctx.global.overrides;\n  if (o && o[key]) {\n    experiment = Object.assign({}, experiment, o[key]);\n    if (typeof experiment.url === \"string\") {\n      experiment.url = getUrlRegExp(\n        // eslint-disable-next-line\n        experiment.url as any\n      );\n    }\n  }\n\n  return experiment;\n}\n\nexport function getHashAttribute(\n  ctx: EvalContext,\n  attr?: string,\n  fallback?: string\n) {\n  let hashAttribute = attr || \"id\";\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let hashValue: any = \"\";\n\n  const attributes = getAttributes(ctx);\n\n  if (attributes[hashAttribute]) {\n    hashValue = attributes[hashAttribute];\n  }\n\n  // if no match, try fallback\n  if (!hashValue && fallback) {\n    if (attributes[fallback]) {\n      hashValue = attributes[fallback];\n    }\n    if (hashValue) {\n      hashAttribute = fallback;\n    }\n  }\n\n  return { hashAttribute, hashValue };\n}\n\nfunction urlIsValid(urlRegex: RegExp, ctx: EvalContext): boolean {\n  const url = ctx.user.url;\n  if (!url) return false;\n\n  const pathOnly = url.replace(/^https?:\\/\\//, \"\").replace(/^[^/]*\\//, \"/\");\n\n  if (urlRegex.test(url)) return true;\n  if (urlRegex.test(pathOnly)) return true;\n  return false;\n}\n\nfunction hasGroupOverlap(expGroups: string[], ctx: EvalContext): boolean {\n  const groups = ctx.global.groups || {};\n  for (let i = 0; i < expGroups.length; i++) {\n    if (groups[expGroups[i]]) return true;\n  }\n  return false;\n}\n\nfunction getStickyBucketVariation({\n  ctx,\n  expKey,\n  expBucketVersion,\n  expHashAttribute,\n  expFallbackAttribute,\n  expMinBucketVersion,\n  expMeta,\n}: {\n  ctx: EvalContext;\n  expKey: string;\n  expBucketVersion?: number;\n  expHashAttribute?: string;\n  expFallbackAttribute?: string;\n  expMinBucketVersion?: number;\n  expMeta?: VariationMeta[];\n}): {\n  variation: number;\n  versionIsBlocked?: boolean;\n} {\n  expBucketVersion = expBucketVersion || 0;\n  expMinBucketVersion = expMinBucketVersion || 0;\n  expHashAttribute = expHashAttribute || \"id\";\n  expMeta = expMeta || [];\n  const id = getStickyBucketExperimentKey(expKey, expBucketVersion);\n  const assignments = getStickyBucketAssignments(\n    ctx,\n    expHashAttribute,\n    expFallbackAttribute\n  );\n\n  // users with any blocked bucket version (0 to minExperimentBucketVersion) are excluded from the test\n  if (expMinBucketVersion > 0) {\n    for (let i = 0; i <= expMinBucketVersion; i++) {\n      const blockedKey = getStickyBucketExperimentKey(expKey, i);\n      if (assignments[blockedKey] !== undefined) {\n        return {\n          variation: -1,\n          versionIsBlocked: true,\n        };\n      }\n    }\n  }\n  const variationKey = assignments[id];\n  if (variationKey === undefined)\n    // no assignment found\n    return { variation: -1 };\n  const variation = expMeta.findIndex((m) => m.key === variationKey);\n  if (variation < 0)\n    // invalid assignment, treat as \"no assignment found\"\n    return { variation: -1 };\n\n  return { variation };\n}\n\nfunction getStickyBucketExperimentKey(\n  experimentKey: string,\n  experimentBucketVersion?: number\n): StickyExperimentKey {\n  experimentBucketVersion = experimentBucketVersion || 0;\n  return `${experimentKey}__${experimentBucketVersion}`;\n}\n\nexport function getStickyBucketAttributeKey(\n  attributeName: string,\n  attributeValue: string\n): StickyAttributeKey {\n  return `${attributeName}||${attributeValue}`;\n}\n\nfunction getStickyBucketAssignments(\n  ctx: EvalContext,\n  expHashAttribute: string,\n  expFallbackAttribute?: string\n): StickyAssignments {\n  if (!ctx.user.stickyBucketAssignmentDocs) return {};\n  const { hashAttribute, hashValue } = getHashAttribute(ctx, expHashAttribute);\n  const hashKey = getStickyBucketAttributeKey(\n    hashAttribute,\n    toString(hashValue)\n  );\n\n  const {\n    hashAttribute: fallbackAttribute,\n    hashValue: fallbackValue,\n  } = getHashAttribute(ctx, expFallbackAttribute);\n  const fallbackKey = fallbackValue\n    ? getStickyBucketAttributeKey(fallbackAttribute, toString(fallbackValue))\n    : null;\n\n  const assignments: StickyAssignments = {};\n  if (fallbackKey && ctx.user.stickyBucketAssignmentDocs[fallbackKey]) {\n    Object.assign(\n      assignments,\n      ctx.user.stickyBucketAssignmentDocs[fallbackKey].assignments || {}\n    );\n  }\n  if (ctx.user.stickyBucketAssignmentDocs[hashKey]) {\n    Object.assign(\n      assignments,\n      ctx.user.stickyBucketAssignmentDocs[hashKey].assignments || {}\n    );\n  }\n  return assignments;\n}\n\nfunction generateStickyBucketAssignmentDoc(\n  ctx: EvalContext,\n  attributeName: string,\n  attributeValue: string,\n  assignments: StickyAssignments\n): {\n  key: StickyAttributeKey;\n  doc: StickyAssignmentsDocument;\n  changed: boolean;\n} {\n  const key = getStickyBucketAttributeKey(attributeName, attributeValue);\n  const existingAssignments =\n    ctx.user.stickyBucketAssignmentDocs &&\n    ctx.user.stickyBucketAssignmentDocs[key]\n      ? ctx.user.stickyBucketAssignmentDocs[key].assignments || {}\n      : {};\n  const newAssignments = { ...existingAssignments, ...assignments };\n  const changed =\n    JSON.stringify(existingAssignments) !== JSON.stringify(newAssignments);\n\n  return {\n    key,\n    doc: {\n      attributeName,\n      attributeValue,\n      assignments: newAssignments,\n    },\n    changed,\n  };\n}\n\nfunction deriveStickyBucketIdentifierAttributes(\n  ctx: EvalContext,\n  data?: FeatureApiResponse\n) {\n  const attributes = new Set<string>();\n  const features =\n    data && data.features ? data.features : ctx.global.features || {};\n  const experiments =\n    data && data.experiments ? data.experiments : ctx.global.experiments || [];\n  Object.keys(features).forEach((id) => {\n    const feature = features[id];\n    if (feature.rules) {\n      for (const rule of feature.rules) {\n        if (rule.variations) {\n          attributes.add(rule.hashAttribute || \"id\");\n          if (rule.fallbackAttribute) {\n            attributes.add(rule.fallbackAttribute);\n          }\n        }\n      }\n    }\n  });\n  experiments.map((experiment) => {\n    attributes.add(experiment.hashAttribute || \"id\");\n    if (experiment.fallbackAttribute) {\n      attributes.add(experiment.fallbackAttribute);\n    }\n  });\n  return Array.from(attributes);\n}\n\nexport async function getAllStickyBucketAssignmentDocs(\n  ctx: EvalContext,\n  stickyBucketService: StickyBucketService,\n  data?: FeatureApiResponse\n) {\n  const attributes = getStickyBucketAttributes(ctx, data);\n  return stickyBucketService.getAllAssignments(attributes);\n}\n\nexport function getStickyBucketAttributes(\n  ctx: EvalContext,\n  data?: FeatureApiResponse\n): Record<string, string> {\n  const attributes: Record<string, string> = {};\n  const stickyBucketIdentifierAttributes = deriveStickyBucketIdentifierAttributes(\n    ctx,\n    data\n  );\n  stickyBucketIdentifierAttributes.forEach((attr) => {\n    const { hashValue } = getHashAttribute(ctx, attr);\n    attributes[attr] = toString(hashValue);\n  });\n  return attributes;\n}\n\nexport async function decryptPayload(\n  data: FeatureApiResponse,\n  decryptionKey: string | undefined,\n  subtle?: SubtleCrypto\n): Promise<FeatureApiResponse> {\n  data = { ...data };\n  if (data.encryptedFeatures) {\n    try {\n      data.features = JSON.parse(\n        await decrypt(data.encryptedFeatures, decryptionKey, subtle)\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedFeatures;\n  }\n  if (data.encryptedExperiments) {\n    try {\n      data.experiments = JSON.parse(\n        await decrypt(data.encryptedExperiments, decryptionKey, subtle)\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedExperiments;\n  }\n  if (data.encryptedSavedGroups) {\n    try {\n      data.savedGroups = JSON.parse(\n        await decrypt(data.encryptedSavedGroups, decryptionKey, subtle)\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedSavedGroups;\n  }\n  return data;\n}\n\nexport function getApiHosts(\n  options: Options | ClientOptions\n): {\n  apiHost: string;\n  streamingHost: string;\n  apiRequestHeaders?: Record<string, string>;\n  streamingHostRequestHeaders?: Record<string, string>;\n} {\n  const defaultHost = options.apiHost || \"https://cdn.growthbook.io\";\n  return {\n    apiHost: defaultHost.replace(/\\/*$/, \"\"),\n    streamingHost: (options.streamingHost || defaultHost).replace(/\\/*$/, \"\"),\n    apiRequestHeaders: options.apiHostRequestHeaders,\n    streamingHostRequestHeaders: options.streamingHostRequestHeaders,\n  };\n}\n\nexport function getExperimentDedupeKey(\n  experiment: Experiment<unknown>,\n  result: Result<unknown>\n) {\n  return (\n    result.hashAttribute +\n    result.hashValue +\n    experiment.key +\n    result.variationId\n  );\n}\n","import mutate, { DeclarativeMutation } from \"dom-mutator\";\nimport type {\n  ApiHost,\n  Attributes,\n  AutoExperiment,\n  AutoExperimentVariation,\n  ClientKey,\n  Options,\n  Experiment,\n  FeatureApiResponse,\n  FeatureDefinition,\n  FeatureResult,\n  LoadFeaturesOptions,\n  RefreshFeaturesOptions,\n  RenderFunction,\n  Result,\n  SubscriptionFunction,\n  TrackingCallback,\n  TrackingData,\n  WidenPrimitives,\n  EvalContext,\n  InitOptions,\n  InitResponse,\n  InitSyncOptions,\n  PrefetchOptions,\n  GlobalContext,\n  UserContext,\n  StickyAssignmentsDocument,\n  EventLogger,\n  LogUnion,\n} from \"./types/growthbook\";\nimport {\n  decrypt,\n  getAutoExperimentChangeType,\n  isURLTargeted,\n  loadSDKVersion,\n  mergeQueryStrings,\n  promiseTimeout,\n} from \"./util\";\nimport {\n  configureCache,\n  refreshFeatures,\n  startStreaming,\n  unsubscribe,\n} from \"./feature-repository\";\nimport {\n  runExperiment,\n  evalFeature as _evalFeature,\n  getExperimentResult,\n  getAllStickyBucketAssignmentDocs,\n  decryptPayload,\n  getApiHosts,\n  getExperimentDedupeKey,\n  getStickyBucketAttributes,\n} from \"./core\";\nimport { StickyBucketServiceSync } from \"./sticky-bucket-service\";\n\nconst isBrowser =\n  typeof window !== \"undefined\" && typeof document !== \"undefined\";\n\nconst SDK_VERSION = loadSDKVersion();\n\nexport class GrowthBook<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  AppFeatures extends Record<string, any> = Record<string, any>\n> {\n  // context is technically private, but some tools depend on it so we can't mangle the name\n  private context: Options;\n  public debug: boolean;\n  public ready: boolean;\n  public version: string;\n  public logs: Array<LogUnion>;\n\n  // Properties and methods that start with \"_\" are mangled by Terser (saves ~150 bytes)\n  private _options: Options;\n  private _renderer: null | RenderFunction;\n  private _redirectedUrl: string;\n  private _trackedExperiments: Set<string>;\n  private _completedChangeIds: Set<string>;\n  private _trackedFeatures: Record<string, string>;\n  private _subscriptions: Set<SubscriptionFunction>;\n  private _assigned: Map<\n    string,\n    {\n      // eslint-disable-next-line\n      experiment: Experiment<any>;\n      // eslint-disable-next-line\n      result: Result<any>;\n    }\n  >;\n  private _activeAutoExperiments: Map<\n    AutoExperiment,\n    { valueHash: string; undo: () => void }\n  >;\n  private _triggeredExpKeys: Set<string>;\n  private _initialized: boolean;\n  private _deferredTrackingCalls: Map<string, TrackingData>;\n  private _saveStickyBucketAssignmentDoc:\n    | undefined\n    | ((doc: StickyAssignmentsDocument) => Promise<unknown>);\n\n  private _payload: FeatureApiResponse | undefined;\n  private _decryptedPayload: FeatureApiResponse | undefined;\n  private _destroyCallbacks: (() => void)[];\n\n  private _autoExperimentsAllowed: boolean;\n  private _destroyed?: boolean;\n\n  constructor(options?: Options) {\n    options = options || {};\n    // These properties are all initialized in the constructor instead of above\n    // This saves ~80 bytes in the final output\n    this.version = SDK_VERSION;\n    this._options = this.context = options;\n    this._renderer = options.renderer || null;\n    this._trackedExperiments = new Set();\n    this._completedChangeIds = new Set();\n    this._trackedFeatures = {};\n    this.debug = !!options.debug;\n    this._subscriptions = new Set();\n    this.ready = false;\n    this._assigned = new Map();\n    this._activeAutoExperiments = new Map();\n    this._triggeredExpKeys = new Set();\n    this._initialized = false;\n    this._redirectedUrl = \"\";\n    this._deferredTrackingCalls = new Map();\n    this._autoExperimentsAllowed = !options.disableExperimentsOnLoad;\n    this._destroyCallbacks = [];\n    this.logs = [];\n\n    this.log = this.log.bind(this);\n    this._saveDeferredTrack = this._saveDeferredTrack.bind(this);\n    this._fireSubscriptions = this._fireSubscriptions.bind(this);\n    this._recordChangedId = this._recordChangedId.bind(this);\n\n    if (options.remoteEval) {\n      if (options.decryptionKey) {\n        throw new Error(\"Encryption is not available for remoteEval\");\n      }\n      if (!options.clientKey) {\n        throw new Error(\"Missing clientKey\");\n      }\n      let isGbHost = false;\n      try {\n        isGbHost = !!new URL(options.apiHost || \"\").hostname.match(\n          /growthbook\\.io$/i\n        );\n      } catch (e) {\n        // ignore invalid URLs\n      }\n      if (isGbHost) {\n        throw new Error(\"Cannot use remoteEval on GrowthBook Cloud\");\n      }\n    } else {\n      if (options.cacheKeyAttributes) {\n        throw new Error(\"cacheKeyAttributes are only used for remoteEval\");\n      }\n    }\n\n    if (options.stickyBucketService) {\n      const s = options.stickyBucketService;\n      this._saveStickyBucketAssignmentDoc = (doc) => {\n        return s.saveAssignments(doc);\n      };\n    }\n\n    if (options.plugins) {\n      for (const plugin of options.plugins) {\n        plugin(this);\n      }\n    }\n\n    if (options.features) {\n      this.ready = true;\n    }\n\n    if (isBrowser && options.enableDevMode) {\n      window._growthbook = this;\n      document.dispatchEvent(new Event(\"gbloaded\"));\n    }\n\n    if (options.experiments) {\n      this.ready = true;\n      this._updateAllAutoExperiments();\n    }\n\n    // Hydrate sticky bucket service\n    if (\n      this._options.stickyBucketService &&\n      this._options.stickyBucketAssignmentDocs\n    ) {\n      for (const key in this._options.stickyBucketAssignmentDocs) {\n        const doc = this._options.stickyBucketAssignmentDocs[key];\n        if (doc) {\n          this._options.stickyBucketService.saveAssignments(doc).catch(() => {\n            // Ignore hydration errors\n          });\n        }\n      }\n    }\n\n    // Legacy - passing in features/experiments into the constructor instead of using init\n    if (this.ready) {\n      this.refreshStickyBuckets(this.getPayload());\n    }\n  }\n\n  public async setPayload(payload: FeatureApiResponse): Promise<void> {\n    this._payload = payload;\n    const data = await decryptPayload(payload, this._options.decryptionKey);\n    this._decryptedPayload = data;\n    await this.refreshStickyBuckets(data);\n    if (data.features) {\n      this._options.features = data.features;\n    }\n    if (data.savedGroups) {\n      this._options.savedGroups = data.savedGroups;\n    }\n    if (data.experiments) {\n      this._options.experiments = data.experiments;\n      this._updateAllAutoExperiments();\n    }\n    this.ready = true;\n    this._render();\n  }\n\n  public initSync(options: InitSyncOptions): GrowthBook {\n    this._initialized = true;\n\n    const payload = options.payload;\n\n    if (payload.encryptedExperiments || payload.encryptedFeatures) {\n      throw new Error(\"initSync does not support encrypted payloads\");\n    }\n\n    if (\n      this._options.stickyBucketService &&\n      !this._options.stickyBucketAssignmentDocs\n    ) {\n      this._options.stickyBucketAssignmentDocs = this.generateStickyBucketAssignmentDocsSync(\n        this._options.stickyBucketService as StickyBucketServiceSync,\n        payload\n      );\n    }\n\n    this._payload = payload;\n    this._decryptedPayload = payload;\n    if (payload.features) {\n      this._options.features = payload.features;\n    }\n    if (payload.experiments) {\n      this._options.experiments = payload.experiments;\n      this._updateAllAutoExperiments();\n    }\n\n    this.ready = true;\n\n    startStreaming(this, options);\n\n    return this;\n  }\n\n  public async init(options?: InitOptions): Promise<InitResponse> {\n    this._initialized = true;\n    options = options || {};\n\n    if (options.cacheSettings) {\n      configureCache(options.cacheSettings);\n    }\n\n    if (options.payload) {\n      await this.setPayload(options.payload);\n      startStreaming(this, options);\n      return {\n        success: true,\n        source: \"init\",\n      };\n    } else {\n      const { data, ...res } = await this._refresh({\n        ...options,\n        allowStale: true,\n      });\n      startStreaming(this, options);\n      await this.setPayload(data || {});\n      return res;\n    }\n  }\n\n  /** @deprecated Use {@link init} */\n  public async loadFeatures(options?: LoadFeaturesOptions): Promise<void> {\n    options = options || {};\n    await this.init({\n      skipCache: options.skipCache,\n      timeout: options.timeout,\n      streaming:\n        (this._options.backgroundSync ?? true) &&\n        (options.autoRefresh || this._options.subscribeToChanges),\n    });\n  }\n\n  public async refreshFeatures(\n    options?: RefreshFeaturesOptions\n  ): Promise<void> {\n    const res = await this._refresh({\n      ...(options || {}),\n      allowStale: false,\n    });\n    if (res.data) {\n      await this.setPayload(res.data);\n    }\n  }\n\n  public getApiInfo(): [ApiHost, ClientKey] {\n    return [this.getApiHosts().apiHost, this.getClientKey()];\n  }\n  public getApiHosts() {\n    return getApiHosts(this._options);\n  }\n  public getClientKey(): string {\n    return this._options.clientKey || \"\";\n  }\n  public getPayload(): FeatureApiResponse {\n    return (\n      this._payload || {\n        features: this.getFeatures(),\n        experiments: this.getExperiments(),\n      }\n    );\n  }\n  public getDecryptedPayload(): FeatureApiResponse {\n    return this._decryptedPayload || this.getPayload();\n  }\n\n  public isRemoteEval(): boolean {\n    return this._options.remoteEval || false;\n  }\n\n  public getCacheKeyAttributes(): (keyof Attributes)[] | undefined {\n    return this._options.cacheKeyAttributes;\n  }\n\n  private async _refresh({\n    timeout,\n    skipCache,\n    allowStale,\n    streaming,\n  }: RefreshFeaturesOptions & {\n    allowStale?: boolean;\n    streaming?: boolean;\n  }) {\n    if (!this._options.clientKey) {\n      throw new Error(\"Missing clientKey\");\n    }\n    // Trigger refresh in feature repository\n    return refreshFeatures({\n      instance: this,\n      timeout,\n      skipCache: skipCache || this._options.disableCache,\n      allowStale,\n      backgroundSync: streaming ?? this._options.backgroundSync ?? true,\n    });\n  }\n\n  private _render() {\n    if (this._renderer) {\n      try {\n        this._renderer();\n      } catch (e) {\n        console.error(\"Failed to render\", e);\n      }\n    }\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public setFeatures(features: Record<string, FeatureDefinition>) {\n    this._options.features = features;\n    this.ready = true;\n    this._render();\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public async setEncryptedFeatures(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto\n  ): Promise<void> {\n    const featuresJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._options.decryptionKey,\n      subtle\n    );\n    this.setFeatures(\n      JSON.parse(featuresJSON) as Record<string, FeatureDefinition>\n    );\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public setExperiments(experiments: AutoExperiment[]): void {\n    this._options.experiments = experiments;\n    this.ready = true;\n    this._updateAllAutoExperiments();\n  }\n\n  /** @deprecated Use {@link setPayload} */\n  public async setEncryptedExperiments(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto\n  ): Promise<void> {\n    const experimentsJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._options.decryptionKey,\n      subtle\n    );\n    this.setExperiments(JSON.parse(experimentsJSON) as AutoExperiment[]);\n  }\n\n  public async setAttributes(attributes: Attributes) {\n    this._options.attributes = attributes;\n    if (this._options.stickyBucketService) {\n      await this.refreshStickyBuckets();\n    }\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  public async updateAttributes(attributes: Attributes) {\n    return this.setAttributes({ ...this._options.attributes, ...attributes });\n  }\n\n  public async setAttributeOverrides(overrides: Attributes) {\n    this._options.attributeOverrides = overrides;\n    if (this._options.stickyBucketService) {\n      await this.refreshStickyBuckets();\n    }\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  public async setForcedVariations(vars: Record<string, number>) {\n    this._options.forcedVariations = vars || {};\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      return;\n    }\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  // eslint-disable-next-line\n  public setForcedFeatures(map: Map<string, any>) {\n    this._options.forcedFeatureValues = map;\n    this._render();\n  }\n\n  public async setURL(url: string) {\n    if (url === this._options.url) return;\n    this._options.url = url;\n    this._redirectedUrl = \"\";\n    if (this._options.remoteEval) {\n      await this._refreshForRemoteEval();\n      this._updateAllAutoExperiments(true);\n      return;\n    }\n    this._updateAllAutoExperiments(true);\n  }\n\n  public getAttributes() {\n    return { ...this._options.attributes, ...this._options.attributeOverrides };\n  }\n\n  public getForcedVariations() {\n    return this._options.forcedVariations || {};\n  }\n\n  public getForcedFeatures() {\n    // eslint-disable-next-line\n    return this._options.forcedFeatureValues || new Map<string, any>();\n  }\n\n  public getStickyBucketAssignmentDocs() {\n    return this._options.stickyBucketAssignmentDocs || {};\n  }\n\n  public getUrl() {\n    return this._options.url || \"\";\n  }\n\n  public getFeatures() {\n    return this._options.features || {};\n  }\n\n  public getExperiments() {\n    return this._options.experiments || [];\n  }\n\n  public getCompletedChangeIds(): string[] {\n    return Array.from(this._completedChangeIds);\n  }\n\n  public subscribe(cb: SubscriptionFunction): () => void {\n    this._subscriptions.add(cb);\n    return () => {\n      this._subscriptions.delete(cb);\n    };\n  }\n\n  private async _refreshForRemoteEval() {\n    if (!this._options.remoteEval) return;\n    if (!this._initialized) return;\n    const res = await this._refresh({\n      allowStale: false,\n    });\n    if (res.data) {\n      await this.setPayload(res.data);\n    }\n  }\n\n  public getAllResults() {\n    return new Map(this._assigned);\n  }\n\n  public onDestroy(cb: () => void) {\n    this._destroyCallbacks.push(cb);\n  }\n\n  public isDestroyed() {\n    return !!this._destroyed;\n  }\n\n  public destroy() {\n    this._destroyed = true;\n\n    // Custom callbacks\n    // Do this first in case it needs access to the below data that is cleared\n    this._destroyCallbacks.forEach((cb) => {\n      try {\n        cb();\n      } catch (e) {\n        console.error(e);\n      }\n    });\n\n    // Release references to save memory\n    this._subscriptions.clear();\n    this._assigned.clear();\n    this._trackedExperiments.clear();\n    this._completedChangeIds.clear();\n    this._deferredTrackingCalls.clear();\n    this._trackedFeatures = {};\n    this._destroyCallbacks = [];\n    this._payload = undefined;\n    this._saveStickyBucketAssignmentDoc = undefined;\n    unsubscribe(this);\n    this.logs = [];\n\n    if (isBrowser && window._growthbook === this) {\n      delete window._growthbook;\n    }\n\n    // Undo any active auto experiments\n    this._activeAutoExperiments.forEach((exp) => {\n      exp.undo();\n    });\n    this._activeAutoExperiments.clear();\n    this._triggeredExpKeys.clear();\n  }\n\n  public setRenderer(renderer: null | RenderFunction) {\n    this._renderer = renderer;\n  }\n\n  public forceVariation(key: string, variation: number) {\n    this._options.forcedVariations = this._options.forcedVariations || {};\n    this._options.forcedVariations[key] = variation;\n    if (this._options.remoteEval) {\n      this._refreshForRemoteEval();\n      return;\n    }\n    this._updateAllAutoExperiments();\n    this._render();\n  }\n\n  public run<T>(experiment: Experiment<T>): Result<T> {\n    const { result } = runExperiment(experiment, null, this._getEvalContext());\n    this._fireSubscriptions(experiment, result);\n    return result;\n  }\n\n  public triggerExperiment(key: string) {\n    this._triggeredExpKeys.add(key);\n    if (!this._options.experiments) return null;\n    const experiments = this._options.experiments.filter(\n      (exp) => exp.key === key\n    );\n    return experiments\n      .map((exp) => {\n        return this._runAutoExperiment(exp);\n      })\n      .filter((res) => res !== null);\n  }\n\n  public triggerAutoExperiments() {\n    this._autoExperimentsAllowed = true;\n    this._updateAllAutoExperiments(true);\n  }\n\n  private _getEvalContext(): EvalContext {\n    return {\n      user: this._getUserContext(),\n      global: this._getGlobalContext(),\n      stack: {\n        evaluatedFeatures: new Set(),\n      },\n    };\n  }\n\n  private _getUserContext(): UserContext {\n    return {\n      attributes: this._options.user\n        ? {\n            ...this._options.user,\n            ...this._options.attributes,\n          }\n        : this._options.attributes,\n      enableDevMode: this._options.enableDevMode,\n      blockedChangeIds: this._options.blockedChangeIds,\n      stickyBucketAssignmentDocs: this._options.stickyBucketAssignmentDocs,\n      url: this._getContextUrl(),\n      forcedVariations: this._options.forcedVariations,\n      forcedFeatureValues: this._options.forcedFeatureValues,\n      attributeOverrides: this._options.attributeOverrides,\n      saveStickyBucketAssignmentDoc: this._saveStickyBucketAssignmentDoc,\n      trackingCallback: this._options.trackingCallback,\n      onFeatureUsage: this._options.onFeatureUsage,\n      devLogs: this.logs,\n      trackedExperiments: this._trackedExperiments,\n      trackedFeatureUsage: this._trackedFeatures,\n    };\n  }\n  private _getGlobalContext(): GlobalContext {\n    return {\n      features: this._options.features,\n      experiments: this._options.experiments,\n      log: this.log,\n      enabled: this._options.enabled,\n      qaMode: this._options.qaMode,\n      savedGroups: this._options.savedGroups,\n      groups: this._options.groups,\n      overrides: this._options.overrides,\n      onExperimentEval:\n        this._subscriptions.size > 0 ? this._fireSubscriptions : undefined,\n      recordChangeId: this._recordChangedId,\n      saveDeferredTrack: this._saveDeferredTrack,\n      eventLogger: this._options.eventLogger,\n    };\n  }\n\n  private _runAutoExperiment(experiment: AutoExperiment, forceRerun?: boolean) {\n    const existing = this._activeAutoExperiments.get(experiment);\n\n    // If this is a manual experiment and it's not already running, skip\n    if (\n      experiment.manual &&\n      !this._triggeredExpKeys.has(experiment.key) &&\n      !existing\n    )\n      return null;\n\n    // Check if this particular experiment is blocked by options settings\n    // For example, if all visualEditor experiments are disabled\n    const isBlocked = this._isAutoExperimentBlockedByContext(experiment);\n    if (isBlocked) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Auto experiment blocked\", { id: experiment.key });\n    }\n\n    let result: Result<AutoExperimentVariation> | undefined;\n    let trackingCall: Promise<void> | undefined;\n    // Run the experiment (if blocked exclude)\n    if (isBlocked) {\n      result = getExperimentResult(\n        this._getEvalContext(),\n        experiment,\n        -1,\n        false,\n        \"\"\n      );\n    } else {\n      ({ result, trackingCall } = runExperiment(\n        experiment,\n        null,\n        this._getEvalContext()\n      ));\n      this._fireSubscriptions(experiment, result);\n    }\n\n    // A hash to quickly tell if the assigned value changed\n    const valueHash = JSON.stringify(result.value);\n\n    // If the changes are already active, no need to re-apply them\n    if (\n      !forceRerun &&\n      result.inExperiment &&\n      existing &&\n      existing.valueHash === valueHash\n    ) {\n      return result;\n    }\n\n    // Undo any existing changes\n    if (existing) this._undoActiveAutoExperiment(experiment);\n\n    // Apply new changes\n    if (result.inExperiment) {\n      const changeType = getAutoExperimentChangeType(experiment);\n\n      if (\n        changeType === \"redirect\" &&\n        result.value.urlRedirect &&\n        experiment.urlPatterns\n      ) {\n        const url = experiment.persistQueryString\n          ? mergeQueryStrings(this._getContextUrl(), result.value.urlRedirect)\n          : result.value.urlRedirect;\n\n        if (isURLTargeted(url, experiment.urlPatterns)) {\n          this.log(\n            \"Skipping redirect because original URL matches redirect URL\",\n            {\n              id: experiment.key,\n            }\n          );\n          return result;\n        }\n        this._redirectedUrl = url;\n        const { navigate, delay } = this._getNavigateFunction();\n        if (navigate) {\n          if (isBrowser) {\n            // Wait for the possibly-async tracking callback, bound by min and max delays\n            Promise.all([\n              ...(trackingCall\n                ? [\n                    promiseTimeout(\n                      trackingCall,\n                      this._options.maxNavigateDelay ?? 1000\n                    ),\n                  ]\n                : []),\n              new Promise((resolve) =>\n                window.setTimeout(resolve, this._options.navigateDelay ?? delay)\n              ),\n            ]).then(() => {\n              try {\n                navigate(url);\n              } catch (e) {\n                console.error(e);\n              }\n            });\n          } else {\n            try {\n              navigate(url);\n            } catch (e) {\n              console.error(e);\n            }\n          }\n        }\n      } else if (changeType === \"visual\") {\n        const undo = this._options.applyDomChangesCallback\n          ? this._options.applyDomChangesCallback(result.value)\n          : this._applyDOMChanges(result.value);\n        if (undo) {\n          this._activeAutoExperiments.set(experiment, {\n            undo,\n            valueHash,\n          });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  private _undoActiveAutoExperiment(exp: AutoExperiment) {\n    const data = this._activeAutoExperiments.get(exp);\n    if (data) {\n      data.undo();\n      this._activeAutoExperiments.delete(exp);\n    }\n  }\n\n  private _updateAllAutoExperiments(forceRerun?: boolean) {\n    if (!this._autoExperimentsAllowed) return;\n\n    const experiments = this._options.experiments || [];\n\n    // Stop any experiments that are no longer defined\n    const keys = new Set(experiments);\n    this._activeAutoExperiments.forEach((v, k) => {\n      if (!keys.has(k)) {\n        v.undo();\n        this._activeAutoExperiments.delete(k);\n      }\n    });\n\n    // Re-run all new/updated experiments\n    for (const exp of experiments) {\n      const result = this._runAutoExperiment(exp, forceRerun);\n\n      // Once you're in a redirect experiment, break out of the loop and don't run any further experiments\n      if (\n        result?.inExperiment &&\n        getAutoExperimentChangeType(exp) === \"redirect\"\n      ) {\n        break;\n      }\n    }\n  }\n\n  private _fireSubscriptions<T>(experiment: Experiment<T>, result: Result<T>) {\n    const key = experiment.key;\n\n    // If assigned variation has changed, fire subscriptions\n    const prev = this._assigned.get(key);\n    // TODO: what if the experiment definition has changed?\n    if (\n      !prev ||\n      prev.result.inExperiment !== result.inExperiment ||\n      prev.result.variationId !== result.variationId\n    ) {\n      this._assigned.set(key, { experiment, result });\n      this._subscriptions.forEach((cb) => {\n        try {\n          cb(experiment, result);\n        } catch (e) {\n          console.error(e);\n        }\n      });\n    }\n  }\n\n  private _recordChangedId(id: string) {\n    this._completedChangeIds.add(id);\n  }\n\n  public isOn<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).on;\n  }\n\n  public isOff<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).off;\n  }\n\n  public getFeatureValue<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(key: K, defaultValue: V): WidenPrimitives<V> {\n    const value = this.evalFeature<WidenPrimitives<V>, K>(key).value;\n    return value === null ? (defaultValue as WidenPrimitives<V>) : value;\n  }\n\n  /**\n   * @deprecated Use {@link evalFeature}\n   * @param id\n   */\n  // eslint-disable-next-line\n  public feature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(id: K): FeatureResult<V | null> {\n    return this.evalFeature(id);\n  }\n\n  public evalFeature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(id: K): FeatureResult<V | null> {\n    return _evalFeature(id, this._getEvalContext());\n  }\n\n  log(msg: string, ctx: Record<string, unknown>) {\n    if (!this.debug) return;\n    if (this._options.log) this._options.log(msg, ctx);\n    else console.log(msg, ctx);\n  }\n\n  public getDeferredTrackingCalls(): TrackingData[] {\n    return Array.from(this._deferredTrackingCalls.values());\n  }\n\n  public setDeferredTrackingCalls(calls: TrackingData[]) {\n    this._deferredTrackingCalls = new Map(\n      calls\n        .filter((c) => c && c.experiment && c.result)\n        .map((c) => {\n          return [getExperimentDedupeKey(c.experiment, c.result), c];\n        })\n    );\n  }\n\n  public async fireDeferredTrackingCalls() {\n    if (!this._options.trackingCallback) return;\n\n    const promises: ReturnType<TrackingCallback>[] = [];\n    this._deferredTrackingCalls.forEach((call: TrackingData) => {\n      if (!call || !call.experiment || !call.result) {\n        console.error(\"Invalid deferred tracking call\", { call: call });\n      } else {\n        promises.push(\n          (this._options.trackingCallback as TrackingCallback)(\n            call.experiment,\n            call.result\n          )\n        );\n      }\n    });\n    this._deferredTrackingCalls.clear();\n    await Promise.all(promises);\n  }\n\n  public setTrackingCallback(callback: TrackingCallback) {\n    this._options.trackingCallback = callback;\n    this.fireDeferredTrackingCalls();\n  }\n\n  public setEventLogger(logger: EventLogger) {\n    this._options.eventLogger = logger;\n  }\n\n  public async logEvent(\n    eventName: string,\n    properties?: Record<string, unknown>\n  ) {\n    if (this._destroyed) {\n      console.error(\"Cannot log event to destroyed GrowthBook instance\");\n      return;\n    }\n    if (this._options.enableDevMode) {\n      this.logs.push({\n        eventName,\n        properties,\n        timestamp: Date.now().toString(),\n        logType: \"event\",\n      });\n    }\n    if (this._options.eventLogger) {\n      try {\n        await this._options.eventLogger(\n          eventName,\n          properties || {},\n          this._getUserContext()\n        );\n      } catch (e) {\n        console.error(e);\n      }\n    } else {\n      console.error(\"No event logger configured\");\n    }\n  }\n\n  private _saveDeferredTrack(data: TrackingData) {\n    this._deferredTrackingCalls.set(\n      getExperimentDedupeKey(data.experiment, data.result),\n      data\n    );\n  }\n\n  private _getContextUrl() {\n    return this._options.url || (isBrowser ? window.location.href : \"\");\n  }\n\n  private _isAutoExperimentBlockedByContext(\n    experiment: AutoExperiment\n  ): boolean {\n    const changeType = getAutoExperimentChangeType(experiment);\n    if (changeType === \"visual\") {\n      if (this._options.disableVisualExperiments) return true;\n\n      if (this._options.disableJsInjection) {\n        if (experiment.variations.some((v) => v.js)) {\n          return true;\n        }\n      }\n    } else if (changeType === \"redirect\") {\n      if (this._options.disableUrlRedirectExperiments) return true;\n\n      // Validate URLs\n      try {\n        const current = new URL(this._getContextUrl());\n        for (const v of experiment.variations) {\n          if (!v || !v.urlRedirect) continue;\n          const url = new URL(v.urlRedirect);\n\n          // If we're blocking cross origin redirects, block if the protocol or host is different\n          if (this._options.disableCrossOriginUrlRedirectExperiments) {\n            if (url.protocol !== current.protocol) return true;\n            if (url.host !== current.host) return true;\n          }\n        }\n      } catch (e) {\n        // Problem parsing one of the URLs\n        this.log(\"Error parsing current or redirect URL\", {\n          id: experiment.key,\n          error: e,\n        });\n        return true;\n      }\n    } else {\n      // Block any unknown changeTypes\n      return true;\n    }\n\n    if (\n      experiment.changeId &&\n      (this._options.blockedChangeIds || []).includes(experiment.changeId)\n    ) {\n      return true;\n    }\n\n    return false;\n  }\n\n  public getRedirectUrl(): string {\n    return this._redirectedUrl;\n  }\n\n  private _getNavigateFunction(): {\n    navigate: null | ((url: string) => void | Promise<void>);\n    delay: number;\n  } {\n    if (this._options.navigate) {\n      return {\n        navigate: this._options.navigate,\n        delay: 0,\n      };\n    } else if (isBrowser) {\n      return {\n        navigate: (url: string) => {\n          window.location.replace(url);\n        },\n        delay: 100,\n      };\n    }\n    return {\n      navigate: null,\n      delay: 0,\n    };\n  }\n\n  private _applyDOMChanges(changes: AutoExperimentVariation) {\n    if (!isBrowser) return;\n    const undo: (() => void)[] = [];\n    if (changes.css) {\n      const s = document.createElement(\"style\");\n      s.innerHTML = changes.css;\n      document.head.appendChild(s);\n      undo.push(() => s.remove());\n    }\n    if (changes.js) {\n      const script = document.createElement(\"script\");\n      script.innerHTML = changes.js;\n      if (this._options.jsInjectionNonce) {\n        script.nonce = this._options.jsInjectionNonce;\n      }\n      document.head.appendChild(script);\n      undo.push(() => script.remove());\n    }\n    if (changes.domMutations) {\n      changes.domMutations.forEach((mutation) => {\n        undo.push(mutate.declarative(mutation as DeclarativeMutation).revert);\n      });\n    }\n    return () => {\n      undo.forEach((fn) => fn());\n    };\n  }\n\n  public async refreshStickyBuckets(data?: FeatureApiResponse) {\n    if (this._options.stickyBucketService) {\n      const ctx = this._getEvalContext();\n      const docs = await getAllStickyBucketAssignmentDocs(\n        ctx,\n        this._options.stickyBucketService,\n        data\n      );\n      this._options.stickyBucketAssignmentDocs = docs;\n    }\n  }\n\n  public generateStickyBucketAssignmentDocsSync(\n    stickyBucketService: StickyBucketServiceSync,\n    payload: FeatureApiResponse\n  ) {\n    if (!(\"getAllAssignmentsSync\" in stickyBucketService)) {\n      console.error(\n        \"generating StickyBucketAssignmentDocs docs requires StickyBucketServiceSync\"\n      );\n      return;\n    }\n    const ctx = this._getEvalContext();\n    const attributes = getStickyBucketAttributes(ctx, payload);\n    return stickyBucketService.getAllAssignmentsSync(attributes);\n  }\n\n  public inDevMode(): boolean {\n    return !!this._options.enableDevMode;\n  }\n}\n\nexport async function prefetchPayload(options: PrefetchOptions) {\n  // Create a temporary instance, just to fetch the payload\n  const instance = new GrowthBook(options);\n\n  await refreshFeatures({\n    instance,\n    skipCache: options.skipCache,\n    allowStale: false,\n    backgroundSync: options.streaming,\n  });\n\n  instance.destroy();\n}\n","import {\n  LocalStorageCompat,\n  StickyAssignmentsDocument,\n  StickyAttributeKey,\n} from \"./types/growthbook\";\nimport { toString } from \"./util\";\nimport { getStickyBucketAttributeKey } from \"./core\";\n\nexport interface CookieAttributes {\n  expires?: number | Date | undefined;\n  path?: string | undefined;\n  domain?: string | undefined;\n  secure?: boolean | undefined;\n  sameSite?: \"strict\" | \"Strict\" | \"lax\" | \"Lax\" | \"none\" | \"None\" | undefined;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [property: string]: any;\n}\nexport interface JsCookiesCompat<T = string> {\n  set(\n    name: string,\n    value: string | T,\n    options?: CookieAttributes\n  ): string | undefined;\n  get(name: string): string | T | undefined;\n  get(): { [key: string]: string };\n  remove(name: string, options?: CookieAttributes): void;\n}\n\nexport interface IORedisCompat {\n  mget(...keys: string[]): Promise<string[]>;\n  set(key: string, value: string): Promise<string>;\n}\n\nexport interface RequestCompat {\n  cookies: Record<string, string>;\n  [key: string]: unknown;\n}\nexport interface ResponseCompat {\n  cookie(\n    name: string,\n    value: string,\n    options?: CookieAttributes\n  ): ResponseCompat;\n  [key: string]: unknown;\n}\n\n/**\n * Responsible for reading and writing documents which describe sticky bucket assignments.\n */\nexport abstract class StickyBucketService {\n  protected prefix: string;\n\n  constructor(opts?: { prefix?: string }) {\n    opts = opts || {};\n    this.prefix = opts.prefix || \"\";\n  }\n\n  abstract getAssignments(\n    attributeName: string,\n    attributeValue: string\n  ): Promise<StickyAssignmentsDocument | null>;\n\n  abstract saveAssignments(doc: StickyAssignmentsDocument): Promise<unknown>;\n\n  /**\n   * The SDK calls getAllAssignments to populate sticky buckets. This in turn will\n   * typically loop through individual getAssignments calls. However, some StickyBucketService\n   * instances (i.e. Redis) will instead perform a multi-query inside getAllAssignments instead.\n   */\n  async getAllAssignments(\n    attributes: Record<string, string>\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    (\n      await Promise.all(\n        Object.entries(attributes).map(([attributeName, attributeValue]) =>\n          this.getAssignments(attributeName, attributeValue)\n        )\n      )\n    ).forEach((doc) => {\n      if (doc) {\n        const key = getStickyBucketAttributeKey(\n          doc.attributeName,\n          doc.attributeValue\n        );\n        docs[key] = doc;\n      }\n    });\n    return docs;\n  }\n\n  getKey(attributeName: string, attributeValue: string): string {\n    return `${this.prefix}${attributeName}||${attributeValue}`;\n  }\n}\n\nexport abstract class StickyBucketServiceSync extends StickyBucketService {\n  abstract getAssignmentsSync(\n    attributeName: string,\n    attributeValue: string\n  ): StickyAssignmentsDocument | null;\n\n  abstract saveAssignmentsSync(doc: StickyAssignmentsDocument): void;\n\n  async getAssignments(attributeName: string, attributeValue: string) {\n    return this.getAssignmentsSync(attributeName, attributeValue);\n  }\n\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    this.saveAssignmentsSync(doc);\n  }\n\n  getAllAssignmentsSync(\n    attributes: Record<string, string>\n  ): Record<StickyAttributeKey, StickyAssignmentsDocument> {\n    const docs: Record<string, StickyAssignmentsDocument> = {};\n    Object.entries(attributes)\n      .map(([attributeName, attributeValue]) =>\n        this.getAssignmentsSync(attributeName, attributeValue)\n      )\n      .forEach((doc) => {\n        if (doc) {\n          const key = getStickyBucketAttributeKey(\n            doc.attributeName,\n            doc.attributeValue\n          );\n          docs[key] = doc;\n        }\n      });\n    return docs;\n  }\n}\n\nexport class LocalStorageStickyBucketService extends StickyBucketService {\n  private localStorage: LocalStorageCompat | undefined;\n  constructor(opts?: { prefix?: string; localStorage?: LocalStorageCompat }) {\n    opts = opts || {};\n    super();\n    this.prefix = opts.prefix || \"gbStickyBuckets__\";\n    try {\n      this.localStorage = opts.localStorage || globalThis.localStorage;\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n  async getAssignments(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.localStorage) return doc;\n    try {\n      const raw = (await this.localStorage.getItem(key)) || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n    return doc;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.localStorage) return;\n    try {\n      await this.localStorage.setItem(key, JSON.stringify(doc));\n    } catch (e) {\n      // Ignore localStorage errors\n    }\n  }\n}\n\nexport class ExpressCookieStickyBucketService extends StickyBucketServiceSync {\n  /**\n   * Intended to be used with cookieParser() middleware from npm: 'cookie-parser'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value must be manually encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private req: RequestCompat;\n  private res: ResponseCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    req,\n    res,\n    cookieAttributes = { maxAge: 180 * 24 * 3600 * 1000 }, // 180 days\n  }: {\n    prefix?: string;\n    req: RequestCompat;\n    res: ResponseCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.req = req;\n    this.res = res;\n    this.cookieAttributes = cookieAttributes;\n  }\n  getAssignmentsSync(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.req) return doc;\n    try {\n      const raw = this.req.cookies[key] || \"{}\";\n      const data = JSON.parse(raw);\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  saveAssignmentsSync(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.res) return;\n    const str = JSON.stringify(doc);\n    this.res.cookie(\n      encodeURIComponent(key),\n      encodeURIComponent(str),\n      this.cookieAttributes\n    );\n  }\n}\n\nexport class BrowserCookieStickyBucketService extends StickyBucketServiceSync {\n  /**\n   * Intended to be used with npm: 'js-cookie'.\n   * Assumes:\n   *  - reading a cookie is automatically decoded via decodeURIComponent() or similar\n   *  - writing a cookie name & value is automatically encoded via encodeURIComponent() or similar\n   *  - all cookie bodies are JSON encoded strings and are manually encoded/decoded\n   */\n  private jsCookie: JsCookiesCompat;\n  private cookieAttributes: CookieAttributes;\n  constructor({\n    prefix = \"gbStickyBuckets__\",\n    jsCookie,\n    cookieAttributes = { expires: 180 }, // 180 days\n  }: {\n    prefix?: string;\n    jsCookie: JsCookiesCompat;\n    cookieAttributes?: CookieAttributes;\n  }) {\n    super();\n    this.prefix = prefix;\n    this.jsCookie = jsCookie;\n    this.cookieAttributes = cookieAttributes;\n  }\n  getAssignmentsSync(attributeName: string, attributeValue: string) {\n    const key = this.getKey(attributeName, attributeValue);\n    let doc: StickyAssignmentsDocument | null = null;\n    if (!this.jsCookie) return doc;\n    try {\n      const raw = this.jsCookie.get(key);\n      const data = JSON.parse(raw || \"{}\");\n      if (data.attributeName && data.attributeValue && data.assignments) {\n        doc = data;\n      }\n    } catch (e) {\n      // Ignore cookie errors\n    }\n    return doc;\n  }\n  async saveAssignmentsSync(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.jsCookie) return;\n    const str = JSON.stringify(doc);\n    this.jsCookie.set(key, str, this.cookieAttributes);\n  }\n}\n\nexport class RedisStickyBucketService extends StickyBucketService {\n  /** Intended to be used with npm: 'ioredis'. **/\n  private redis: IORedisCompat | undefined;\n  constructor({ redis }: { redis: IORedisCompat }) {\n    super();\n    this.redis = redis;\n  }\n  async getAllAssignments(\n    attributes: Record<string, string>\n  ): Promise<Record<StickyAttributeKey, StickyAssignmentsDocument>> {\n    const docs: Record<StickyAttributeKey, StickyAssignmentsDocument> = {};\n    const keys = Object.entries(\n      attributes\n    ).map(([attributeName, attributeValue]) =>\n      getStickyBucketAttributeKey(attributeName, attributeValue)\n    );\n    if (!this.redis) return docs;\n    await this.redis.mget(...keys).then((values) => {\n      values.forEach((raw) => {\n        try {\n          const data = JSON.parse(raw || \"{}\");\n          if (\n            data.attributeName &&\n            \"attributeValue\" in data &&\n            data.assignments\n          ) {\n            const key = getStickyBucketAttributeKey(\n              data.attributeName,\n              toString(data.attributeValue)\n            );\n            docs[key] = data;\n          }\n        } catch (e) {\n          // ignore redis doc parse errors\n        }\n      });\n    });\n    return docs;\n  }\n  async getAssignments(_attributeName: string, _attributeValue: string) {\n    // not implemented\n    return null;\n  }\n  async saveAssignments(doc: StickyAssignmentsDocument) {\n    const key = this.getKey(doc.attributeName, doc.attributeValue);\n    if (!this.redis) return;\n    await this.redis.set(key, JSON.stringify(doc));\n  }\n}\n","import type { GrowthBook } from \"../GrowthBook\";\nimport type {\n  UserScopedGrowthBook,\n  GrowthBookClient,\n} from \"../GrowthBookClient\";\n\nexport type AutoAttributeSettings = {\n  uuidCookieName?: string;\n  uuidKey?: string;\n  uuid?: string;\n  uuidAutoPersist?: boolean;\n};\n\nfunction getBrowserDevice(ua: string): { browser: string; deviceType: string } {\n  const browser = ua.match(/Edg/)\n    ? \"edge\"\n    : ua.match(/Chrome/)\n    ? \"chrome\"\n    : ua.match(/Firefox/)\n    ? \"firefox\"\n    : ua.match(/Safari/)\n    ? \"safari\"\n    : \"unknown\";\n\n  const deviceType = ua.match(/Mobi/) ? \"mobile\" : \"desktop\";\n\n  return { browser, deviceType };\n}\n\nfunction getURLAttributes(url: URL | Location | undefined) {\n  if (!url) return {};\n  return {\n    url: url.href,\n    path: url.pathname,\n    host: url.host,\n    query: url.search,\n  };\n}\n\nexport function autoAttributesPlugin(settings: AutoAttributeSettings = {}) {\n  // Browser only\n  if (typeof window === \"undefined\") {\n    throw new Error(\"autoAttributesPlugin only works in the browser\");\n  }\n\n  const COOKIE_NAME = settings.uuidCookieName || \"gbuuid\";\n  const uuidKey = settings.uuidKey || \"id\";\n  let uuid = settings.uuid || \"\";\n  function persistUUID() {\n    setCookie(COOKIE_NAME, uuid);\n  }\n  function getUUID() {\n    // Already stored in memory, return\n    if (uuid) return uuid;\n\n    // If cookie is already set, return\n    uuid = getCookie(COOKIE_NAME);\n    if (uuid) return uuid;\n\n    // Generate a new UUID\n    uuid = genUUID(window.crypto);\n    return uuid;\n  }\n\n  // Listen for a custom event to persist the UUID cookie\n  document.addEventListener(\"growthbookpersist\", () => {\n    persistUUID();\n  });\n\n  function getAutoAttributes(settings: AutoAttributeSettings) {\n    const ua = navigator.userAgent;\n\n    const _uuid = getUUID();\n\n    // If a uuid is provided, default persist to false, otherwise default to true\n    if (settings.uuidAutoPersist ?? !settings.uuid) {\n      persistUUID();\n    }\n\n    const url = location;\n\n    return {\n      ...getDataLayerVariables(),\n      [uuidKey]: _uuid,\n      ...getURLAttributes(url),\n      pageTitle: document.title,\n      ...getBrowserDevice(ua),\n      ...getUtmAttributes(url),\n    };\n  }\n\n  return (gb: GrowthBook | UserScopedGrowthBook | GrowthBookClient) => {\n    // Only works for instances with user attributes\n    if (\"createScopedInstance\" in gb) {\n      return;\n    }\n\n    // Set initial attributes\n    const attributes = getAutoAttributes(settings);\n    attributes.url && gb.setURL(attributes.url);\n    gb.updateAttributes(attributes);\n\n    // Poll for URL changes and update GrowthBook\n    let currentUrl = attributes.url;\n    const intervalTimer = setInterval(() => {\n      if (location.href !== currentUrl) {\n        currentUrl = location.href;\n        gb.setURL(currentUrl);\n        gb.updateAttributes(getAutoAttributes(settings));\n      }\n    }, 500);\n\n    // Listen for a custom event to update URL and attributes\n    const refreshListener = () => {\n      if (location.href !== currentUrl) {\n        currentUrl = location.href;\n        gb.setURL(currentUrl);\n      }\n      gb.updateAttributes(getAutoAttributes(settings));\n    };\n    document.addEventListener(\"growthbookrefresh\", refreshListener);\n\n    if (\"onDestroy\" in gb) {\n      gb.onDestroy(() => {\n        clearInterval(intervalTimer);\n        document.removeEventListener(\"growthbookrefresh\", refreshListener);\n      });\n    }\n  };\n}\n\nfunction setCookie(name: string, value: string) {\n  const d = new Date();\n  const COOKIE_DAYS = 400; // 400 days is the max cookie duration for chrome\n  d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * COOKIE_DAYS);\n  document.cookie = name + \"=\" + value + \";path=/;expires=\" + d.toUTCString();\n}\n\nfunction getCookie(name: string): string {\n  const value = \"; \" + document.cookie;\n  const parts = value.split(`; ${name}=`);\n  return parts.length === 2 ? parts[1].split(\";\")[0] : \"\";\n}\n\n// Use the browsers crypto.randomUUID if set to generate a UUID\nfunction genUUID(crypto?: Crypto) {\n  if (crypto && crypto.randomUUID) return crypto.randomUUID();\n  return (\"\" + 1e7 + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, (c) => {\n    const n =\n      crypto && crypto.getRandomValues\n        ? crypto.getRandomValues(new Uint8Array(1))[0]\n        : Math.floor(Math.random() * 256);\n    return (\n      ((c as unknown) as number) ^\n      (n & (15 >> (((c as unknown) as number) / 4)))\n    ).toString(16);\n  });\n}\n\nfunction getUtmAttributes(url: URL | Location | undefined) {\n  // Store utm- params in sessionStorage for future page loads\n  let utms: Record<string, string> = {};\n  try {\n    const existing = sessionStorage.getItem(\"utm_params\");\n    if (existing) {\n      utms = JSON.parse(existing);\n    }\n  } catch (e) {\n    // Do nothing if sessionStorage is disabled (e.g. incognito window)\n  }\n\n  // Add utm params from querystring\n  if (url && url.search) {\n    const params = new URLSearchParams(url.search);\n    let hasChanges = false;\n    [\"source\", \"medium\", \"campaign\", \"term\", \"content\"].forEach((k) => {\n      // Querystring is in snake_case\n      const param = `utm_${k}`;\n      // Attribute keys are camelCase\n      const attr = `utm` + k[0].toUpperCase() + k.slice(1);\n\n      if (params.has(param)) {\n        utms[attr] = params.get(param) || \"\";\n        hasChanges = true;\n      }\n    });\n\n    // Write back to sessionStorage\n    if (hasChanges) {\n      try {\n        sessionStorage.setItem(\"utm_params\", JSON.stringify(utms));\n      } catch (e) {\n        // Do nothing if sessionStorage is disabled (e.g. incognito window)\n      }\n    }\n  }\n\n  return utms;\n}\n\nfunction getDataLayerVariables() {\n  if (\n    typeof window === \"undefined\" ||\n    !window.dataLayer ||\n    !window.dataLayer.forEach\n  ) {\n    return {};\n  }\n\n  const obj: Record<string, unknown> = {};\n  window.dataLayer.forEach((item: unknown) => {\n    // Skip empty and non-object entries\n    if (!item || typeof item !== \"object\" || \"length\" in item) return;\n\n    // Skip events\n    if (\"event\" in item) return;\n\n    Object.keys(item).forEach((k) => {\n      // Filter out known properties that aren't useful\n      if (typeof k !== \"string\" || k.match(/^(gtm)/)) return;\n\n      const val = (item as Record<string, unknown>)[k];\n\n      // Only add primitive variable values\n      const valueType = typeof val;\n      if ([\"string\", \"number\", \"boolean\"].includes(valueType)) {\n        obj[k] = val;\n      }\n    });\n  });\n  return obj;\n}\n","import { loadSDKVersion } from \"../util\";\nimport type { Attributes, EventProperties } from \"../types/growthbook\";\nimport type { GrowthBook } from \"../GrowthBook\";\nimport type {\n  GrowthBookClient,\n  UserScopedGrowthBook,\n} from \"../GrowthBookClient\";\nimport { EVENT_EXPERIMENT_VIEWED, EVENT_FEATURE_EVALUATED } from \"../core\";\n\nconst SDK_VERSION = loadSDKVersion();\n\ntype GlobalTrackedEvent = {\n  eventName: string;\n  properties: Record<string, unknown>;\n};\ndeclare global {\n  interface Window {\n    gbEvents?:\n      | (GlobalTrackedEvent | string)[]\n      | {\n          push: (event: GlobalTrackedEvent | string) => void;\n        };\n  }\n}\n\ntype EventPayload = {\n  event_name: string;\n  properties_json: Record<string, unknown>;\n  sdk_language: string;\n  sdk_version: string;\n  url: string;\n  context_json: Record<string, unknown>;\n  user_id: string | null;\n  device_id: string | null;\n  page_id: string | null;\n  session_id: string | null;\n  page_title?: string;\n  utm_source?: string;\n  utm_medium?: string;\n  utm_campaign?: string;\n  utm_term?: string;\n  utm_content?: string;\n};\n\nfunction parseString(value: unknown): null | string {\n  return typeof value === \"string\" ? value : null;\n}\n\nfunction parseAttributes(\n  attributes: Attributes\n): {\n  nested: Attributes;\n  topLevel: {\n    user_id: string | null;\n    device_id: string | null;\n    page_id: string | null;\n    session_id: string | null;\n    page_title?: string;\n    utm_source?: string;\n    utm_medium?: string;\n    utm_campaign?: string;\n    utm_term?: string;\n    utm_content?: string;\n  };\n} {\n  const {\n    user_id,\n    device_id,\n    anonymous_id,\n    id,\n    page_id,\n    session_id,\n    utmCampaign,\n    utmContent,\n    utmMedium,\n    utmSource,\n    utmTerm,\n    pageTitle,\n    ...nested\n  } = attributes;\n\n  return {\n    nested,\n    topLevel: {\n      user_id: parseString(user_id),\n      device_id: parseString(device_id || anonymous_id || id),\n      page_id: parseString(page_id),\n      session_id: parseString(session_id),\n      utm_campaign: parseString(utmCampaign) || undefined,\n      utm_content: parseString(utmContent) || undefined,\n      utm_medium: parseString(utmMedium) || undefined,\n      utm_source: parseString(utmSource) || undefined,\n      utm_term: parseString(utmTerm) || undefined,\n      page_title: parseString(pageTitle) || undefined,\n    },\n  };\n}\n\ntype EventData = {\n  eventName: string;\n  properties: EventProperties;\n  attributes: Attributes;\n  url: string;\n};\n\nfunction getEventPayload({\n  eventName,\n  properties,\n  attributes,\n  url,\n}: EventData): EventPayload {\n  const { nested, topLevel } = parseAttributes(attributes || {});\n\n  return {\n    event_name: eventName,\n    properties_json: properties || {},\n    ...topLevel,\n    sdk_language: \"js\",\n    sdk_version: SDK_VERSION,\n    url: url,\n    context_json: nested,\n  };\n}\n\nasync function track({\n  clientKey,\n  ingestorHost,\n  events,\n}: {\n  events: EventPayload[];\n  clientKey: string;\n  ingestorHost?: string;\n}) {\n  if (!events.length) return;\n\n  const endpoint = `${\n    ingestorHost || \"https://us1.gb-ingest.com\"\n  }/track?client_key=${clientKey}`;\n  const body = JSON.stringify(events);\n\n  try {\n    await fetch(endpoint, {\n      method: \"POST\",\n      body,\n      headers: {\n        Accept: \"application/json\",\n        \"Content-Type\": \"text/plain\",\n      },\n      credentials: \"omit\",\n    });\n  } catch (e) {\n    console.error(\"Failed to track event\", e);\n  }\n}\n\nexport function growthbookTrackingPlugin({\n  queueFlushInterval = 100,\n  ingestorHost,\n  enable = true,\n  debug,\n  dedupeCacheSize = 1000,\n  dedupeKeyAttributes = [],\n  eventFilter,\n}: {\n  // TODO: add option to allow filtering out certain attributes that contain PII\n  queueFlushInterval?: number;\n  ingestorHost?: string;\n  enable?: boolean;\n  debug?: boolean;\n  dedupeCacheSize?: number;\n  dedupeKeyAttributes?: string[];\n  eventFilter?: (event: EventData) => boolean;\n} = {}) {\n  return (gb: GrowthBook | UserScopedGrowthBook | GrowthBookClient) => {\n    const clientKey = gb.getClientKey();\n    if (!clientKey) {\n      throw new Error(\"clientKey must be specified to use event logging\");\n    }\n\n    // LRU cache for events to avoid duplicates\n    const eventCache = new Set<string>();\n\n    if (\"setEventLogger\" in gb) {\n      let _q: EventPayload[] = [];\n      let timer: NodeJS.Timeout | null = null;\n      const flush = async () => {\n        const events = _q;\n        _q = [];\n        timer && clearTimeout(timer);\n        timer = null;\n        events.length && (await track({ clientKey, events, ingestorHost }));\n      };\n\n      let promise: Promise<void> | null = null;\n      gb.setEventLogger(async (eventName, properties, userContext) => {\n        const data: EventData = {\n          eventName,\n          properties,\n          attributes: userContext.attributes || {},\n          url: userContext.url || \"\",\n        };\n\n        // Skip logging if the event is being filtered\n        if (eventFilter && !eventFilter(data)) {\n          return;\n        }\n\n        // De-dupe Feature Evaluated and Experiment Viewed events\n        if (\n          eventName === EVENT_FEATURE_EVALUATED ||\n          eventName === EVENT_EXPERIMENT_VIEWED\n        ) {\n          // Build the key for de-duping\n          const dedupeKeyData: Record<string, unknown> = {\n            eventName,\n            properties,\n          };\n          for (const key of dedupeKeyAttributes) {\n            dedupeKeyData[\"attr:\" + key] = data.attributes[key];\n          }\n\n          const k = JSON.stringify(dedupeKeyData);\n          // Duplicate event fired recently, move to end of LRU cache and skip\n          if (eventCache.has(k)) {\n            eventCache.delete(k);\n            eventCache.add(k);\n            return;\n          }\n          eventCache.add(k);\n\n          // If the cache is too big, remove the oldest item\n          if (eventCache.size > dedupeCacheSize) {\n            const oldest = eventCache.values().next().value;\n            oldest && eventCache.delete(oldest);\n          }\n        }\n\n        const payload = getEventPayload(data);\n\n        debug &&\n          console.log(\n            \"Logging event to GrowthBook\",\n            JSON.parse(JSON.stringify(payload))\n          );\n        if (!enable) return;\n\n        _q.push(payload);\n\n        // Only one in-progress promise at a time\n        if (!promise) {\n          promise = new Promise((resolve, reject) => {\n            // Flush the queue after a delay\n            timer = setTimeout(() => {\n              flush().then(resolve).catch(reject);\n              promise = null;\n            }, queueFlushInterval);\n          });\n        }\n        await promise;\n      });\n\n      // Flush the queue on page unload\n      if (typeof document !== \"undefined\" && document.visibilityState) {\n        document.addEventListener(\"visibilitychange\", () => {\n          if (document.visibilityState === \"hidden\") {\n            flush().catch(console.error);\n          }\n        });\n      }\n\n      // Flush the queue when the growthbook instance is destroyed\n      \"onDestroy\" in gb &&\n        gb.onDestroy(() => {\n          flush().catch(console.error);\n        });\n    }\n\n    // Listen on window.gbEvents.push if in a browser\n    // This makes it easier to integrate with Segment, GTM, etc.\n    if (typeof window !== \"undefined\" && !(\"createScopedInstance\" in gb)) {\n      const prevEvents = Array.isArray(window.gbEvents) ? window.gbEvents : [];\n      window.gbEvents = {\n        push: (event: GlobalTrackedEvent | string) => {\n          if (\"isDestroyed\" in gb && gb.isDestroyed()) {\n            // If trying to log and the instance has been destroyed, switch back to just an array\n            // This will let the next GrowthBook instance pick it up\n            window.gbEvents = [event];\n            return;\n          }\n\n          if (typeof event === \"string\") {\n            gb.logEvent(event);\n          } else if (event) {\n            gb.logEvent(event.eventName, event.properties);\n          }\n        },\n      };\n      for (const event of prevEvents) {\n        window.gbEvents.push(event);\n      }\n    }\n  };\n}\n","import Cookies from \"js-cookie\";\nimport {\n  CacheSettings,\n  Options as Context,\n  FeatureApiResponse,\n  Plugin,\n  TrackingCallback,\n} from \"./types/growthbook\";\nimport { GrowthBook } from \"./GrowthBook\";\nimport {\n  BrowserCookieStickyBucketService,\n  LocalStorageStickyBucketService,\n  StickyBucketService,\n} from \"./sticky-bucket-service\";\nimport { autoAttributesPlugin } from \"./plugins/auto-attributes\";\nimport { growthbookTrackingPlugin } from \"./plugins/growthbook-tracking\";\nimport {\n  thirdPartyTrackingPlugin,\n  Trackers,\n} from \"./plugins/third-party-tracking\";\n\ntype WindowContext = Context & {\n  uuidCookieName?: string;\n  uuidKey?: string;\n  uuid?: string;\n  persistUuidOnLoad?: boolean;\n  noStreaming?: boolean;\n  useStickyBucketService?: \"cookie\" | \"localStorage\";\n  stickyBucketPrefix?: string;\n  payload?: FeatureApiResponse;\n  cacheSettings?: CacheSettings;\n  antiFlicker?: boolean;\n  antiFlickerTimeout?: number;\n  additionalTrackingCallback?: TrackingCallback;\n};\ndeclare global {\n  interface Window {\n    _growthbook?: GrowthBook;\n    growthbook_queue?:\n      | Array<(gb: GrowthBook) => void>\n      | { push: (cb: (gb: GrowthBook) => void) => void };\n    growthbook_config?: WindowContext;\n    dataLayer?: unknown[];\n    analytics?: {\n      track?: (name: string, props?: Record<string, unknown>) => void;\n    };\n    gtag?: (...args: unknown[]) => void;\n  }\n}\n\n// Ensure dataLayer exists\nwindow.dataLayer = window.dataLayer || [];\n\nconst currentScript = document.currentScript;\nconst dataContext: DOMStringMap = currentScript ? currentScript.dataset : {};\nconst windowContext: WindowContext = window.growthbook_config || {};\n\nlet antiFlickerTimeout: number | undefined;\n\nfunction setAntiFlicker() {\n  window.clearTimeout(antiFlickerTimeout);\n\n  let timeoutMs =\n    windowContext.antiFlickerTimeout ??\n    (dataContext.antiFlickerTimeout\n      ? parseInt(dataContext.antiFlickerTimeout)\n      : null) ??\n    3500;\n  if (!isFinite(timeoutMs)) {\n    timeoutMs = 3500;\n  }\n\n  try {\n    if (!document.getElementById(\"gb-anti-flicker-style\")) {\n      const styleTag = document.createElement(\"style\");\n      styleTag.setAttribute(\"id\", \"gb-anti-flicker-style\");\n      styleTag.innerHTML =\n        \".gb-anti-flicker { opacity: 0 !important; pointer-events: none; }\";\n      document.head.appendChild(styleTag);\n    }\n    document.documentElement.classList.add(\"gb-anti-flicker\");\n\n    // Fallback if GrowthBook fails to load in specified time or 3.5 seconds.\n    antiFlickerTimeout = window.setTimeout(unsetAntiFlicker, timeoutMs);\n  } catch (e) {\n    console.error(e);\n  }\n}\n\nfunction unsetAntiFlicker() {\n  window.clearTimeout(antiFlickerTimeout);\n  try {\n    document.documentElement.classList.remove(\"gb-anti-flicker\");\n  } catch (e) {\n    console.error(e);\n  }\n}\n\nif (windowContext.antiFlicker || dataContext.antiFlicker) {\n  setAntiFlicker();\n}\n\n// Create sticky bucket service\nlet stickyBucketService: StickyBucketService | undefined = undefined;\nif (\n  windowContext.useStickyBucketService === \"cookie\" ||\n  dataContext.useStickyBucketService === \"cookie\"\n) {\n  stickyBucketService = new BrowserCookieStickyBucketService({\n    prefix:\n      windowContext.stickyBucketPrefix ||\n      dataContext.stickyBucketPrefix ||\n      undefined,\n    jsCookie: Cookies,\n  });\n} else if (\n  windowContext.useStickyBucketService === \"localStorage\" ||\n  dataContext.useStickyBucketService === \"localStorage\"\n) {\n  stickyBucketService = new LocalStorageStickyBucketService({\n    prefix:\n      windowContext.stickyBucketPrefix ||\n      dataContext.stickyBucketPrefix ||\n      undefined,\n  });\n}\n\nconst uuid = dataContext.uuid || windowContext.uuid;\nconst plugins: Plugin[] = [\n  autoAttributesPlugin({\n    uuid,\n    uuidCookieName: windowContext.uuidCookieName || dataContext.uuidCookieName,\n    uuidKey: windowContext.uuidKey || dataContext.uuidKey,\n    uuidAutoPersist: !uuid && dataContext.noAutoCookies == null,\n  }),\n];\n\nconst tracking = dataContext.tracking || \"gtag,gtm,segment\";\nif (tracking !== \"none\") {\n  const trackers = tracking\n    .toLowerCase()\n    .split(\",\")\n    .map((t) => t.trim());\n\n  if (trackers.includes(\"growthbook\")) {\n    plugins.push(\n      growthbookTrackingPlugin({\n        ingestorHost: dataContext.eventIngestorHost,\n      })\n    );\n  }\n\n  if (!windowContext.trackingCallback) {\n    plugins.push(\n      thirdPartyTrackingPlugin({\n        additionalCallback: windowContext.additionalTrackingCallback,\n        trackers: trackers as Trackers[],\n      })\n    );\n  }\n}\n\n// Create GrowthBook instance\nconst gb = new GrowthBook({\n  enableDevMode: true,\n  ...dataContext,\n  remoteEval: !!dataContext.remoteEval,\n  ...windowContext,\n  plugins,\n  stickyBucketService,\n});\n\n// Set the renderer to fire a custom DOM event\n// This will let us attach multiple listeners\ngb.setRenderer(() => {\n  document.dispatchEvent(new CustomEvent(\"growthbookdata\"));\n});\n\ngb.init({\n  payload: windowContext.payload,\n  streaming: !(\n    windowContext.noStreaming ||\n    dataContext.noStreaming ||\n    windowContext.backgroundSync === false\n  ),\n  cacheSettings: windowContext.cacheSettings,\n}).then(() => {\n  if (!(windowContext.antiFlicker || dataContext.antiFlicker)) return;\n\n  if (gb.getRedirectUrl()) {\n    setAntiFlicker();\n  } else {\n    unsetAntiFlicker();\n  }\n});\n\nconst fireCallback = (cb: (gb: GrowthBook) => void) => {\n  try {\n    cb && cb(gb);\n  } catch (e) {\n    console.error(\"Uncaught growthbook_queue error\", e);\n  }\n};\n\n// Process any queued callbacks\nif (window.growthbook_queue) {\n  if (Array.isArray(window.growthbook_queue)) {\n    window.growthbook_queue.forEach((cb) => {\n      fireCallback(cb);\n    });\n  }\n}\n// Replace the queue with a function that immediately calls the callback\nwindow.growthbook_queue = {\n  push: (cb: (gb: GrowthBook) => void) => {\n    fireCallback(cb);\n  },\n};\n\n// Store a reference in window to enable more advanced use cases\nexport default gb;\n","import type { TrackingCallback } from \"../types/growthbook\";\nimport type { GrowthBook } from \"../GrowthBook\";\nimport type {\n  GrowthBookClient,\n  UserScopedGrowthBook,\n} from \"../GrowthBookClient\";\n\nexport type Trackers = \"gtag\" | \"gtm\" | \"segment\";\n\nexport function thirdPartyTrackingPlugin({\n  additionalCallback,\n  trackers = [\"gtag\", \"gtm\", \"segment\"],\n}: {\n  additionalCallback?: TrackingCallback;\n  trackers?: Trackers[];\n} = {}) {\n  // Browser only\n  if (typeof window === \"undefined\") {\n    throw new Error(\"thirdPartyTrackingPlugin only works in the browser\");\n  }\n\n  return (gb: GrowthBook | UserScopedGrowthBook | GrowthBookClient) => {\n    gb.setTrackingCallback(async (e, r) => {\n      const promises: Promise<unknown>[] = [];\n      const eventParams = { experiment_id: e.key, variation_id: r.key };\n\n      if (additionalCallback) {\n        promises.push(Promise.resolve(additionalCallback(e, r)));\n      }\n\n      // GA4 - gtag\n      if (trackers.includes(\"gtag\") && window.gtag) {\n        let gtagResolve;\n        const gtagPromise = new Promise((resolve) => {\n          gtagResolve = resolve;\n        });\n        promises.push(gtagPromise);\n        window.gtag(\"event\", \"experiment_viewed\", {\n          ...eventParams,\n          event_callback: gtagResolve,\n        });\n      }\n\n      // GTM - dataLayer\n      if (trackers.includes(\"gtm\") && window.dataLayer) {\n        let datalayerResolve;\n        const datalayerPromise = new Promise((resolve) => {\n          datalayerResolve = resolve;\n        });\n        promises.push(datalayerPromise);\n        window.dataLayer.push({\n          event: \"experiment_viewed\",\n          ...eventParams,\n          eventCallback: datalayerResolve,\n        });\n      }\n\n      // Segment - analytics.js\n      if (\n        trackers.includes(\"segment\") &&\n        window.analytics &&\n        window.analytics.track\n      ) {\n        window.analytics.track(\"Experiment Viewed\", eventParams);\n        const segmentPromise = new Promise((resolve) =>\n          window.setTimeout(resolve, 300)\n        );\n        promises.push(segmentPromise);\n      }\n\n      await Promise.all(promises);\n    });\n  };\n}\n"],"names":["assign","target","i","arguments","length","source","key","api","init","converter","defaultAttributes","set","name","value","attributes","document","expires","Date","now","toUTCString","encodeURIComponent","replace","decodeURIComponent","escape","stringifiedAttributes","attributeName","split","cookie","write","Object","create","get","cookies","jar","parts","slice","join","found","read","e","remove","withAttributes","this","withConverter","freeze","path","validAttributeName","nullController","revert","elements","Map","mutations","Set","getElementRecord","element","record","createElementPropertyRecord","el","attr","getCurrentValue","setValue","mutationRunner","currentValue","isDirty","originalValue","virtualValue","_positionTimeout","observer","MutationObserver","setTimeout","parentNode","insertBeforeNode","observe","childList","subtree","characterData","attributeFilter","getObserverInit","queueIfNeeded","val","currentVal","runDOMUpdates","htmlMutationRunner","forEach","m","mutate","html","transformContainer","createElement","innerHTML","getTransformedHTML","classMutationRunner","filter","Boolean","Array","from","attrMutationRunner","positionMutationRunner","newNodes","_ref","parentSelector","insertBeforeSelector","querySelector","_loadDOMNodes","getHTMLValue","setHTMLValue","getElementHTMLRecord","elementRecord","getElementPosition","parentElement","nextElementSibling","setElementPosition","contains","insertBefore","getElementPositionRecord","position","setClassValue","className","removeAttribute","getClassValue","getElementClassRecord","classes","getElementAttributeRecord","attrName","_el$getAttribute","getAttribute","setAttribute","setAttrValue","setPropertyValue","_element$html","_element$html$observe","disconnect","_element$classes","_element$classes$obse","_element$position","_element$position$obs","_element$attributes","_element$attributes$a","_element$attributes$a2","deleteElementPropertyRecord","keys","refreshElementsSet","mutation","kind","size","existingElements","querySelectorAll","selector","has","add","attribute","push","startMutating","refreshAllElementSets","newMutation","index","indexOf","splice","stopMutating","clear","test","classnames","mutatedClassnames","c","documentElement","polyfills","fetch","globalThis","bind","undefined","SubtleCrypto","crypto","subtle","EventSource","hashFnv32a","str","hval","l","charCodeAt","hash","seed","version","inRange","n","range","getUrlRegExp","regexString","escaped","RegExp","console","error","isURLTargeted","url","targets","hasIncludeRules","isIncluded","match","_evalURLTarget","type","pattern","include","parsed","URL","regex","href","substring","origin","actual","expected","comps","host","pathname","searchParams","v","k","some","data","isPath","_evalSimpleUrlPart","_evalSimpleUrlTarget","base64ToBuf","b","Uint8Array","atob","async","decrypt","encryptedString","decryptionKey","Error","importKey","iv","cipherText","plainTextBuffer","TextDecoder","decode","toString","input","JSON","stringify","paddedVersionString","map","padStart","loadSDKVersion","isObj","x","getAutoExperimentChangeType","exp","urlPatterns","variations","variation","domMutations","promiseTimeout","promise","timeout","Promise","resolve","timer","resolved","finish","clearTimeout","then","catch","cacheSettings","staleTTL","maxAge","cacheKey","backgroundSync","maxEntries","disableIdleStreams","idleStreamInterval","disableCache","helpers","fetchFeaturesCall","clientKey","headers","fetchRemoteEvalCall","_ref2","payload","options","method","body","eventSourceCall","_ref3","startIdleListener","idleTimeout","window","onVisibilityChange","visibilityState","streams","channel","state","enableChannel","onHidden","addEventListener","removeEventListener","stopIdleListener","localStorage","subscribedInstances","cacheInitialized","cache","activeFetches","supportsSSE","disableChannel","updatePersistentCache","setItem","entries","getKey","instance","apiHost","getApiInfo","getCacheKey","baseKey","isRemoteEval","getAttributes","cacheKeyAttributes","getCacheKeyAttributes","ca","fv","getForcedVariations","getUrl","cleanupCache","entriesWithTimestamps","_ref7","staleAt","getTime","sort","a","entriesToRemoveCount","Math","min","max","delete","onNewFeatureData","dateUpdated","existing","sse","instances","setPayload","getPayload","refreshInstance","fetchFeatures","apiRequestHeaders","getApiHosts","getClientKey","remoteEval","forcedVariations","forcedFeatures","getForcedFeatures","res","ok","status","json","startAutoRefresh","success","forceSSE","streamingHost","streamingHostRequestHeaders","src","cb","event","parse","errors","onSSEError","readyState","delay","pow","random","includes","onopen","onerror","close","destroyChannel","startStreaming","streaming","subs","subscribe","_regexCache","evalCondition","obj","condition","savedGroups","evalOr","evalAnd","evalConditionValue","getPath","current","isArray","isOperatorObject","op","evalOperatorCondition","isIn","operator","check","elemMatch","passed","j","t","getType","conditions","EVENT_FEATURE_EVALUATED","EVENT_EXPERIMENT_VIEWED","safeCall","fn","onExperimentViewed","ctx","experiment","result","user","trackedExperiments","getExperimentDedupeKey","enableDevMode","devLogs","timestamp","logType","calls","global","trackingCallback","eventLogger","experimentId","variationId","hashAttribute","hashValue","evalFeature","id","stack","evaluatedFeatures","getFeatureResult","forcedValues","ret","forcedFeatureValues","getForcedFeatureValues","features","feature","rules","rule","parentConditions","parentCondition","parentResult","gate","filters","isFilteredOut","conditionPasses","isIncludedInRollout","saveStickyBucketAssignmentDoc","disableStickyBucketing","fallbackAttribute","coverage","hashVersion","tracks","saveDeferredTrack","force","weights","bucketVersion","minBucketVersion","namespace","meta","ranges","phase","runExperiment","onExperimentEval","inExperiment","passthrough","defaultValue","featureId","numVariations","getExperimentResult","enabled","o","overrides","mergeOverrides","qsOverride","search","kv","parseInt","getQueryStringOverride","active","getHashAttribute","assigned","foundStickyBucket","stickyBucketVersionIsBlocked","versionIsBlocked","expKey","expBucketVersion","expHashAttribute","expFallbackAttribute","expMinBucketVersion","expMeta","getStickyBucketExperimentKey","assignments","stickyBucketAssignmentDocs","hashKey","getStickyBucketAttributeKey","fallbackValue","fallbackKey","getStickyBucketAssignments","variationKey","findIndex","getStickyBucketVariation","inNamespace","groups","expGroups","hasGroupOverlap","urlRegex","pathOnly","urlIsValid","chooseVariation","equal","fill","totalWeight","reduce","w","sum","cumulative","start","getBucketRanges","qaMode","changed","attrKey","doc","attributeValue","existingAssignments","newAssignments","generateStickyBucketAssignmentDoc","trackingCalls","trackingCall","all","changeId","recordChangeId","ruleId","on","off","experimentResult","trackedFeatureUsage","stringifiedValue","featureKey","onFeatureUsage","attributeOverrides","r","variationIndex","hashUsed","bucket","stickyBucketUsed","fallback","experimentKey","experimentBucketVersion","getStickyBucketAttributes","stickyBucketIdentifierAttributes","experiments","deriveStickyBucketIdentifierAttributes","isBrowser","SDK_VERSION","StickyBucketService","constructor","opts","prefix","docs","getAssignments","StickyBucketServiceSync","getAssignmentsSync","saveAssignmentsSync","getAllAssignmentsSync","getBrowserDevice","ua","browser","deviceType","getURLAttributes","query","setCookie","d","setTime","getCookie","genUUID","randomUUID","getRandomValues","floor","getUtmAttributes","utms","sessionStorage","getItem","params","URLSearchParams","hasChanges","param","toUpperCase","getDataLayerVariables","dataLayer","item","parseString","getEventPayload","eventName","properties","nested","topLevel","user_id","device_id","anonymous_id","page_id","session_id","utmCampaign","utmContent","utmMedium","utmSource","utmTerm","pageTitle","utm_campaign","utm_content","utm_medium","utm_source","utm_term","page_title","parseAttributes","event_name","properties_json","sdk_language","sdk_version","context_json","track","ingestorHost","events","endpoint","Accept","credentials","currentScript","dataContext","dataset","windowContext","growthbook_config","antiFlickerTimeout","stickyBucketService","setAntiFlicker","timeoutMs","isFinite","getElementById","styleTag","head","appendChild","classList","unsetAntiFlicker","antiFlicker","useStickyBucketService","_ref4","jsCookie","cookieAttributes","super","raw","stickyBucketPrefix","Cookies","uuid","plugins","settings","COOKIE_NAME","uuidCookieName","uuidKey","persistUUID","getUUID","getAutoAttributes","navigator","userAgent","_uuid","uuidAutoPersist","location","title","gb","setURL","updateAttributes","currentUrl","intervalTimer","setInterval","refreshListener","onDestroy","clearInterval","autoAttributesPlugin","noAutoCookies","tracking","trackers","toLowerCase","trim","queueFlushInterval","enable","debug","dedupeCacheSize","dedupeKeyAttributes","eventFilter","eventCache","_q","flush","setEventLogger","userContext","dedupeKeyData","oldest","values","next","log","reject","prevEvents","gbEvents","isDestroyed","logEvent","growthbookTrackingPlugin","eventIngestorHost","additionalCallback","setTrackingCallback","promises","eventParams","experiment_id","variation_id","gtag","gtagResolve","gtagPromise","event_callback","datalayerResolve","datalayerPromise","eventCallback","analytics","segmentPromise","thirdPartyTrackingPlugin","additionalTrackingCallback","_options","context","_renderer","renderer","_trackedExperiments","_completedChangeIds","_trackedFeatures","_subscriptions","ready","_assigned","_activeAutoExperiments","_triggeredExpKeys","_initialized","_redirectedUrl","_deferredTrackingCalls","_autoExperimentsAllowed","disableExperimentsOnLoad","_destroyCallbacks","logs","_saveDeferredTrack","_fireSubscriptions","_recordChangedId","isGbHost","hostname","s","_saveStickyBucketAssignmentDoc","saveAssignments","plugin","_growthbook","dispatchEvent","Event","_updateAllAutoExperiments","refreshStickyBuckets","_payload","encryptedFeatures","encryptedExperiments","encryptedSavedGroups","decryptPayload","_decryptedPayload","_render","initSync","generateStickyBucketAssignmentDocsSync","_refresh","allowStale","skipCache","autoRefresh","subscribeToChanges","defaultHost","apiHostRequestHeaders","getFeatures","getExperiments","getDecryptedPayload","_ref5","minStaleAt","_ref6","cleanupFn","initializeCache","fetchFeaturesWithCache","refreshFeatures","setFeatures","featuresJSON","setExperiments","experimentsJSON","_refreshForRemoteEval","setAttributes","vars","setForcedFeatures","getStickyBucketAssignmentDocs","getCompletedChangeIds","getAllResults","_destroyed","destroy","undo","setRenderer","forceVariation","run","_getEvalContext","triggerExperiment","_runAutoExperiment","triggerAutoExperiments","_getUserContext","_getGlobalContext","blockedChangeIds","_getContextUrl","forceRerun","manual","_isAutoExperimentBlockedByContext","valueHash","_undoActiveAutoExperiment","changeType","urlRedirect","persistQueryString","oldUrl","newUrl","currUrl","redirectUrl","mergeQueryStrings","navigate","_getNavigateFunction","maxNavigateDelay","navigateDelay","applyDomChangesCallback","_applyDOMChanges","prev","isOn","isOff","getFeatureValue","_evalFeature","msg","getDeferredTrackingCalls","setDeferredTrackingCalls","call","callback","fireDeferredTrackingCalls","logger","disableVisualExperiments","disableJsInjection","js","disableUrlRedirectExperiments","disableCrossOriginUrlRedirectExperiments","protocol","getRedirectUrl","changes","css","script","jsInjectionNonce","nonce","action","getAllAssignments","getAllStickyBucketAssignmentDocs","inDevMode","CustomEvent","noStreaming","fireCallback","growthbook_queue"],"mappings":"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"}