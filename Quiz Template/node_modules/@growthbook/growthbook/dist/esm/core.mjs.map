{"version":3,"file":"core.mjs","names":["evalCondition","chooseVariation","decrypt","getBucketRanges","getQueryStringOverride","getUrlRegExp","hash","inNamespace","inRange","isIncluded","isURLTargeted","toString","EVENT_FEATURE_EVALUATED","EVENT_EXPERIMENT_VIEWED","getForcedFeatureValues","ctx","ret","Map","global","forcedFeatureValues","forEach","v","k","set","user","getForcedVariations","forcedVariations","safeCall","fn","e","onExperimentViewed","experiment","result","trackedExperiments","getExperimentDedupeKey","has","add","enableDevMode","devLogs","push","timestamp","Date","now","logType","calls","trackingCallback","cb","eventLogger","experimentId","key","variationId","hashAttribute","hashValue","onFeatureUsage","trackedFeatureUsage","stringifiedValue","JSON","stringify","value","featureKey","feature","source","ruleId","experimentResult","evalFeature","id","stack","evaluatedFeatures","process","env","NODE_ENV","log","from","to","getFeatureResult","forcedValues","get","features","rules","Set","rule","parentConditions","parentCondition","parentResult","evalObj","evaled","condition","gate","filters","isFilteredOut","conditionPasses","isIncludedInRollout","seed","saveStickyBucketAssignmentDoc","disableStickyBucketing","fallbackAttribute","undefined","range","coverage","hashVersion","tracks","t","length","saveDeferredTrack","force","variations","exp","weights","bucketVersion","minBucketVersion","namespace","meta","ranges","name","phase","runExperiment","onExperimentEval","inExperiment","passthrough","defaultValue","featureId","numVariations","getExperimentResult","enabled","mergeOverrides","urlPatterns","url","qsOverride","variation","status","active","getHashAttribute","assigned","foundStickyBucket","stickyBucketVersionIsBlocked","versionIsBlocked","getStickyBucketVariation","expKey","expBucketVersion","expHashAttribute","expFallbackAttribute","expMinBucketVersion","expMeta","include","groups","hasGroupOverlap","urlIsValid","n","qaMode","changed","attrKey","doc","generateStickyBucketAssignmentDoc","getStickyBucketExperimentKey","stickyBucketAssignmentDocs","trackingCalls","trackingCall","Promise","all","then","changeId","recordChangeId","on","off","getAttributes","attributes","attributeOverrides","savedGroups","some","filter","attribute","r","variationIndex","hashUsed","bucket","stickyBucketUsed","res","o","overrides","Object","assign","attr","fallback","urlRegex","pathOnly","replace","test","expGroups","i","assignments","getStickyBucketAssignments","blockedKey","variationKey","findIndex","m","experimentKey","experimentBucketVersion","getStickyBucketAttributeKey","attributeName","attributeValue","hashKey","fallbackValue","fallbackKey","existingAssignments","newAssignments","deriveStickyBucketIdentifierAttributes","data","experiments","keys","map","Array","getAllStickyBucketAssignmentDocs","stickyBucketService","getStickyBucketAttributes","getAllAssignments","stickyBucketIdentifierAttributes","decryptPayload","decryptionKey","subtle","encryptedFeatures","parse","console","error","encryptedExperiments","encryptedSavedGroups","getApiHosts","options","defaultHost","apiHost","streamingHost","apiRequestHeaders","apiHostRequestHeaders","streamingHostRequestHeaders"],"sources":["../../src/core.ts"],"sourcesContent":["import {\n  EvalContext,\n  FeatureDefinition,\n  FeatureResult,\n  Experiment,\n  FeatureResultSource,\n  Result,\n  Filter,\n  VariationRange,\n  VariationMeta,\n  StickyExperimentKey,\n  StickyAssignments,\n  StickyAttributeKey,\n  StickyAssignmentsDocument,\n  FeatureApiResponse,\n  Options,\n  ClientOptions,\n} from \"./types/growthbook\";\nimport { evalCondition } from \"./mongrule\";\nimport { ConditionInterface } from \"./types/mongrule\";\nimport {\n  chooseVariation,\n  decrypt,\n  getBucketRanges,\n  getQueryStringOverride,\n  getUrlRegExp,\n  hash,\n  inNamespace,\n  inRange,\n  isIncluded,\n  isURLTargeted,\n  toString,\n} from \"./util\";\nimport { StickyBucketService } from \"./sticky-bucket-service\";\n\nexport const EVENT_FEATURE_EVALUATED = \"Feature Evaluated\";\nexport const EVENT_EXPERIMENT_VIEWED = \"Experiment Viewed\";\n\nfunction getForcedFeatureValues(ctx: EvalContext) {\n  // Merge user and global values\n  const ret: typeof ctx.global.forcedFeatureValues = new Map();\n  if (ctx.global.forcedFeatureValues) {\n    ctx.global.forcedFeatureValues.forEach((v, k) => ret.set(k, v));\n  }\n  if (ctx.user.forcedFeatureValues) {\n    ctx.user.forcedFeatureValues.forEach((v, k) => ret.set(k, v));\n  }\n  return ret;\n}\n\nfunction getForcedVariations(ctx: EvalContext) {\n  // Merge user and global values\n  if (ctx.global.forcedVariations && ctx.user.forcedVariations) {\n    return { ...ctx.global.forcedVariations, ...ctx.user.forcedVariations };\n  } else if (ctx.global.forcedVariations) {\n    return ctx.global.forcedVariations;\n  } else if (ctx.user.forcedVariations) {\n    return ctx.user.forcedVariations;\n  } else {\n    return {};\n  }\n}\n\nasync function safeCall(fn: () => void | Promise<void>) {\n  try {\n    await fn();\n  } catch (e) {\n    // Do nothing\n  }\n}\n\nfunction onExperimentViewed(\n  ctx: EvalContext,\n  experiment: Experiment<unknown>,\n  result: Result<unknown>\n): Promise<void>[] {\n  // Make sure a tracking callback is only fired once per unique experiment\n  if (ctx.user.trackedExperiments) {\n    const k = getExperimentDedupeKey(experiment, result);\n    if (ctx.user.trackedExperiments.has(k)) {\n      return [];\n    }\n    ctx.user.trackedExperiments.add(k);\n  }\n\n  if (ctx.user.enableDevMode && ctx.user.devLogs) {\n    ctx.user.devLogs.push({\n      experiment,\n      result,\n      timestamp: Date.now().toString(),\n      logType: \"experiment\",\n    });\n  }\n\n  const calls: Promise<void>[] = [];\n\n  if (ctx.global.trackingCallback) {\n    const cb = ctx.global.trackingCallback;\n    calls.push(safeCall(() => cb(experiment, result, ctx.user)));\n  }\n  if (ctx.user.trackingCallback) {\n    const cb = ctx.user.trackingCallback;\n    calls.push(safeCall(() => cb(experiment, result)));\n  }\n  if (ctx.global.eventLogger) {\n    const cb = ctx.global.eventLogger;\n    calls.push(\n      safeCall(() =>\n        cb(\n          EVENT_EXPERIMENT_VIEWED,\n          {\n            experimentId: experiment.key,\n            variationId: result.key,\n            hashAttribute: result.hashAttribute,\n            hashValue: result.hashValue,\n          },\n          ctx.user\n        )\n      )\n    );\n  }\n  return calls;\n}\n\nfunction onFeatureUsage(\n  ctx: EvalContext,\n  key: string,\n  ret: FeatureResult<unknown>\n): void {\n  // Only track a feature once, unless the assigned value changed\n  if (ctx.user.trackedFeatureUsage) {\n    const stringifiedValue = JSON.stringify(ret.value);\n    if (ctx.user.trackedFeatureUsage[key] === stringifiedValue) return;\n    ctx.user.trackedFeatureUsage[key] = stringifiedValue;\n\n    if (ctx.user.enableDevMode && ctx.user.devLogs) {\n      ctx.user.devLogs.push({\n        featureKey: key,\n        result: ret,\n        timestamp: Date.now().toString(),\n        logType: \"feature\",\n      });\n    }\n  }\n\n  if (ctx.global.onFeatureUsage) {\n    const cb = ctx.global.onFeatureUsage;\n    safeCall(() => cb(key, ret, ctx.user));\n  }\n  if (ctx.user.onFeatureUsage) {\n    const cb = ctx.user.onFeatureUsage;\n    safeCall(() => cb(key, ret));\n  }\n  if (ctx.global.eventLogger) {\n    const cb = ctx.global.eventLogger;\n    safeCall(() =>\n      cb(\n        EVENT_FEATURE_EVALUATED,\n        {\n          feature: key,\n          source: ret.source,\n          value: ret.value,\n          ruleId: ret.source === \"defaultValue\" ? \"$default\" : ret.ruleId || \"\",\n          variationId: ret.experimentResult ? ret.experimentResult.key : \"\",\n        },\n        ctx.user\n      )\n    );\n  }\n}\n\nexport function evalFeature<V = unknown>(\n  id: string,\n  ctx: EvalContext\n): FeatureResult<V | null> {\n  if (ctx.stack.evaluatedFeatures.has(id)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\n        `evalFeature: circular dependency detected: ${ctx.stack.id} -> ${id}`,\n        {\n          from: ctx.stack.id,\n          to: id,\n        }\n      );\n    return getFeatureResult(ctx, id, null, \"cyclicPrerequisite\");\n  }\n  ctx.stack.evaluatedFeatures.add(id);\n  ctx.stack.id = id;\n\n  // Global override\n  const forcedValues = getForcedFeatureValues(ctx);\n  if (forcedValues.has(id)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Global override\", {\n        id,\n        value: forcedValues.get(id),\n      });\n    return getFeatureResult(ctx, id, forcedValues.get(id), \"override\");\n  }\n\n  // Unknown feature id\n  if (!ctx.global.features || !ctx.global.features[id]) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Unknown feature\", { id });\n    return getFeatureResult(ctx, id, null, \"unknownFeature\");\n  }\n\n  // Get the feature\n  const feature: FeatureDefinition<V> = ctx.global.features[id];\n\n  // Loop through the rules\n  if (feature.rules) {\n    const evaluatedFeatures = new Set(ctx.stack.evaluatedFeatures);\n    rules: for (const rule of feature.rules) {\n      // If there are prerequisite flag(s), evaluate them\n      if (rule.parentConditions) {\n        for (const parentCondition of rule.parentConditions) {\n          ctx.stack.evaluatedFeatures = new Set(evaluatedFeatures);\n          const parentResult = evalFeature(parentCondition.id, ctx);\n          // break out for cyclic prerequisites\n          if (parentResult.source === \"cyclicPrerequisite\") {\n            return getFeatureResult(ctx, id, null, \"cyclicPrerequisite\");\n          }\n\n          const evalObj = { value: parentResult.value };\n          const evaled = evalCondition(\n            evalObj,\n            parentCondition.condition || {}\n          );\n          if (!evaled) {\n            // blocking prerequisite eval failed: feature evaluation fails\n            if (parentCondition.gate) {\n              process.env.NODE_ENV !== \"production\" &&\n                ctx.global.log(\"Feature blocked by prerequisite\", { id, rule });\n              return getFeatureResult(ctx, id, null, \"prerequisite\");\n            }\n            // non-blocking prerequisite eval failed: break out of parentConditions loop, jump to the next rule\n            process.env.NODE_ENV !== \"production\" &&\n              ctx.global.log(\n                \"Skip rule because prerequisite evaluation fails\",\n                {\n                  id,\n                  rule,\n                }\n              );\n            continue rules;\n          }\n        }\n      }\n\n      // If there are filters for who is included (e.g. namespaces)\n      if (rule.filters && isFilteredOut(rule.filters, ctx)) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip rule because of filters\", {\n            id,\n            rule,\n          });\n        continue;\n      }\n\n      // Feature value is being forced\n      if (\"force\" in rule) {\n        // If it's a conditional rule, skip if the condition doesn't pass\n        if (rule.condition && !conditionPasses(rule.condition, ctx)) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip rule because of condition ff\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        // If this is a percentage rollout, skip if not included\n        if (\n          !isIncludedInRollout(\n            ctx,\n            rule.seed || id,\n            rule.hashAttribute,\n            ctx.user.saveStickyBucketAssignmentDoc &&\n              !rule.disableStickyBucketing\n              ? rule.fallbackAttribute\n              : undefined,\n            rule.range,\n            rule.coverage,\n            rule.hashVersion\n          )\n        ) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip rule because user not included in rollout\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Force value from rule\", {\n            id,\n            rule,\n          });\n\n        // If this was a remotely evaluated experiment, fire the tracking callbacks\n        if (rule.tracks) {\n          rule.tracks.forEach((t) => {\n            const calls = onExperimentViewed(ctx, t.experiment, t.result);\n            if (!calls.length && ctx.global.saveDeferredTrack) {\n              ctx.global.saveDeferredTrack({\n                experiment: t.experiment,\n                result: t.result,\n              });\n            }\n          });\n        }\n\n        return getFeatureResult(ctx, id, rule.force as V, \"force\", rule.id);\n      }\n      if (!rule.variations) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip invalid rule\", {\n            id,\n            rule,\n          });\n\n        continue;\n      }\n\n      // For experiment rules, run an experiment\n      const exp: Experiment<V> = {\n        variations: rule.variations as [V, V, ...V[]],\n        key: rule.key || id,\n      };\n      if (\"coverage\" in rule) exp.coverage = rule.coverage;\n      if (rule.weights) exp.weights = rule.weights;\n      if (rule.hashAttribute) exp.hashAttribute = rule.hashAttribute;\n      if (rule.fallbackAttribute)\n        exp.fallbackAttribute = rule.fallbackAttribute;\n      if (rule.disableStickyBucketing)\n        exp.disableStickyBucketing = rule.disableStickyBucketing;\n      if (rule.bucketVersion !== undefined)\n        exp.bucketVersion = rule.bucketVersion;\n      if (rule.minBucketVersion !== undefined)\n        exp.minBucketVersion = rule.minBucketVersion;\n      if (rule.namespace) exp.namespace = rule.namespace;\n      if (rule.meta) exp.meta = rule.meta;\n      if (rule.ranges) exp.ranges = rule.ranges;\n      if (rule.name) exp.name = rule.name;\n      if (rule.phase) exp.phase = rule.phase;\n      if (rule.seed) exp.seed = rule.seed;\n      if (rule.hashVersion) exp.hashVersion = rule.hashVersion;\n      if (rule.filters) exp.filters = rule.filters;\n      if (rule.condition) exp.condition = rule.condition;\n\n      // Only return a value if the user is part of the experiment\n      const { result } = runExperiment(exp, id, ctx);\n      ctx.global.onExperimentEval && ctx.global.onExperimentEval(exp, result);\n      if (result.inExperiment && !result.passthrough) {\n        return getFeatureResult(\n          ctx,\n          id,\n          result.value,\n          \"experiment\",\n          rule.id,\n          exp,\n          result\n        );\n      }\n    }\n  }\n\n  process.env.NODE_ENV !== \"production\" &&\n    ctx.global.log(\"Use default value\", {\n      id,\n      value: feature.defaultValue,\n    });\n\n  // Fall back to using the default value\n  return getFeatureResult(\n    ctx,\n    id,\n    feature.defaultValue === undefined ? null : feature.defaultValue,\n    \"defaultValue\"\n  );\n}\n\nexport function runExperiment<T>(\n  experiment: Experiment<T>,\n  featureId: string | null,\n  ctx: EvalContext\n): {\n  result: Result<T>;\n  trackingCall?: Promise<void>;\n} {\n  const key = experiment.key;\n  const numVariations = experiment.variations.length;\n\n  // 1. If experiment has less than 2 variations, return immediately\n  if (numVariations < 2) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Invalid experiment\", { id: key });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 2. If the context is disabled, return immediately\n  if (ctx.global.enabled === false || ctx.user.enabled === false) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Context disabled\", { id: key });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 2.5. Merge in experiment overrides from the context\n  experiment = mergeOverrides(experiment, ctx);\n\n  // 2.6 New, more powerful URL targeting\n  if (\n    experiment.urlPatterns &&\n    !isURLTargeted(ctx.user.url || \"\", experiment.urlPatterns)\n  ) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of url targeting\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 3. If a variation is forced from a querystring, return the forced variation\n  const qsOverride = getQueryStringOverride(\n    key,\n    ctx.user.url || \"\",\n    numVariations\n  );\n  if (qsOverride !== null) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force via querystring\", {\n        id: key,\n        variation: qsOverride,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        qsOverride,\n        false,\n        featureId\n      ),\n    };\n  }\n\n  // 4. If a variation is forced in the context, return the forced variation\n  const forcedVariations = getForcedVariations(ctx);\n  if (key in forcedVariations) {\n    const variation = forcedVariations[key];\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force via dev tools\", {\n        id: key,\n        variation,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, variation, false, featureId),\n    };\n  }\n\n  // 5. Exclude if a draft experiment or not active\n  if (experiment.status === \"draft\" || experiment.active === false) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because inactive\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 6. Get the hash attribute and return if empty\n  const { hashAttribute, hashValue } = getHashAttribute(\n    ctx,\n    experiment.hashAttribute,\n    ctx.user.saveStickyBucketAssignmentDoc && !experiment.disableStickyBucketing\n      ? experiment.fallbackAttribute\n      : undefined\n  );\n  if (!hashValue) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because missing hashAttribute\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  let assigned = -1;\n\n  let foundStickyBucket = false;\n  let stickyBucketVersionIsBlocked = false;\n  if (\n    ctx.user.saveStickyBucketAssignmentDoc &&\n    !experiment.disableStickyBucketing\n  ) {\n    const { variation, versionIsBlocked } = getStickyBucketVariation({\n      ctx,\n      expKey: experiment.key,\n      expBucketVersion: experiment.bucketVersion,\n      expHashAttribute: experiment.hashAttribute,\n      expFallbackAttribute: experiment.fallbackAttribute,\n      expMinBucketVersion: experiment.minBucketVersion,\n      expMeta: experiment.meta,\n    });\n    foundStickyBucket = variation >= 0;\n    assigned = variation;\n    stickyBucketVersionIsBlocked = !!versionIsBlocked;\n  }\n\n  // Some checks are not needed if we already have a sticky bucket\n  if (!foundStickyBucket) {\n    // 7. Exclude if user is filtered out (used to be called \"namespace\")\n    if (experiment.filters) {\n      if (isFilteredOut(experiment.filters, ctx)) {\n        process.env.NODE_ENV !== \"production\" &&\n          ctx.global.log(\"Skip because of filters\", {\n            id: key,\n          });\n        return {\n          result: getExperimentResult(ctx, experiment, -1, false, featureId),\n        };\n      }\n    } else if (\n      experiment.namespace &&\n      !inNamespace(hashValue, experiment.namespace)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of namespace\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 7.5. Exclude if experiment.include returns false or throws\n    if (experiment.include && !isIncluded(experiment.include)) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of include function\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 8. Exclude if condition is false\n    if (experiment.condition && !conditionPasses(experiment.condition, ctx)) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of condition exp\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n\n    // 8.05. Exclude if prerequisites are not met\n    if (experiment.parentConditions) {\n      const evaluatedFeatures = new Set(ctx.stack.evaluatedFeatures);\n      for (const parentCondition of experiment.parentConditions) {\n        ctx.stack.evaluatedFeatures = new Set(evaluatedFeatures);\n        const parentResult = evalFeature(parentCondition.id, ctx);\n        // break out for cyclic prerequisites\n        if (parentResult.source === \"cyclicPrerequisite\") {\n          return {\n            result: getExperimentResult(ctx, experiment, -1, false, featureId),\n          };\n        }\n\n        const evalObj = { value: parentResult.value };\n        if (!evalCondition(evalObj, parentCondition.condition || {})) {\n          process.env.NODE_ENV !== \"production\" &&\n            ctx.global.log(\"Skip because prerequisite evaluation fails\", {\n              id: key,\n            });\n          return {\n            result: getExperimentResult(ctx, experiment, -1, false, featureId),\n          };\n        }\n      }\n    }\n\n    // 8.1. Exclude if user is not in a required group\n    if (\n      experiment.groups &&\n      !hasGroupOverlap(experiment.groups as string[], ctx)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        ctx.global.log(\"Skip because of groups\", {\n          id: key,\n        });\n      return {\n        result: getExperimentResult(ctx, experiment, -1, false, featureId),\n      };\n    }\n  }\n\n  // 8.2. Old style URL targeting\n  if (experiment.url && !urlIsValid(experiment.url as RegExp, ctx)) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of url\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 9. Get the variation from the sticky bucket or get bucket ranges and choose variation\n  const n = hash(\n    experiment.seed || key,\n    hashValue,\n    experiment.hashVersion || 1\n  );\n  if (n === null) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of invalid hash version\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  if (!foundStickyBucket) {\n    const ranges =\n      experiment.ranges ||\n      getBucketRanges(\n        numVariations,\n        experiment.coverage === undefined ? 1 : experiment.coverage,\n        experiment.weights\n      );\n    assigned = chooseVariation(n, ranges);\n  }\n\n  // 9.5 Unenroll if any prior sticky buckets are blocked by version\n  if (stickyBucketVersionIsBlocked) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because sticky bucket version is blocked\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        -1,\n        false,\n        featureId,\n        undefined,\n        true\n      ),\n    };\n  }\n\n  // 10. Return if not in experiment\n  if (assigned < 0) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because of coverage\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 11. Experiment has a forced variation\n  if (\"force\" in experiment) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Force variation\", {\n        id: key,\n        variation: experiment.force,\n      });\n    return {\n      result: getExperimentResult(\n        ctx,\n        experiment,\n        experiment.force === undefined ? -1 : experiment.force,\n        false,\n        featureId\n      ),\n    };\n  }\n\n  // 12. Exclude if in QA mode\n  if (ctx.global.qaMode || ctx.user.qaMode) {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because QA mode\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 12.5. Exclude if experiment is stopped\n  if (experiment.status === \"stopped\") {\n    process.env.NODE_ENV !== \"production\" &&\n      ctx.global.log(\"Skip because stopped\", {\n        id: key,\n      });\n    return {\n      result: getExperimentResult(ctx, experiment, -1, false, featureId),\n    };\n  }\n\n  // 13. Build the result object\n  const result = getExperimentResult(\n    ctx,\n    experiment,\n    assigned,\n    true,\n    featureId,\n    n,\n    foundStickyBucket\n  );\n\n  // 13.5. Persist sticky bucket\n  if (\n    ctx.user.saveStickyBucketAssignmentDoc &&\n    !experiment.disableStickyBucketing\n  ) {\n    const { changed, key: attrKey, doc } = generateStickyBucketAssignmentDoc(\n      ctx,\n      hashAttribute,\n      toString(hashValue),\n      {\n        [getStickyBucketExperimentKey(\n          experiment.key,\n          experiment.bucketVersion\n        )]: result.key,\n      }\n    );\n    if (changed) {\n      // update local docs\n      ctx.user.stickyBucketAssignmentDocs =\n        ctx.user.stickyBucketAssignmentDocs || {};\n      ctx.user.stickyBucketAssignmentDocs[attrKey] = doc;\n      // save doc\n      ctx.user.saveStickyBucketAssignmentDoc(doc);\n    }\n  }\n\n  // 14. Fire the tracking callback(s)\n  // Store the promise in case we're awaiting it (ex: browser url redirects)\n  const trackingCalls = onExperimentViewed(ctx, experiment, result);\n  if (trackingCalls.length === 0 && ctx.global.saveDeferredTrack) {\n    ctx.global.saveDeferredTrack({\n      experiment,\n      result,\n    });\n  }\n  const trackingCall = !trackingCalls.length\n    ? undefined\n    : trackingCalls.length === 1\n    ? trackingCalls[0]\n    : Promise.all(trackingCalls).then(() => {});\n\n  // 14.1 Keep track of completed changeIds\n  \"changeId\" in experiment &&\n    experiment.changeId &&\n    ctx.global.recordChangeId &&\n    ctx.global.recordChangeId(experiment.changeId as string);\n\n  // 15. Return the result\n  process.env.NODE_ENV !== \"production\" &&\n    ctx.global.log(\"In experiment\", {\n      id: key,\n      variation: result.variationId,\n    });\n  return { result, trackingCall };\n}\n\nfunction getFeatureResult<T>(\n  ctx: EvalContext,\n  key: string,\n  value: T,\n  source: FeatureResultSource,\n  ruleId?: string,\n  experiment?: Experiment<T>,\n  result?: Result<T>\n): FeatureResult<T> {\n  const ret: FeatureResult = {\n    value,\n    on: !!value,\n    off: !value,\n    source,\n    ruleId: ruleId || \"\",\n  };\n  if (experiment) ret.experiment = experiment;\n  if (result) ret.experimentResult = result;\n\n  // Track the usage of this feature in real-time\n  if (source !== \"override\") {\n    onFeatureUsage(ctx, key, ret);\n  }\n\n  return ret;\n}\n\nfunction getAttributes(ctx: EvalContext) {\n  return {\n    ...ctx.user.attributes,\n    ...ctx.user.attributeOverrides,\n  };\n}\n\nfunction conditionPasses(\n  condition: ConditionInterface,\n  ctx: EvalContext\n): boolean {\n  return evalCondition(\n    getAttributes(ctx),\n    condition,\n    ctx.global.savedGroups || {}\n  );\n}\n\nfunction isFilteredOut(filters: Filter[], ctx: EvalContext): boolean {\n  return filters.some((filter) => {\n    const { hashValue } = getHashAttribute(ctx, filter.attribute);\n    if (!hashValue) return true;\n    const n = hash(filter.seed, hashValue, filter.hashVersion || 2);\n    if (n === null) return true;\n    return !filter.ranges.some((r) => inRange(n, r));\n  });\n}\n\nfunction isIncludedInRollout(\n  ctx: EvalContext,\n  seed: string,\n  hashAttribute: string | undefined,\n  fallbackAttribute: string | undefined,\n  range: VariationRange | undefined,\n  coverage: number | undefined,\n  hashVersion: number | undefined\n): boolean {\n  if (!range && coverage === undefined) return true;\n\n  if (!range && coverage === 0) return false;\n\n  const { hashValue } = getHashAttribute(ctx, hashAttribute, fallbackAttribute);\n  if (!hashValue) {\n    return false;\n  }\n\n  const n = hash(seed, hashValue, hashVersion || 1);\n  if (n === null) return false;\n\n  return range\n    ? inRange(n, range)\n    : coverage !== undefined\n    ? n <= coverage\n    : true;\n}\n\nexport function getExperimentResult<T>(\n  ctx: EvalContext,\n  experiment: Experiment<T>,\n  variationIndex: number,\n  hashUsed: boolean,\n  featureId: string | null,\n  bucket?: number,\n  stickyBucketUsed?: boolean\n): Result<T> {\n  let inExperiment = true;\n  // If assigned variation is not valid, use the baseline and mark the user as not in the experiment\n  if (variationIndex < 0 || variationIndex >= experiment.variations.length) {\n    variationIndex = 0;\n    inExperiment = false;\n  }\n\n  const { hashAttribute, hashValue } = getHashAttribute(\n    ctx,\n    experiment.hashAttribute,\n    ctx.user.saveStickyBucketAssignmentDoc && !experiment.disableStickyBucketing\n      ? experiment.fallbackAttribute\n      : undefined\n  );\n\n  const meta: Partial<VariationMeta> = experiment.meta\n    ? experiment.meta[variationIndex]\n    : {};\n\n  const res: Result<T> = {\n    key: meta.key || \"\" + variationIndex,\n    featureId,\n    inExperiment,\n    hashUsed,\n    variationId: variationIndex,\n    value: experiment.variations[variationIndex],\n    hashAttribute,\n    hashValue,\n    stickyBucketUsed: !!stickyBucketUsed,\n  };\n\n  if (meta.name) res.name = meta.name;\n  if (bucket !== undefined) res.bucket = bucket;\n  if (meta.passthrough) res.passthrough = meta.passthrough;\n\n  return res;\n}\n\nfunction mergeOverrides<T>(\n  experiment: Experiment<T>,\n  ctx: EvalContext\n): Experiment<T> {\n  const key = experiment.key;\n  const o = ctx.global.overrides;\n  if (o && o[key]) {\n    experiment = Object.assign({}, experiment, o[key]);\n    if (typeof experiment.url === \"string\") {\n      experiment.url = getUrlRegExp(\n        // eslint-disable-next-line\n        experiment.url as any\n      );\n    }\n  }\n\n  return experiment;\n}\n\nexport function getHashAttribute(\n  ctx: EvalContext,\n  attr?: string,\n  fallback?: string\n) {\n  let hashAttribute = attr || \"id\";\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let hashValue: any = \"\";\n\n  const attributes = getAttributes(ctx);\n\n  if (attributes[hashAttribute]) {\n    hashValue = attributes[hashAttribute];\n  }\n\n  // if no match, try fallback\n  if (!hashValue && fallback) {\n    if (attributes[fallback]) {\n      hashValue = attributes[fallback];\n    }\n    if (hashValue) {\n      hashAttribute = fallback;\n    }\n  }\n\n  return { hashAttribute, hashValue };\n}\n\nfunction urlIsValid(urlRegex: RegExp, ctx: EvalContext): boolean {\n  const url = ctx.user.url;\n  if (!url) return false;\n\n  const pathOnly = url.replace(/^https?:\\/\\//, \"\").replace(/^[^/]*\\//, \"/\");\n\n  if (urlRegex.test(url)) return true;\n  if (urlRegex.test(pathOnly)) return true;\n  return false;\n}\n\nfunction hasGroupOverlap(expGroups: string[], ctx: EvalContext): boolean {\n  const groups = ctx.global.groups || {};\n  for (let i = 0; i < expGroups.length; i++) {\n    if (groups[expGroups[i]]) return true;\n  }\n  return false;\n}\n\nfunction getStickyBucketVariation({\n  ctx,\n  expKey,\n  expBucketVersion,\n  expHashAttribute,\n  expFallbackAttribute,\n  expMinBucketVersion,\n  expMeta,\n}: {\n  ctx: EvalContext;\n  expKey: string;\n  expBucketVersion?: number;\n  expHashAttribute?: string;\n  expFallbackAttribute?: string;\n  expMinBucketVersion?: number;\n  expMeta?: VariationMeta[];\n}): {\n  variation: number;\n  versionIsBlocked?: boolean;\n} {\n  expBucketVersion = expBucketVersion || 0;\n  expMinBucketVersion = expMinBucketVersion || 0;\n  expHashAttribute = expHashAttribute || \"id\";\n  expMeta = expMeta || [];\n  const id = getStickyBucketExperimentKey(expKey, expBucketVersion);\n  const assignments = getStickyBucketAssignments(\n    ctx,\n    expHashAttribute,\n    expFallbackAttribute\n  );\n\n  // users with any blocked bucket version (0 to minExperimentBucketVersion) are excluded from the test\n  if (expMinBucketVersion > 0) {\n    for (let i = 0; i <= expMinBucketVersion; i++) {\n      const blockedKey = getStickyBucketExperimentKey(expKey, i);\n      if (assignments[blockedKey] !== undefined) {\n        return {\n          variation: -1,\n          versionIsBlocked: true,\n        };\n      }\n    }\n  }\n  const variationKey = assignments[id];\n  if (variationKey === undefined)\n    // no assignment found\n    return { variation: -1 };\n  const variation = expMeta.findIndex((m) => m.key === variationKey);\n  if (variation < 0)\n    // invalid assignment, treat as \"no assignment found\"\n    return { variation: -1 };\n\n  return { variation };\n}\n\nfunction getStickyBucketExperimentKey(\n  experimentKey: string,\n  experimentBucketVersion?: number\n): StickyExperimentKey {\n  experimentBucketVersion = experimentBucketVersion || 0;\n  return `${experimentKey}__${experimentBucketVersion}`;\n}\n\nexport function getStickyBucketAttributeKey(\n  attributeName: string,\n  attributeValue: string\n): StickyAttributeKey {\n  return `${attributeName}||${attributeValue}`;\n}\n\nfunction getStickyBucketAssignments(\n  ctx: EvalContext,\n  expHashAttribute: string,\n  expFallbackAttribute?: string\n): StickyAssignments {\n  if (!ctx.user.stickyBucketAssignmentDocs) return {};\n  const { hashAttribute, hashValue } = getHashAttribute(ctx, expHashAttribute);\n  const hashKey = getStickyBucketAttributeKey(\n    hashAttribute,\n    toString(hashValue)\n  );\n\n  const {\n    hashAttribute: fallbackAttribute,\n    hashValue: fallbackValue,\n  } = getHashAttribute(ctx, expFallbackAttribute);\n  const fallbackKey = fallbackValue\n    ? getStickyBucketAttributeKey(fallbackAttribute, toString(fallbackValue))\n    : null;\n\n  const assignments: StickyAssignments = {};\n  if (fallbackKey && ctx.user.stickyBucketAssignmentDocs[fallbackKey]) {\n    Object.assign(\n      assignments,\n      ctx.user.stickyBucketAssignmentDocs[fallbackKey].assignments || {}\n    );\n  }\n  if (ctx.user.stickyBucketAssignmentDocs[hashKey]) {\n    Object.assign(\n      assignments,\n      ctx.user.stickyBucketAssignmentDocs[hashKey].assignments || {}\n    );\n  }\n  return assignments;\n}\n\nfunction generateStickyBucketAssignmentDoc(\n  ctx: EvalContext,\n  attributeName: string,\n  attributeValue: string,\n  assignments: StickyAssignments\n): {\n  key: StickyAttributeKey;\n  doc: StickyAssignmentsDocument;\n  changed: boolean;\n} {\n  const key = getStickyBucketAttributeKey(attributeName, attributeValue);\n  const existingAssignments =\n    ctx.user.stickyBucketAssignmentDocs &&\n    ctx.user.stickyBucketAssignmentDocs[key]\n      ? ctx.user.stickyBucketAssignmentDocs[key].assignments || {}\n      : {};\n  const newAssignments = { ...existingAssignments, ...assignments };\n  const changed =\n    JSON.stringify(existingAssignments) !== JSON.stringify(newAssignments);\n\n  return {\n    key,\n    doc: {\n      attributeName,\n      attributeValue,\n      assignments: newAssignments,\n    },\n    changed,\n  };\n}\n\nfunction deriveStickyBucketIdentifierAttributes(\n  ctx: EvalContext,\n  data?: FeatureApiResponse\n) {\n  const attributes = new Set<string>();\n  const features =\n    data && data.features ? data.features : ctx.global.features || {};\n  const experiments =\n    data && data.experiments ? data.experiments : ctx.global.experiments || [];\n  Object.keys(features).forEach((id) => {\n    const feature = features[id];\n    if (feature.rules) {\n      for (const rule of feature.rules) {\n        if (rule.variations) {\n          attributes.add(rule.hashAttribute || \"id\");\n          if (rule.fallbackAttribute) {\n            attributes.add(rule.fallbackAttribute);\n          }\n        }\n      }\n    }\n  });\n  experiments.map((experiment) => {\n    attributes.add(experiment.hashAttribute || \"id\");\n    if (experiment.fallbackAttribute) {\n      attributes.add(experiment.fallbackAttribute);\n    }\n  });\n  return Array.from(attributes);\n}\n\nexport async function getAllStickyBucketAssignmentDocs(\n  ctx: EvalContext,\n  stickyBucketService: StickyBucketService,\n  data?: FeatureApiResponse\n) {\n  const attributes = getStickyBucketAttributes(ctx, data);\n  return stickyBucketService.getAllAssignments(attributes);\n}\n\nexport function getStickyBucketAttributes(\n  ctx: EvalContext,\n  data?: FeatureApiResponse\n): Record<string, string> {\n  const attributes: Record<string, string> = {};\n  const stickyBucketIdentifierAttributes = deriveStickyBucketIdentifierAttributes(\n    ctx,\n    data\n  );\n  stickyBucketIdentifierAttributes.forEach((attr) => {\n    const { hashValue } = getHashAttribute(ctx, attr);\n    attributes[attr] = toString(hashValue);\n  });\n  return attributes;\n}\n\nexport async function decryptPayload(\n  data: FeatureApiResponse,\n  decryptionKey: string | undefined,\n  subtle?: SubtleCrypto\n): Promise<FeatureApiResponse> {\n  data = { ...data };\n  if (data.encryptedFeatures) {\n    try {\n      data.features = JSON.parse(\n        await decrypt(data.encryptedFeatures, decryptionKey, subtle)\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedFeatures;\n  }\n  if (data.encryptedExperiments) {\n    try {\n      data.experiments = JSON.parse(\n        await decrypt(data.encryptedExperiments, decryptionKey, subtle)\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedExperiments;\n  }\n  if (data.encryptedSavedGroups) {\n    try {\n      data.savedGroups = JSON.parse(\n        await decrypt(data.encryptedSavedGroups, decryptionKey, subtle)\n      );\n    } catch (e) {\n      console.error(e);\n    }\n    delete data.encryptedSavedGroups;\n  }\n  return data;\n}\n\nexport function getApiHosts(\n  options: Options | ClientOptions\n): {\n  apiHost: string;\n  streamingHost: string;\n  apiRequestHeaders?: Record<string, string>;\n  streamingHostRequestHeaders?: Record<string, string>;\n} {\n  const defaultHost = options.apiHost || \"https://cdn.growthbook.io\";\n  return {\n    apiHost: defaultHost.replace(/\\/*$/, \"\"),\n    streamingHost: (options.streamingHost || defaultHost).replace(/\\/*$/, \"\"),\n    apiRequestHeaders: options.apiHostRequestHeaders,\n    streamingHostRequestHeaders: options.streamingHostRequestHeaders,\n  };\n}\n\nexport function getExperimentDedupeKey(\n  experiment: Experiment<unknown>,\n  result: Result<unknown>\n) {\n  return (\n    result.hashAttribute +\n    result.hashValue +\n    experiment.key +\n    result.variationId\n  );\n}\n"],"mappings":"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"}